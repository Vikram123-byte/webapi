<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>DataCache API</title>
    <meta name="revision" content="$Id: Overview.html,v 1.6 2009-10-26 16:20:07 nmehta3 Exp $" />
    <link rel="stylesheet" href="DataCache.css" type="text/css" />
    <script src="section-links.js" type="application/ecmascript"></script>
    <script src="dfn.js" type="application/ecmascript"></script>
    <!--[if IE]>
    <style type='text/css'>
      .ignore {
        -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
        filter: alpha(opacity=50);
      }
    </style>
    <![endif]-->
    <style type="text/css">
      table {
        border-collapse: collapse;
        border-style: hidden hidden none;
      }
      table thead {
        border-bottom: medium solid;
      }
      span {
        border-bottom: medium solid #9999CC
      }
      table td, table th {
        border-bottom: thin solid;
        border-left: medium solid;
        border-right: medium solid;
        padding: 0.2em;
        vertical-align: top;
      }
    </style>

    
  <link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-WD" type="text/css" /></head>

  <body>
    <div class="head"><div><a href="http://www.w3.org/"><img src="http://www.w3.org/Icons/w3c_home" width="72" height="48" alt="W3C" /></a></div><h1>DataCache API</h1><h2>W3C Working Draft <em>27 October 2009</em></h2><dl><dt>This Version:</dt><dd><a href="http://www.w3.org/TR/2009/WD-DataCache-20091027/">http://www.w3.org/TR/2009/WD-DataCache-20091027/</a></dd><dt>Latest Version:</dt><dd><a href="http://www.w3.org/TR/DataCache/">http://www.w3.org/TR/DataCache/</a></dd><dt>Editor:</dt><dd><a href="http://o-micron.blogspot.com/">Nikunj R. Mehta</a>, Oracle Corp &lt;nikunj.mehta@oracle.com&gt;</dd></dl><p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy; 2009 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>&reg;</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.org/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p></div><hr />

    <div class="section">
      <h2 id="abstract">Abstract</h2>
      <p>
        This document defines APIs for off-line serving of requests to HTTP resources using
        static and dynamic responses.
      </p>

      
    </div>

    <div class="section">
      <h2 id="status">Status of this Document</h2>
      <p><em>
        This section describes the status of this document at the time of
        its publication.  Other documents may supersede this document. A list
        of current W3C publications and the latest revision of this technical
        report can be found in the <a href="http://www.w3.org/TR/">W3C technical
          reports index</a> at http://www.w3.org/TR/.
      </em></p><p>
        This document is the 27 October 2009 <b>First Public Working Draft</b> of the
        <cite>DataCache API</cite> specification.
      
      Please send comments about this document to
      <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>
      (<a href="http://lists.w3.org/Archives/Public/public-webapps/">archived</a>)
      with “[DataCache]” at the start of the subject line.
    </p>
      <p>
        The latest stable version of the editor's draft of this specification is
        always available on the W3C CVS server. Change tracking for this document is
        available at the following location:
      </p>
      <ul>
        <li>
          CVS log: <a href="http://dev.w3.org/cvsweb/2006/webapi/DataCache/Overview.xml">http://dev.w3.org/cvsweb/2006/webapi/DataCache/Overview.xml</a>
        </li>
      </ul>
      <p>
      If you wish to make comments regarding this document, please send
  them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>
  (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>,
  <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>)
  or submit them using <a href="http://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG&amp;component=DataCache">our
  public bug database</a>.
      </p>
      <p>
        The 
        <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>, is the W3C Working Group responsible for this specification's progress along the W3C Recommendation track.
      </p>
      <p>
          Publication as a Working Draft does not imply endorsement by the
          W3C Membership.  This is a draft document and may be updated, replaced
          or obsoleted by other documents at any time. It is inappropriate to cite
          this document as other than work in progress.
        </p><p>
      This document was produced by a group operating under the
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February
        2004 W3C Patent Policy</a>. W3C maintains a
      <a href="http://www.w3.org/2004/01/pp-impl/42538/status">public list of
        any patent disclosures</a> made in connection with the deliverables of
      the group; that page also includes instructions for disclosing a patent.
      An individual who has actual knowledge of a patent which the individual
      believes contains
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
        Claim(s)</a> must disclose the information in accordance with
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
        6 of the W3C Patent Policy</a>.
    </p>
    </div>

    <div id="toc">
      <h2>Table of Contents</h2>
      <div class="toc"><ul><li><a href="#introduction">1. Introduction</a></li><li><a href="#conformance">2. Conformance Requirements</a><ul><li><a href="#dependencies">2.1. Dependencies</a></li></ul></li><li><a href="#terminology">3. Terminology</a></li><li><a href="#cache">4. Programmable HTTP Processing</a><ul><li><a href="#datacache-intro">4.1. Introduction</a><ul><li><a href="#examples">4.1.1. Examples</a></li><li><a href="#cache-events">4.1.2. Event summary</a></li></ul></li><li><a href="#http-cache">4.2. Data Caches</a><ul><li><a href="#opening-cache">4.2.1. Opening a cache</a></li><li><a href="#modifying-cache">4.2.2. Constructing and modifying data caches</a><ul><li><a href="#starting-a-transaction">4.2.2.1. Starting a transaction</a></li><li><a href="#adding-capture-transaction">4.2.2.2. Capturing resources</a></li><li><a href="#release-resource">4.2.2.3. Releasing resources</a></li><li><a href="#complete-transaction">4.2.2.4. Completing a transaction</a></li><li><a href="#abort-transaction">4.2.2.5. Aborting a transaction</a></li><li><a href="#activating-updates">4.2.2.6. Activating updates</a></li></ul></li><li><a href="#expiring-application-caches">4.2.3. Expiring data caches</a></li><li><a href="#datacache-api">4.2.4. The API</a></li><li><a href="#async-datacache-interface">4.2.5. Asynchronous Data Cache API</a></li><li><a href="#sync-datacache-interface">4.2.6. Synchronous Data Cache API</a></li><li><a href="#transaction-interface">4.2.7. Transaction API</a></li><li><a href="#events-and-error">4.2.8. The CacheEvent</a></li></ul></li><li><a href="#local-server">4.3. Embedded Local Server</a><ul><li><a href="#request-interface">4.3.1. Local Server API</a></li><li><a href="#networking-model-changes">4.3.2. Changes to the networking model</a></li></ul></li></ul></li><li><a href="#security">5. Security Considerations</a></li></ul><ul><li><a href="#references">A. References</a><ul><li><a href="#normative-references">A.1. Normative references</a></li><li><a href="#informative-references">A.2. Informative references</a></li></ul></li><li><a href="#acknowledgements">B. Acknowledgements</a></li></ul></div>
    </div>

    <div id="sections">
      <div id="introduction" class="section">
        <h2>1. Introduction</h2>

        <p class="norm">This section is informative.</p>

        <p>
          Web applications often encounter seemingly random disconnections
          or network slowdowns, which deteriorates application responsiveness
          and availability, and, therefore, user experience. Working around
          network issues entails specially written applications, synchronization 
          programs, and data protocols for specific platforms.
        </p>
        
        <p>
          The standard HTTP caches built in to existing user agents 
          are under no obligation to locally store a cacheable resource 
          and do not provide any guarantees about off-line serving of 
          HTTP resources. An application cache <cite>[<a href="#ref-HTML5">HTML5</a>]</cite>
          can hold static representations of a set of pre-defined resources
          that can be served locally. However, applications cannot
          alter this set of resources programmatically. Moreover, an
          application cache cannot satisfy requests other than 
          <code>GET</code> and <code>HEAD</code>.
        </p>
      
        <p>
          To address this limitation, this specification introduces data caches. 
          Instead of a static manifest resource listing the resources
          to be cached, a data cache can be modified programmatically.
          Web applications can add or remove resources in a data cache
          which can then be statically served by the user agent when that resource 
          is requested. This specification also provides embedded local servers
          to dynamically serve off-line representations of resources such as
          in response to unsafe HTTP methods, e.g., <code>POST</code>. 
        </p>
        
        <p>
          Using data caches and embedded local servers, applications can obtain 
          locally cached or served data and complete requests to  
          resources whether or not the requests can be serviced immediately 
          by a remote server. Applications can replay locally satisfied requests
          to the server thus enabling responsive and robust Web 
          applications in the presence of low connectivity conditions.
        </p>
        
        <p>
          This specification does not introduce a new programming model
          for Web applications as data caches and embedded local servers are
          transparently pressed into action by the user agent, depending
          on system conditions. This means that existing applications
          can be used unchanged in environments that are not affected
          by network unreliability. Applications can be altered to use APIs
          specified in this document, only if they require improved
          responsiveness. Such applications can seamlessly switch
          between on-line and off-line operation without needing explicit
          user action.
        </p>
      </div>

      <div id="conformance" class="section">
        <h2>2. Conformance Requirements</h2>

        <p>
          Everything in this specification is normative except for diagrams,
          examples, notes and sections marked as being informative.
        </p>
        <p>
          The keywords “<span class="rfc2119">MUST</span>”,
          “<span class="rfc2119">MUST NOT</span>”,
          “<span class="rfc2119">REQUIRED</span>”,
          “<span class="rfc2119">SHALL</span>”,
          “<span class="rfc2119">SHALL NOT</span>”,
          “<span class="rfc2119">RECOMMENDED</span>”,
          “<span class="rfc2119">MAY</span>” and
          “<span class="rfc2119">OPTIONAL</span>” in this document are to be
          interpreted as described in
          <cite><a href="http://www.ietf.org/rfc/rfc2119">Key words for use in RFCs to
              Indicate Requirement Levels</a></cite>
          <a href="#ref-RFC2119">[RFC2119]</a>.
        </p>
        <p>
          This specification defines one class of products:
        </p>
        <dl>
          <dt><dfn id="dfn-conforming-user-agent">Conforming user agent</dfn></dt>
          <dd>
            <p>
              A user agent must behave as described in this specification
              in order to be considered conformant.
            </p>
            
            <p>
              User agents may implement algorithms given in this
              specification in any way desired, so long as the end result is
              indistinguishable from the result that would be obtained by the
              specification's algorithms.
            </p>
            
            <p>
              A conforming DataCache user agent must also be a
              <em>conforming implementation</em> of the IDL fragments
              of this specification, as described in the
              “Web IDL” specification. <cite><a href="#ref-WebIDL">[WEBIDL]</a></cite>
            </p>
            
            <div class="note"><div class="noteHeader">Note</div>
              This specification uses both the terms "conforming user agent(s)" 
              and "user agent(s)" to refer to this product class.
            </div>
          </dd>
        </dl>
        
        <div id="dependencies" class="section">
          <h3>2.1. Dependencies</h3>
          
          <p>This specification relies on several underlying specifications.</p>
          <dl>
            <dt>HTTP</dt>
            <dd>
              <p>
                A <a href="#dfn-conforming-user-agent" title="conforming user agent">
                conforming user agent</a> must support some version of the
                HTTP protocol <cite><a href="#ref-RFC2616">[RFC2616]</a></cite>.
              </p>
            
              <p>
                In order to protect against attacks, the use of the following
                headers is prohibited using interfaces defined in this specification.
              </p>
            
              <ul>
               <li><code>Accept</code></li>
          
               <li><code>Accept-Charset</code></li>
          
               <li><code>Accept-Encoding</code></li>
          
               <li><code>Accept-Language</code></li>
          
               <li><code>Authorization</code></li>
          
               <li><code>Cache-Control</code></li>
          
               <li><code>Connection</code></li>
          
               <li><code>Content-Transfer-Encoding</code></li>
          
               <li><code>Cookie</code></li>
          
               <li><code>Date</code></li>
          
               <li><code>Expect</code></li>
          
               <li><code>Host</code></li>
          
               <li><code>Keep-Alive</code></li>
          
               <li><code>Origin</code></li>
          
               <li><code>Range</code></li>
          
               <li><code>Referer</code></li>
          
               <li><code>Set-Cookie</code></li>
          
               <li><code>TE</code></li>
          
               <li><code>Trailer</code></li>
          
               <li><code>Transfer-Encoding</code></li>
          
               <li><code>Upgrade</code></li>
          
               <li><code>User-Agent</code></li>
          
               <li><code>Via</code></li>
              </ul>
            </dd>
            <dt>HTTP State Management</dt>
            <dd>
              <p>
                A <a href="#dfn-conforming-user-agent" title="conforming user agent">
                conforming conforming user agent</a> must support storage and
                exchange of cookies as specified by HTTP State Management 
                <cite><a href="#ref-RFC2965">[RFC2965]</a></cite>.
              </p>
            </dd>
            <dt>DOM</dt>
            <dd>
              <p>
                A <a href="#dfn-conforming-user-agent" title="conforming user agent">
                conforming conforming user agent</a> must define the exception  
                codes defined in <cite><a href="#ref-DOM3Core">[DOM3Core]</a></cite> 
                and referenced in this specification.
              </p>
            </dd>
          </dl>
        </div>
      </div>
    
      <div id="terminology" class="section">
        <h2>3. Terminology</h2>

        <p>
          A resource is <dfn id="capture">captured</dfn> when it is added
          to a data cache.
        </p>
        
        <p>
          A resource is <dfn id="release">released</dfn> when it is removed
          from a data cache.
        </p>
        
        <p>
          A <dfn id="managed-resource">managed resource</dfn> is one whose URI is captured.
        </p>
        
        <p>
          A <dfn id="static">static representation</dfn> is one that is generated 
          directly by the user agent from its internal storage.
        </p>
        
        <p>
          A <dfn id="dynamic">dynamic representation</dfn> is one that is generated 
          programmatically by using application-supplied logic.
        </p>    
        
        <p>
          <dfn id="offline">Transparent off-line data access and manipulation</dfn>  
          means to locally generate a <a class="dfnref" href="#static">static</a> 
          or a <a class="dfnref" href="#dynamic">dynamic</a> 
          response for HTTP requests to captured  resources.
        </p>
        <p>
          <dfn id="private">Private</dfn> resources are those that require explicit authorization.
        </p>
      </div>
            
      <div id="cache" class="section">
        <h2>4. Programmable HTTP Processing</h2>

        <p>
          Programmable HTTP processing enables applications to identify
          <a class="dfnref" href="#managed-resource">managed resources</a> to a user
          agent and to produce <a class="dfnref" href="#static">static</a> 
          and <a class="dfnref" href="#dynamic">dynamic</a> 
          representations for responding to requests on these resources. 
        </p>
        
        <div id="datacache-intro" class="section">
          <h3>4.1. Introduction</h3>     
          <div class="norm">This section is non-normative.</div>

          <p>  
            A user agent processes network requests to 
            <a class="dfnref" href="#capture">managed resources</a>
            in one of three ways: 
          </p>
          <ol>
            <li>
              <dfn id="serve-policy">serve</dfn> - 
              respond with the <a class="dfnref" href="#static">static
              representation</a>  of the requested resource (for any
              safe HTTP methods) from a <a class="dfnref" href="#data-cache">data cache</a>. 
            </li>
            <li>
              <dfn id="intercept-policy">intercept</dfn> - 
              immediately invoke an <a class="dfnref" href="#embedded-local-server">
              embedded local server</a> to obtain a 
              <a class="dfnref" href="#dynamic">dynamic representation</a>
              (for any HTTP methods). 
            </li>
            <li>
              <dfn id="review-policy">review</dfn> - 
              relay the request to the server to obtain a 
              <a class="dfnref" href="#dynamic">dynamic representation</a> and 
              notify an <a class="dfnref" href="#embedded-local-server">
              embedded local server</a> when that representation is 
              available (only for unsafe HTTP methods). 
            </li>
          </ol>
          
          <p>
            The <a class="dfnref" href="#serve-policy">serve policy</a> applies  
            only to resources that do not require interception, whereas the 
            <a class="dfnref" href="#intercept-policy">intercept policy</a>
            can only be used for resources that require interception. Both policies
            improve availability and responsiveness. However, both may affect
            data freshness. The <a class="dfnref" href="#review-policy">review policy</a>
            can only be used when the user agent is able to communicate with
            the server. This policy improves data freshness at the cost of 
            reduced responsiveness. User agents may choose freely from among
            these options, e.g., using information about the system condition, 
            network state or battery power level, or a user preference.
          </p>
          
          <div class="section" id="examples">
            <h4>4.1.1. Examples</h4>

            <p>
              An application can use a <a class="dfnref" href="#data-cache">data
              cache</a> to <a class="dfnref" href="#capture">capture</a> the
              representation of a resource, i.e., cache an off-line 
              representation in the <a class="dfnref" href="#data-cache">data cache</a>.  
            </p>
            
            <div class="example"><div class="exampleHeader">Example</div>    
              <p>
                Using a data cache, an application captures a resource
                as part of an atomic cache transaction. Once the resource is captured successfully,
                the application places the captured representation in to service.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var uri = ...
var cache = window.openDataCache();
document.body.addEventListener('onready', function(event) {
  event.cache.swapCache();
  ... // take advantage of the new stuff in the cache
});

cache.transaction(function(txn) {
  txn.capture(uri);
  txn.finish();  
});</code></pre></div></div>
              <p>
                The user agent is able to then serve this off-line representation
                when an application issues a <code>GET</code> request for
                that resource either through page navigation or an XMLHttpRequest 
                <cite>[<a href="#ref-XMLHttpRequest">XMLHttpRequest</a>]</cite>. 
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var req = new XMLHttpRequest;
req.open('GET', uri);
...
req.send();</code></pre></div></div>
            </div>              
            
            <p>
              A dynamic representation is produced by using an
              <a href="#embedded-local-server" class="dfnref">embedded local server</a>
              in conjunction with the <a class="dfnref" href="#data-cache">data cache</a>. 
              An <a href="#interceptor" class="dfnref">interceptor</a>
              processes an HTTP request locally in an
              <a class="dfnref" href="#embedded-local-server">embedded local server</a>
              without changing the network APIs used by applications. Thus 
              even if a host is unreachable, applications can successfully
              make HTTP requests to
              <a class="dfnref" href="#managed-resource">managed resources</a>.
            </p>
  
            <div class="example"><div class="exampleHeader">Example</div>       
              <p>
                In this example, a local requst handler can produce a dynamic response
                to an application request when the network is not accessible. The 
                response can be prepared using the data cache, for example. The 
                benefit of this technique is that applications don't need to alter 
                their applications to accommodate off-line use cases. Instead, user 
                agents can transparently introduce an application-specific off-line 
                handler to deal with situations when the network is not available.  
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var uri = ...
var cache = window.openDataCache();
var local = function(request, response) {
  response.statusCode = 200;
  response.statusLine = 'HTTP/1.1 OK';
  response.bodyText = ...
  response.send();
};

window.navigator.registerOfflineHandler(uri, local);

var txn = cache.offlineTransaction(function(txn) {
  txn.capture(uri, '', null, ['GET']);
  txn.commit();
});</code></pre></div></div>
              <p>
                Later when that application issues a <code>GET</code> request for
                the cached resource either through page navigation or an XMLHttpRequest 
                <cite>[<a href="#ref-XMLHttpRequest">XMLHttpRequest</a>]</cite>, and the
                user agent is off-line, it invokes the <code>local</code> off-line 
                handler which produces a dynamic response. 
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var req = new XMLHttpRequest;
req.open('GET', uri);
...
req.send();</code></pre></div></div>
            </div>              
           
            <p>
              Applications can also locally intercept requests that modify data, 
              e.g., unsafe HTTP requests such as <code>PUT</code> in an off-line
              handler. Requests to resources that are 
              <a href="#managed-resource" class="dfnref">managed</a> in a 
              <a class="dfnref" href="#data-cache">data cache</a> can be
              intercepted and served by an 
              <a href="#interceptor" class="dfnref">interceptor</a>, when the
              user agent is off-line or by the server, when the user agent
              is online with a <a href="#reviewer" class="dfnref">reviewer</a>  
              analyzing the result of the online request. A user agent can switch 
              between these two behaviors automatically based on system conditions.
            </p>
           
            <div class="example"><div class="exampleHeader">Example</div>       
              <p>
                For example, an application worker script that wishes to allow off-line
                updates to <var>uri</var> captures that resource in a data cache.
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var uri = ...
var cache = self.openDataCacheSync();
var txn = cache.transactionSync();
txn.capture(uri, ['PUT']);
txn.commit();</code></pre></div></div>
  
              <p>
                Another application in the same origin could then register an off-line
                handler for the same <var>uri</var> to serve off-line requests to 
                that resource. 
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">cache = window.openDataCache();
var intercept = function(request, response) {
  if (...) {
    // validation fails
    response.setStatus(400, 'HTTP/1.1 Bad Request');
    response.send();
    return;
  } 
  cache.offlineTransaction(function(txn) {
    txn.oncommitted = function() {
      response.bodyText = request.bodyText;
      response.headers['Content-Type'] = type;
      response.statusCode = 200;
      response.statusLine = 'HTTP/1.1 OK';
      response.send();
    });
    txn.capture(request.targetURL, request.bodyText, request.headers['Content-Type']);
    txn.commit();    
  });
};
  
var review = function(request, response) {
  cache.offlineTransaction(function(txn) {
    txn.capture(request.targetURL, response.bodyText, response.headers['Content-Type']); 
    txn.commit();
  });
};

window.navigator.registerOfflineHandler(uri, intercept, review);</code></pre></div></div>
  
              <p>
                When the application makes a <code>PUT</code> request to 
                <var>uri</var> and the user agent is off-line,
                the user agent asks the <var>intercept</var> function to
                process the request and respond to it. If the user agent is online
                when the request arrives, then it sends the request to
                a host and asks the <var>review</var> function to process the
                response received from it.              
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var req = new XMLHttpRequest;
req.open('PUT', uri);
...
req.send(...);</code></pre></div></div>
  
              <p>
                If this application makes a <code>GET</code> request to 
                <var>uri</var>, then its cached representation is returned
                as the response regardless of whether the user agent is off-line.
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var req = new XMLHttpRequest;
  req.open('GET', uri);
  ...
  req.send();</code></pre></div></div>
            </div>
          </div>
          
          <div id="cache-events" class="section">
            <h4>4.1.2. Event summary</h4>
            <div class="norm">This section is non-normative.</div>
            
            <p>
              Application scripts may modify the <a href="#managed-resource">managed  
              resources</a> of a <a class="dfnref" href="#data-cache">data cache</a>. 
              The user agent will fetch the representations of newly added and modified
              <a href="#managed-resource">managed resources</a> and add the representations  
              to the <a class="dfnref" href="#data-cache">data cache</a>.
            </p>
            
            <p>
              A number of events are fired to keep the application
              updated as to the state of the cache, so that the
              user can be notified appropriately. The events are as follows:
            </p>
            
            <table>
              <thead><tr><th>Event name</th><th>Occasion</th><th>Next events</th></tr></thead>
              <tbody>
                <tr>
                  <td><dfn id="event-off-line-updating"><code>off-line-updating</code></dfn></td>
                  <td>A script has started an off-line transaction to modify the data cache.</td>
                  <td>
                    <a href="#event-captured" class="dfnref"><code>captured</code></a>, 
                    <a href="#event-released" class="dfnref"><code>released</code></a>, 
                    <a href="#event-ready" class="dfnref"><code>ready</code></a>
                  </td>
                </tr>

                <tr>
                  <td><dfn id="event-updating"><code>updating</code></dfn></td>
                  <td>A script has started an online transaction to modify the data cache.</td>
                  <td>
                    <a href="#event-fetching" class="dfnref"><code>fetching</code></a>, 
                    <a href="#event-released" class="dfnref"><code>released</code></a>, 
                    <a href="#event-ready" class="dfnref"><code>ready</code></a>
                  </td>
                </tr>

                <tr>
                  <td><dfn id="event-fetching"><code>fetching</code></dfn></td>
                  <td>The user agent has started fetching the representation of
                  a managed resource.</td>
                  <td>
                    <a href="#event-captured" class="dfnref"><code>captured</code></a>, 
                    <a href="#event-obsolete" class="dfnref"><code>obsolete</code></a>, 
                    <a href="#event-error" class="dfnref"><code>error</code></a>
                  </td>
                </tr>

                <tr>
                  <td><dfn id="event-captured"><code>captured</code></dfn></td>
                  <td>The user agent has finished fetching the representation of
                  a managed resource and stored it.</td>
                  <td>
                    <a href="#event-captured" class="dfnref"><code>captured</code></a>, 
                    <a href="#event-fetching" class="dfnref"><code>fetching</code></a>, 
                    <a href="#event-ready" class="dfnref"><code>ready</code></a>, 
                  </td>
                </tr>

                <tr>
                  <td><dfn id="event-released"><code>released</code></dfn></td>
                  <td>The user agent has released a managed resource 
                  and can no longer serve off-line requests to it.</td>
                  <td>
                    <a href="#event-captured" class="dfnref"><code>captured</code></a>, 
                    <a href="#event-fetching" class="dfnref"><code>fetching</code></a>, 
                    <a href="#event-ready" class="dfnref"><code>ready</code></a>, 
                  </td>
                </tr>

                <tr>
                  <td><dfn id="event-ready"><code>ready</code></dfn></td>
                  <td>All the managed resources have been cached for serving off-line
                  requests to them, and the script can use <a href="#swapCache" class="idlref"><code>
                  swapCache()</code></a> to switch to the new cache.</td>
                  <td>(Last event in sequence.)</td>
                </tr>

                <tr>
                  <td><dfn id="event-obsolete"><code>obsolete</code></dfn></td>
                  <td>The server returned a 401 error in response to a 
                  request for fetching a managed resource's representation.</td>
                  <td>(Last event in sequence.)</td>
                </tr>

                <tr>
                  <td><dfn id="event-error"><code>error</code></dfn></td>
                  <td>A fatal error occurred while fetching a managed resource's representation.</td>
                  <td>(Last event in sequence.)</td>
                </tr>

              </tbody>
            </table>            
          </div>
        </div>
        
        <div id="http-cache" class="section">
          <h3>4.2. Data Caches</h3>

          <p>
            <a class="dfnref" href="#data-cache">Data cache</a> is a programmable
            HTTP cache that can be manipulated by a Web application to serve off-line
            representations of resources. <!--These representations can be either
            static, i.e., generated from a store, or dynamic, i.e., generated
            programmatically.-->
          </p>
          
          <p>
            A <dfn id="data-cache">data cache</dfn> is a set of 
            <a href="#managed-resource" class="dfnref">managed resources</a>
            consisting of the entity (i.e., headers and body) for each
            such resource that falls into one of the following categories:
          </p>

          <dl>          
            <dt><dfn id="static-entry">Static entries</dfn></dt>
            <dd>
              A resource whose representation is cached for off-line serving.
              A request to a <a href="#static-entry" class="dfnref">static entry</a>
              can only be used with the <a class="dfnref" href="#serve-policy">serve</a> 
              policy.
            </dd>
            <dt><dfn id="dynamic-entry">Dynamic entries</dfn></dt>
            <dd>
              A resource whose representation is produced locally 
              by an application upon request. Each 
              <a href="#dynamic-entry" class="dfnref">dynamic entry</a>
              identifies one or more <dfn id="dynamic-protocol-method">dynamic protocol
              methods</dfn> for which a response can be obtained locally using an 
              <a class="dfnref" href="#interceptor">interceptor</a>.
            </dd>
          </dl>
          
          <p>
            Each <a href="#data-cache" class="dfnref">data cache</a> has a
            <dfn id="data-cache-complete">completeness flag</dfn>, which is 
            either <var>incomplete</var> or <var>complete</var>.
          </p>
      
          <p>
            A <a href="#data-cache" class="dfnref">data cache</a> may 
            have zero or one required <dfn id="authorization-cookie">
            authorization cookie</dfn>.
          </p>          
          
          <p>
            A <dfn id="data-cache-group">data cache group</dfn> is a group
            of data caches identified by the origin in which it is created 
            and its <a class="dfnref" href="#authorization-cookie">authorization cookie</a>
            <cite><a href="#ref-RFC2965">[RFC2965]</a></cite>.
          </p>
          
          <p>
            Each <a href="#data-cache" class="dfnref">data cache</a> whose
            <a href="#data-cache-complete" class="dfnref">completeness flag</a> 
            is <var>complete</var> has a <dfn id="data-cache-version">version</dfn>.
            No two <a href="#data-cache" class="dfnref">data caches</a> in
            a <a href="#data-cache-group" class="dfnref">data cache group</a>
            may have the same <a href="#data-cache-version" class="dfnref">version</a>.
            A data cache is <dfn id="data-cache-newer">newer</dfn> than 
            another if it's <a class="dfnref" href="#data-cache-version">version</a>
            is bigger than the other (in other words 
            <a href="#data-cache" class="dfnref">data caches</a> in a
            <a href="#data-cache-group" class="dfnref">data cache group</a>
            have a chronological order).
          </p>
          
          <!--p>
            Only the newest <a class="dfnref" href="#data-cache">data cache</a>
            in a <a href="#data-cache-group" class="dfnref">data cache group</a>
            can have its <a href="#data-cache-complete">completeness flag</a>
            set to <var>incomplete</var>, all the others are 
            always <var>complete</var>.
          </p-->
          
          <p>
            Each <a href="#data-cache-group" class="dfnref">data cache group</a>
            has an <dfn id="data-cache-group-status">update status</dfn>, which
            is one of the following: <var>idle</var> or <var>updating</var>.
          </p>
          
          <p>
            A <dfn id="relevant-data-cache">relevant data cache</dfn> is a
            <a href="#data-cache" class="dfnref">data cache</a> that is 
            the <a href="#data-cache-newer" class="dfnref">newest</a>
            in its <a href="#data-cache-group">group</a> to be complete.
          </p>
          
          <p>
            An <dfn id="unsecure-data-cache-group">unsecure 
            <a class="dfnref" href="#data-cache-group">data cache group</a></dfn>
            is not secured with an 
            <a href="#authorization-cookie" class="dfnref">authorization cookie</a>
            and cannot serve <a class="dfnref" href="#private">private resources</a>.
            A <dfn id="secure-data-cache-group">secure <a class="dfnref" href="#data-cache-group">
            data cache group</a></dfn> controls access to <a class="dfnref" href="#private">
            private resources</a> using an <a href="#authorization-cookie" class="dfnref">
            authorization cookie</a>. 
          </p>
          
          <p>
            A <dfn id="cache-host">cache host</dfn> is a <code>Document</code>
            or a <code>SharedWorkerGlobalScope</code> object
            <a href="#ref-WebWorkers">[WebWorkers]</a>. 
          </p>
          
          <p>
            If a <a class="dfnref" href="#data-cache-group">data cache group</a> is 
            <dfn id="available-data-cache-group" class="dfnref">available</dfn> to a 
            <a class="dfnref" href="#cache-host">cache host</a>, then it can be 
            associated with the <a class="dfnref" href="#cache-host">cache host</a>.
            A <a class="dfnref" href="#secure-data-cache-group">secure data cache group</a>
            is <a href="#available-data-cache-group" class="dfnref">available</a> to a 
            <a class="dfnref" href="#cache-host">cache host</a> if its 
            <a href="#authorization-cookie" class="dfnref">authorization cookie</a> 
            will be sent to an origin server for fetching that 
            <a class="dfnref" href="#cache-host">cache host</a>
            <cite><a href="#ref-RFC2965">[RFC2965]</a></cite>.
            An <a class="dfnref" href="#unsecure-data-cache-group">unsecure data cache group</a>
            is <a class="dfnref" href="#available-data-cache-group">available</a> to a 
            <a class="dfnref" href="#cache-host">cache host</a> if its <span>origin</span> is
            the same as its <a class="dfnref" href="#cache-host">cache host</a>'s.
          </p>
          
          <p>
            A <a href="#data-cache-group">data cache group</a> can be marked
            as <dfn id="data-cache-group-obsolete">obsolete</dfn>, meaning that it
            cannot be made <a href="#available-data-cache-group" class="dfnref">available</a> to a 
            <a class="dfnref" href="#cache-host">cache host</a>.
          </p>
          
          <p>
            When a <code>SharedWorkerGlobalScope</code> is created and when a 
            <code>Document</code> is loaded, the 
            <a class="dfnref" href="#relevant-data-cache">relevant data cache</a> of every 
            <a href="#available-data-cache-group" class="dfnref">available data cache group</a> is
            associated with it as the 
            <dfn id="effective-data-cache">effective data cache</dfn> in that
            <a class="dfnref" href="#data-cache-group">data cache group</a>.
          </p>
                  
          <p>
            Multiple <a href="#effective-data-cache">effective data caches</a> may
            contain the representation of a given resource. If the user agent is to 
            <dfn id="select-data-cache">select a data cache</dfn> from a list of 
            <a href="#relevant-data-cache" class="dfnref">relevant data caches</a>
            that contain the representation of a required resource, then the user  
            agent must use the <a href="#data-cache" class="dfnref">data cache</a> 
            that the user most likely wants to see the representation from, 
            taking into account the following:
          </p>
          
          <ul>
            <li>which <a href="#data-cache" class="dfnref">data cache</a>
            belongs to a <a class="dfnref" href="#secure-data-cache-group">secure
            data cache group</a></li>
            <li>which <a href="#data-cache" class="dfnref">data cache</a> 
            contains the latest representation of the required resource</li>
            <li>what <a href="#data-cache" class="dfnref">data cache</a> 
            the user prefers</li>
          </ul>

          <div class="section" id="opening-cache">
            <h4>4.2.1. Opening a cache</h4>
            
            <p>
              When the user agent is required to <dfn id="open-cache">open
              a data cache</dfn>, given a <a href="#cache-host" class="dfnref">
              cache host</a>, optionally the name of an
              <a class="dfnref" href="#authorization-cookie">authorization cookie</a>
              the user agent must perform the following steps:
            </p>
            
            <ol>
              <li>
                Let <var>cookie name</var> be the name of an
                <a class="dfnref" href="#authorization-cookie">authorization cookie</a>
                passed to these steps.
              </li>
            
              <li>
                Pick the appropriate substeps:
                <dl class="switch">
                  <dt>If the <a href="#cache-host" class="dfnref">cache host</a> 
                  passed to these steps is a <code>Window</code> object</dt> 
                  <dd>
                    Let <var title="">origin</var> be the <span>origin</span> 
                    of the <span>active document</span> of the <span>browsing
                    context</span> of that <code>Window</code> object.
                  </dd>
                  
                  <dt>If the <a href="#cache-host" class="dfnref">cache host</a>
                  passed to these steps is a <code>WorkerUtils</code> object</dt>
                  <dd>  
                    Let <var title="">origin</var> be the <span>origin</span>
                    of the scripts in the worker.
                  </dd>
                </dl>
              </li>
              
              <li>
                Atomically, so as to avoid race conditions, perform the following substeps
                <dl class="switch">
                  <dt>If <var>cookie name</var> is empty, then perform the following steps:</dt>
                  <dd>
                    <ol>
                      <li>
                        If there is an  
                        <a href="#unsecure-data-cache-group" class="dfnref">unsecure 
                        data cache group</a> for origin <var>origin</var>, let
                        <var>data cache group</var> be that existing 
                        <a href="#data-cache-group" class="dfnref">data cache group</a>.
                      </li>
                      <li>
                        If <var>data cache group</var> does not exist, the perform the 
                        following substeps:
                        <ol>
                          <li>Create a new 
                            <a href="#data-cache" class="dfnref">data cache</a>, called
                            <var>data cache</var>, in a new
                            <a href="#unsecure-data-cache-group" class="dfnref"> 
                            unsecure data cache group</a> for origin <var>origin</var> called
                            <var>data cache group</var>.
                          </li>
                          <li>
                            Set the <a class="dfnref" href="#data-cache-complete">
                            completeness flag</a> of <var>data cache</var> to 
                            <var>incomplete</var>.
                          </li>
                          
                          <li>
                            Set the <a class="dfnref" href="#data-cache-group-status">
                            update status</a> of <var>data cache group</var> to <var>idle</var>.
                          </li>
                        </ol>
                      </li>
                    </ol>
                  </dd>
                  <dt>If <var>cookie name</var> is not empty, then perform the following steps:</dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>data cache group</var> be an existing 
                        <a href="#secure-data-cache-group" class="dfnref">secure 
                        data cache group</a> for origin <var>origin</var>, the
                        name of whose <a class="dfnref" href="#authorization-cookie">
                        authorization cookie</a> case-insensitively matches
                        <var>cookie name</var>.
                      </li>
    
                      <li>Obtain the <span>storage mutex</span>.</li>
    
                      <li>
                        Let <var>cookie</var> be the cookie in the <span>current 
                        browsing context</span>, whose name case-insensitively
                        matches <var>cookie name</var>. 
                      </li>
                      
                      <li>
                        If <var>data cache group</var> is defined and has an 
                        <a class="dfnref" href="#authorization-cookie">authorization 
                        cookie</a> whose value doesn't match <var>cookie</var>'s value
                        then perform the following substeps:
                        <ol>
                          <li>Mark <var>data cache group</var> 
                          <a href="#data-cache-group-obsolete" class="dfnref">obsolete</a>.</li>
                          <li>
                            Create a new 
                            <a href="#data-cache" class="dfnref">data cache</a>, called
                            <var>data cache</var>, in a new
                            <a href="#secure-data-cache-group" class="dfnref">secure data
                            cache group</a> for origin <var>origin</var> called
                            <var>data cache group</var> with its 
                            <a class="dfnref" href="#authorization-cookie">authorization
                            cookie</a> set to <var>cookie</var>.
                          </li>
                          <li>
                            Set the <a class="dfnref" href="#data-cache-complete">
                            completeness flag</a> of <var>data cache</var> to 
                            <var>incomplete</var>.
                          </li>
                          
                          <li>
                            Set the <a class="dfnref" href="#data-cache-group-status">
                            update status</a> of <var>data cache group</var> to <var>idle</var>.
                          </li>
                        </ol>
                      </li>
    
                      <li>Release the <span>storage mutex</span>.</li>
                    </ol>
                  </dd>              
                </dl>
              </li>
              <li>
                Return <var>data cache</var>.            
              </li>
            </ol>
          </div>

          <div class="section" id="modifying-cache">
            <h4>4.2.2. Constructing and modifying data caches</h4>
            <p>
              Application scripts identify the resources managed by a
              <a href="#data-cache" class="dfnref">data cache</a>
              during a <dfn id="cache-transaction">cache transaction</dfn>, 
              when applications may either <a href="#capture">capture</a> or 
              <a href="#release">release</a> its resources. 
            </p>

            <p>
              Each <a class="dfnref" href="#cache-transaction">cache transaction</a>
              has a <a href="#data-cache-group" class="idlref">data cache group</a>
              and a <a href="#data-cache" class="idlref">data cache</a>.
            </p>
            
            <p>
              A <a class="dfnref" href="#cache-transaction">cache transaction</a>
              can be marked as <dfn id="transaction-off-line">off-line</dfn>.
            </p>
            
            <p>
              Each <a class="dfnref" href="#cache-transaction">cache transaction</a>
              has a <dfn id="transaction-status">status</dfn>, which can be either
              of <var>pending</var>, <var>committed</var>, or <var>aborted</var>.
            </p>
            
            <p>
              When a <a class="dfnref" href="#cache-transaction">cache transaction</a>
              is started, the user agent must run the 
              <a href="#cache-transaction-create" class="dfnref">cache 
              transaction creation process</a>. When a resource is added to a transaction's list 
              of captured resources, the user agent must run the 
              <a href="#cache-resource-capture" class="dfnref">resource capturing process</a>.
              When a resource is added to a transaction's list of released
              resources, the user agent must run the <a href="#cache-resource-release" class="dfnref">
              resource release process</a>. When the transaction is finished, 
              the user agent must run the 
              <a class="dfnref" href="#cache-transaction-commit">cache
              transaction finish process</a>. 
            </p>
            
            <div class="section" id="starting-a-transaction">
              <h5>4.2.2.1. Starting a transaction</h5>
              
              <p>
                When the user agent is required to <dfn id="cache-transaction-create">create a
                cache transaction</dfn> given a <a class="dfnref" href="#data-cache-group">
                data cache group</a> and an off-line flag, the user agent
                must run the following steps:
              </p>
              
              <ol>
                <li>
                  Let <var>cache group</var> be the
                  <a href="#data-cache-group" class="dfnref">data
                  cache group</a> passed to these steps.
                </li>
                <li>
                  If <var>cache group</var> is marked 
                  <a href="#data-cache-group-obsolete" class="dfnref">obsolete</a>,
                  then raise an exception and abort these steps.
                </li>
                <li>
                Pick the appropriate steps:
                <dl class="switch">
                  <dt>If the off-line flag passed to these steps is set.</dt>
                  <dd>
                    <ol>
                      <li>
                        Create a new <a href="#data-cache" class="dfnref">data cache</a>, 
                        called <var>data cache</var>, in <var>cache group</var>.
                      </li>
                      <li>
                        Set the <a class="dfnref" href="#data-cache-complete">
                        completeness flag</a> of <var>data cache</var> to 
                        <var>incomplete</var>.
                      </li>
                      <li>
                        Mark <var>transaction</var> as <a class="dfnref" href="#transaction-off-line">
                        off-line</a>.
                      </li>
                      <li>
                        Create a new cache transaction called <var>transaction</var> and
                        set <var>data cache</var> to be its <a href="#data-cache" class="dfnref">data cache</a>.
                      </li>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <a href="#event-off-line-updating"><code>off-line-updating</code></a>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a>
                        interface.
                      </li>
                      <li>
                        Return <var>transaction</var>.
                      </li>
                    </ol>
                  </dd>
                  
                  <dt>If the off-line flag passed to these steps is not set.</dt>
                  <dd>
                    <ol>
                      <li>
                        Atomically, so as to avoid race conditions, perform the following substeps
                        <ol>
                          <li>
                            If the <a class="dfnref" href="#data-cache-group-status">
                            status</a> of <var>cache group</var> is <var>updating</var>,
                            then raise an exception and abort
                            these steps, as a cache transaction is already open on this
                            <a class="dfnref" href="#data-cache-group">data cache group</a>.
                          </li>
                          <li>
                            Set the <a class="dfnref" href="#data-cache-group-status">
                            status</a> of <var>cache group</var> to <var>updating</var>.
                          </li>
                        </ol>
                      </li>
                      <li>
                        Create a new <a href="#data-cache" class="dfnref">data cache</a>, 
                        called <var>data cache</var>, in <var>cache group</var>
                        which holds all the same resources as the 
                        <a href="#relevant-data-cache" class="dfnref">relevant data
                        cache</a> of <var>cache group</var>.
                      </li>
                      <li>
                        Set the <a class="dfnref" href="#data-cache-complete">
                        completeness flag</a> of <var>data cache</var> to 
                        <var>incomplete</var>.
                      </li>
                      <li>
                        Mark <var>transaction</var> as not <a class="dfnref" href="#transaction-off-line">
                        off-line</a>.
                      </li>
                      <li>
                        Create a new cache transaction called <var>transaction</var> and
                        set <var>data cache</var> to be its <a href="#data-cache" class="dfnref">data cache</a>.
                      </li>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <code><a href="#event-updating">updating</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface.
                      </li>
                    </ol>
                  </dd>
                </dl></li>
                <li>
                  Set <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> to
                  <var>pending</var>.
                </li>
                <li>
                  Return <var>transaction</var>.
                </li>
              </ol>
            </div>
            
            <div class="section" id="adding-capture-transaction">
              <h5>4.2.2.2. Capturing resources</h5>
              
              <p>
                When the user agent is required to <dfn id="cache-resource-capture">add a
                resource to be captured</dfn>, given the URI of the resource to
                capture, a <a href="#cache-host" class="dfnref">cache host</a>, 
                a <a class="dfnref" href="#cache-transaction">cache transaction</a>,
                optionally a list of dynamic methods, optionally content to serve
                as the static representation of the resource, and optionally
                content type for the representation, the user agent must perform
                the following steps:
              </p>
              
              <ol>
                <li>
                  Let <var>transaction</var> be the 
                  <a class="dfnref" href="#cache-transaction">cache transaction</a>
                  passed to these steps.
                </li>
                
                <li>
                  If <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> is not
                  <var>pending</var>, then raise an exception and abort these steps.
                </li>
                
                <li>
                  Pick the appropriate substeps:
                  <dl class="switch">
                    <dt>If the <a href="#cache-host" class="dfnref">cache host</a> 
                    passed to these steps is a <code>Window</code> object</dt> 
                    <dd>
                      Let <var title="">base URI</var> be the location 
                      of the <span>active document</span> of the <span>browsing
                      context</span> of that <code>Window</code> object.
                    </dd>
                    
                    <dt>If the <a href="#cache-host" class="dfnref">cache host</a>
                    passed to these steps is a <code>WorkerUtils</code> object</dt>
                    <dd>  
                      Let <var title="">base URI</var> be the location
                      of the worker.
                    </dd>
                  </dl>
                </li>
                
                <li>
                  Resolve the URI passed to these steps relative to <var>base URI</var>. 
                </li>
                
                <li>
                  If the resulting absolute URI has a different &lt;scheme&gt; component 
                  than the base URI (compared in an ASCII case-insensitive manner), then
                  throw an exception and abort these steps.
                </li>
                
                <li>
                  If the resulting absolute URI does not have the same <span>origin</span>
                  as <var>base URI</var>, then throw an exception and abort these steps.
                </li>
                
                <li>
                  Drop the &lt;fragment&gt; component of the resulting absolute URI, if it has one.
                </li>
                
                <li>
                  Let <var>cache</var> be <var>transaction</var>'s 
                  <a href="#data-cache" class="dfnref">data cache</a>.
                </li>
                
                <li>
                  If the resulting absolute URI identifies a <a href="#managed-resource" class="dfnref">
                  managed resource</a> that is already in <var>cache</var>, then
                  remove that <a href="#managed-resource" class="dfnref">managed 
                  resource</a> from <var>cache</var>.
                </li>
                
                <li>
                  Pick the appropriate substeps: <dl class="switch">
                  <dt>
                    If <var>transaction</var>'s is not marked as 
                    <a class="dfnref" href="#transaction-off-line">off-line</a>
                  </dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>cache group</var> be the 
                        <a href="#data-cache-group" class="dfnref">data cache group</a>
                        containing <var>cache</var>.
                      </li>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event with
                        the name <code><a href="#event-fetching">fetching</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface at the <a href="#cache-host">cache host</a>.
                      </li>
                      <li>
                        Fetch the representation of the resource identified by the
                        absolute URI. Use the <var>transaction</var>'s <a href="#data-cache" class="dfnref">
                        data cache</a> as an HTTP cache, and honor HTTP caching
                        semantics (such as expiration, ETags, and so forth) with
                        respect to that cache. User agents may also have other
                        caches in place that are also honored.
                        
                        <div class="note"><div class="noteHeader">Note</div>
                          If the resource in question is already being fetched
                          for other reasons, then the existing download process can
                          sometimes be used for the purposes of this step.
                        </div>
                      </li>
                      
                      <li>
                        If the previous step fails (e.g. the server returns a 4xx
                        or 5xx response or equivalent, or there is a DNS error, or
                        the connection times out, or the user cancels the download),
                        or if the server returned a redirect, then run the
                        <a class="dfnref" href="#capture-failure">capture failure</a>
                        steps.
                        <div class="note"><div class="noteHeader">Note</div>
                          Redirects are fatal because they are either indicative of
                          a network problem (e.g. a captive portal); or would allow
                          resources to be added to the cache under URIs that differ
                          from any URI that the networking model will allow access
                          to, leaving orphan entries; or would allow resources to
                          be stored under URIs different than their true URIs. All
                          of these situations are bad.
                        </div>
                      </li>
                      
                      <li>
                        Otherwise, the fetching succeeded. Store in <var>cache</var> a 
                        <a href="#managed-resource" class="dfnref">managed resource</a> 
                        comprising the resulting absolute URI, its fetched
                        representation, and the list of dynamic methods passed to these
                        steps. 
                      </li>
                      
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <code><a href="#event-captured">captured</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface.                      
                      </li>
                    </ol>
                  </dd>
                  <dt>
                    If <var>transaction</var> is marked as
                    <a class="dfnref" href="#transaction-off-line">off-line</a>.
                  </dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>representation</var> be the content passed
                        to these steps.
                      </li>
                      <li>
                        Let <var>type</var> be the content type passed to these steps.
                      </li>
                      <li>
                        If <var>type</var> is empty or null, set it to <code>text/plain</code>.
                      </li>
                      <li>
                        Store in <var>cache</var> a <a href="#managed-resource" class="dfnref">
                        managed resource</a> comprising the resulting absolute URI, <var>
                        representation</var>, and the list of dynamic methods passed to these
                        steps.                       
                      </li>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <code><a href="#event-captured">captured</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface.                      
                      </li>
                    </ol>
                  </dd>
                </dl></li>            
              </ol>
              
              <p>
                The <dfn id="capture-failure">capture failure steps</dfn> are as follows:
              </p>
              
              <ol>
                <li>Discard <var>cache</var>.</li>
                <li>
                  Set <var>cache group</var>'s 
                  <a href="#data-cache-group-status" class="dfnref">status</a>
                  to <var>idle</var>.
                </li>
                <li>Pick the appropriate substeps:              
                  <dl class="switch">
                    <dt>If the failure was not caused by a 401 response, then</dt>
                    <dd><ol>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <code><a href="#event-error">error</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface.                      
                      </li>
                    </ol></dd>
                    <dt>If the failure was not caused by a 401 response, then</dt>
                    <dd><ol>
                      <li>
                        Mark <var>cache group</var> as 
                        <a href="#data-cache-group-obsolete" class="dfnref">obsolete</a>.
                      </li>
                      <li>
                        For each <a href="#cache-host">cache host</a> associated with a
                        <a href="#data-cache">data cache</a> in <var title="">cache
                        group</var>, <span>queue a task</span> to fire an event
                        at the <a class="dfnref" href="#cache-host">cache host</a> with
                        the name <code><a href="#event-obsolete">obsolete</a></code>, 
                        which does not bubble, is not cancelable, and which uses the
                        <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                        interface.
                      </li>
                    </ol></dd>
                  </dl>
                </li>
                <li>
                  Mark <var>transaction</var>'s <a href="#transaction-status">status</a>
                  as <var>aborted</var>.
                </li>
              </ol>
              
              <p>
                Attempts to <span>fetch</span> resources as part of the
                <a href="#cache-resource-capture">adding resource for capturing process</a>
                may be done with cache-defeating semantics, to avoid problems with
                stale or inconsistent intermediary caches.
              </p>
            </div>
            
            <div class="section" id="release-resource">
              <h5>4.2.2.3. Releasing resources</h5>
              
              <p>
                When the user agent is required to <dfn id="cache-resource-release">add a
                resource to be released</dfn>, given the URI of the resource to
                release, a <a href="#cache-host" class="dfnref">cache host</a>, and
                a <a class="dfnref" href="#cache-transaction">cache transaction</a>, 
                the user agent must perform the following steps:
              </p>
              
              <ol>
                <li>
                  Let <var>transaction</var> be the 
                  <a class="dfnref" href="#cache-transaction">cache transaction</a>
                  passed to these steps.
                </li>
                
                <li>
                  If <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> is not
                  <var>pending</var>, then raise an exception and abort these steps.
                </li>
                
                <li>
                  Pick the appropriate substeps:
                  <dl class="switch">
                    <dt>If the <a href="#cache-host" class="dfnref">cache host</a> 
                    passed to these steps is a <code>Window</code> object</dt> 
                    <dd>
                      Let <var title="">base URI</var> be the location 
                      of the <span>active document</span> of the <span>browsing
                      context</span> of that <code>Window</code> object.
                    </dd>
                    
                    <dt>If the <a href="#cache-host" class="dfnref">cache host</a>
                    passed to these steps is a <code>WorkerUtils</code> object</dt>
                    <dd>  
                      Let <var title="">base URI</var> be the location
                      of the worker.
                    </dd>
                  </dl>
                </li>
                
                <li>
                  Resolve the URI passed to these steps relative to <var>base URI</var>. 
                </li>
                
                <li>
                  If the resulting absolute URI has a different &lt;scheme&gt; component 
                  than the base URI (compared in an ASCII case-insensitive manner), then
                  throw an exception and abort these steps.
                </li>
                
                <li>
                  If the resulting absolute URI does not have the same <span>origin</span>
                  as <var>base URI</var>, then throw an exception and abort these steps.
                </li>
                
                <li>
                  Drop the &lt;fragment&gt; component of the resulting absolute URI, if it has one.
                </li>
                
                <li>
                  Let <var>cache</var> be <var>transaction</var>'s 
                  <a href="#data-cache" class="dfnref">data cache</a>.
                </li>
                
                <li>
                  If the resulting absolute URI does not identify a <a href="#managed-resource" class="dfnref">
                  managed resource</a> that is already in <var>cache</var>, then raise
                  an exception and abort these steps.
                </li>
                
                <li>
                  Remove the <a href="#managed-resource" class="dfnref">managed 
                  resource</a> for the resulting absolute URI from <var>cache</var>.
                </li>
                
                <li>
                  For each <a href="#cache-host">cache host</a> associated with a
                  <a href="#data-cache">data cache</a> in <var title="">cache
                  group</var>, <span>queue a task</span> to fire an event
                  at the <a class="dfnref" href="#cache-host">cache host</a> with
                  the name <code><a href="#event-released">released</a></code>,
                  which does not bubble, is not cancelable, and which uses the
                  <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                  interface.                      
                </li>
              </ol>
            </div>
            
            <div class="section" id="complete-transaction"> 
              <h5>4.2.2.4. Completing a transaction</h5>
              
              <p>
                When the user agent is required to  
                <dfn id="cache-transaction-commit">commit a cache transaction</dfn>, 
                given a <a class="dfnref" href="#cache-transaction">cache transaction</a>, 
                and a <a href="#cache-host" class="idlref">cache host</a>,
                it means that the user agent must run the following steps:
              </p>
              
              <ol>
                <li>
                  Let <var>transaction</var> be the 
                  <a class="dfnref" href="#cache-transaction">cache transaction</a>
                  passed to these steps.
                </li>

                <li>
                  If <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> is not
                  <var>pending</var>, then raise an exception and abort these steps.
                </li>
                
                <li>
                  Let <var>cache</var> be <var>transaction</var>'s 
                  <a href="#data-cache" class="dfnref">data cache</a>.
                </li>
                
                <li>
                  Let <var>cache group</var> be the 
                  <a href="#data-cache-group" class="dfnref">data cache group</a>
                  containing <var>cache</var>.
                </li>

                <li>
                  Atomically, so as to avoid race conditions, perform the following
                  substeps:
                  <ol>
                    <li>
                      Let <var>cache group version</var> be the 
                      <a href="#data-cache-version" class="dfnref">version</a> of the 
                      <a href="#relevant-data-cache">relevant data cache</a> of
                      <var>cache group</var>.
                    </li>
                    <li>
                      Set <var>cache</var>'s <a href="#data-cache-version" class="dfnref">version</a>
                      to be higher than <var>cache group version</var>.
                    </li>
                    <li>
                      Set the <var>cache</var>'s <a href="#data-cache-complete" class="dfnref">
                      completeness flag</a> to <var>complete</var>.
                    </li>                    
                    <li>Obtain the storage mutex</li>
                    <li>
                      If the host sets cookies in response to such a request, 
                      the user agent should update its cookie store accordingly. 
                    </li>
                    <li>Release the storage mutex.</li>
                  </ol>
                </li>
                <li>
                  Pick the appropriate substeps:
                  <dl class="switch">
                    <dt>
                      If <var>transaction</var> is not marked as
                      <a href="#transaction-off-line" class="dfnref">off-line</a>,
                    </dt>
                    <dd>
                      <ol>  
                        <li>
                          Set the <a class="dfnref" href="#data-cache-group-status">status</a>
                          of <var>cache group</var> to <var>idle</var>.
                        </li>
                      </ol>
                    </dd>
                    <dt>
                      If <var>transaction</var> is marked as
                      <a href="#transaction-off-line" class="dfnref">off-line</a>
                    </dt>
                    <dd>
                      <ol>  
                        <li>
                          Make <var>cache</var> the <a href="#effective-data-cache" class="dfnref">
                          effective cache</a> for <var>cache group</var> to the
                          <a href="#cache-host" class="idlref">cache host</a>
                          passed to these steps.
                        </li>
                      </ol>
                    </dd>
                  </dl>
                </li>
                <li>
                  For each <a href="#cache-host">cache host</a> associated with a
                  <a href="#data-cache">data cache</a> in <var title="">cache
                  group</var>, except for the
                  <a href="#cache-host" class="idlref">cache host</a> passed to 
                  these steps, <span>queue a task</span> to fire an event
                  at the <a class="dfnref" href="#cache-host">cache host</a> with
                  the name <code><a href="#event-ready">ready</a></code>,
                  which does not bubble, is not cancelable, and which uses the
                  <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                  interface.                      
                </li>
              </ol>
            </div>           
            
            <div class="section" id="abort-transaction"> 
              <h5>4.2.2.5. Aborting a transaction</h5>
              
              <p>
                When the user agent is required to  
                <dfn id="cache-transaction-abort">abort a cache transaction</dfn>, 
                given a <a class="dfnref" href="#cache-transaction">cache transaction</a>, 
                and a <a href="#cache-host" class="idlref">cache host</a>,
                it means that the user agent must run the following steps:
              </p>
              
              <ol>
                <li>
                  Let <var>transaction</var> be the 
                  <a class="dfnref" href="#cache-transaction">cache transaction</a>
                  passed to these steps.
                </li>

                <li>
                  If <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> is not
                  <var>pending</var>, then raise an exception and abort these steps.
                </li>
                
                <li>
                  Discard <var>transaction</var>'s 
                  <a href="#data-cache" class="dfnref">data cache</a>.
                </li>
                
                <li>
                  Set <var>transaction</var>'s 
                  <a href="#transaction-status" class="dfnref">status</a> as 
                  <var>aborted</var>.
                </li>
                <li>
                  For each <a href="#cache-host">cache host</a> associated with a
                  <a href="#data-cache">data cache</a> in <var title="">cache
                  group</var>, <span>queue a task</span> to fire an event
                  at the <a class="dfnref" href="#cache-host">cache host</a> with
                  the name <code><a href="#event-error">error</a></code>,
                  which does not bubble, is not cancelable, and which uses the
                  <a class="idltype" href="#CacheEvent"><code>CacheEvent</code></a> 
                  interface.                      
                </li>
              </ol>
            </div>
            
            <div class="section" id="activating-updates">
              <h5>4.2.2.6. Activating updates</h5>
            
              <p>
                Once a <a class="dfnref" href="#cache-host">cache host</a> picks an 
                <a class="dfnref" href="#effective-data-cache">effective data cache</a>
                in a <a class="dfnref" href="#data-cache-group">data cache group</a>,
                an application script can use its representations. However, once update
                transactions are completed on that 
                <a class="dfnref" href="#data-cache-group">data cache group</a>, the
                <a class="dfnref" href="#effective-data-cache">effective data cache</a>
                is no longer the 
                <a class="dfnref" href="#relevant-data-cache">relevant data cache</a>.
              </p>
              
              <p>
                When a user agent is required to <dfn id="activate-updates">activate 
                updates</dfn> for a given 
                <a class="dfnref" href="#data-cache-group">data cache group</a> and
                a <a href="#cache-host" class="dfnref">cache host</a>, the user agent
                must run the steps below:
              </p>
              
              <ol>
                <li>
                  Let <var>cache</var> be the 
                  <a class="dfnref" href="#relevant-data-cache">relevant data cache</a>
                  for the <a class="dfnref" href="#data-cache-group">data cache group</a>
                  passed to these steps.
                </li>
                
                <li>
                  If <var>cache</var> is the same as the 
                  <a class="dfnref" href="#effective-data-cache">effective data cache</a>
                  for the <a class="dfnref" href="#data-cache-group">data cache group</a>
                  in the <a href="#cache-host" class="dfnref">cache host</a> passed
                  to these steps, then terminate these steps.
                </li>
                
                <li>
                  Set <var>cache</var> to be the 
                  <a class="dfnref" href="#effective-data-cache">effective data cache</a>
                  for the <a class="dfnref" href="#data-cache-group">data cache group</a>
                  to the <a class="dfnref" href="#cache-host">cache host</a> passed to
                  these steps.
                </li>
              </ol>
            </div>
          </div>
          
          <div class="section" id="expiring-application-caches">
            <h4>4.2.3. Expiring data caches</h4>
            
            <p>
              As a general rule, user agents should not expire data
              caches, except on request from the user, or after having been left
              unused for an extended period of time.
            </p>
            <p>
              Implementors are encouraged to expose data caches in a
              manner related to HTTP cookies, allowing caches to be expired
              together with cookies and other origin-specific data. Data
              caches and cookies have similar implications with respect to privacy
              (e.g. if the site can identify the user when providing the cache, it
              can store data in the cache that can be used for cookie
              resurrection).
            </p>
          </div>
    
          <div class="section" id="datacache-api">
            <h4>4.2.4. The API</h4>
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Supplemental] 
  interface <dfn id="CacheUtil">CacheUtil</dfn> {
    <a href="#DataCache">DataCache</a> <a href="#openDataCache">openDataCache</a>([optional in] DOMString cookieName);
  };
    
  <span>Window</span> implements <a href="#CacheUtil">CacheUtil</a>;
  
  [Supplemental]
  interface <dfn id="CacheUtilSync">CacheUtilSync</dfn> {
    <a href="#DataCacheSync">DataCacheSync</a> <a href="#openDataCacheSync">openDataCacheSync</a>([optional in] DOMString cookieName);
  };
    
  <span>WorkerUtils</span> implements <a href="#CacheUtilSync">CacheUtilSync</a>;</code></pre></div></div>  
            </div>
            <dl>
              <dt><code>window.</code><dfn id="openDataCache"><code>openDataCache()</code></dfn></dt> 
              <dd>
                (In a window) Returns a <a href="#DataCache"><code>DataCache</code></a> object 
                that represents the <a href="#data-cache" class="dfnref">data 
                cache</a> obtained from <a class="dfnref" href="#open-cache">cache
                opening steps</a> using <code>window</code> as the <a href="#cache-host" class="dfnref">cache
                host</a> and <var>cookieName</var> as the name of an
                <a class="dfnref" href="#authorization-cookie">authorization 
                cookie</a>.
              </dd>

              <dt><code>self.</code><dfn id="openDataCacheSync"><code>openDataCacheSync()</code></dfn></dt>
              <dd>
                (In a shared worker) Returns a <a href="#DataCacheSync"><code>DataCacheSync</code></a> object 
                that represents the <a href="#data-cache" class="dfnref">data 
                cache</a> obtained from <a class="dfnref" href="#open-cache">cache
                opening steps</a> using <code>worker</code> as the <a href="#cache-host" class="dfnref">cache
                host</a> and <var>cookieName</var> as the name of an
                <a class="dfnref" href="#authorization-cookie">authorization 
                cookie</a>.
              </dd>
            </dl>
            
            <div class="example"><div class="exampleHeader">Example</div>     
              <p>
                Here's how a shared worker opens an unsecure data cache. Representations cached in
                unsecure data caches are available regardless of authorization.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var cache = self.openDataCacheSync();</code></pre></div></div>
              <p>
                If an application were to use a cookie named 'SSID' to secure access to
                <a class="dfnref" href="#private">private</a> resources, then it would need 
                to use a secure cache for accessing those resources off-line. 
                <!--A secure cache based on the 'SSID' cookie would record 
                that cookie's value when the cache is first opened. This cookie is also
                used when capturing representations. When an application accesses representations
                from the secure cache, the current value of the 'SSID' cookie is compared
                with the one recorded in the secure cache. Only if there is a match,
                would the cached representation be served.-->
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var cache = window.openDataCache('SSID');</code></pre></div></div>
            </div>
          </div>
        
          <div id="async-datacache-interface" class="section">
            <h4>4.2.5. Asynchronous Data Cache API</h4>
  
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="DataCache">DataCache</dfn> { 
  const unsigned short <a href="#status-IDLE">IDLE</a> = 0;
  const unsigned short <a href="#status-READY">READY</a> = 1;
  const unsigned short <a href="#status-OBSOLETE">OBSOLETE</a> = 2;
  readonly attribute unsigned short <a href="#cache-status">status</a>;
  readonly attribute DOMString <a href="#required-cookie">requiredCookie</a>;
  readonly attribute long <a href="#version">version</a>;
  
  // updates
  void <a href="#online-transaction">transaction</a>(in <a href="#TransactionCallback">TransactionCallback</a> callback,
                   [optional in] <a href="#VoidCallback">VoidCallback</a> errorCallback);
  void <a href="#offline-transaction">offlineTransaction</a>(in <a href="#TransactionCallback">TransactionCallback</a> callback,
                          [optional in] <a href="#VoidCallback">VoidCallback</a> errorCallback);
  void <a href="#swapCache">swapCache</a>();
  void <a href="#eachModificationSince">eachModificationSince</a>(in long version, 
                             in <a href="#ItemCallback">ItemCallback</a> callback,
                             [optional in] <a href="#VoidCallback">VoidCallback</a> successCallback);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="TransactionCallback">TransactionCallback</dfn> {
  void callback(in <a href="#CacheTransaction">CacheTransaction</a> txn);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="VoidCallback">VoidCallback</dfn> {
  void callback();
};</code></pre></div></div>
            </div>
            
            <dl>
              <dt>
                <dfn id="online-transaction"><code>transaction()</code></dfn> and
                <dfn id="offline-transaction"><code>offlineTransaction()</code></dfn>
              </dt>
              <dd>
                Both methods take one or two arguments - a <var>transaction 
                callback</var> and optionally an <var>error callback</var>.
                When called, this method must immediately return and asynchronously
                perform the following steps:
                <ol>
                  <li>
                    Set <var>off-line</var> to false if 
                    <a href="#offline-transaction" class="idlref"><code>
                    offlineTransaction()</code></a> was called, and true otherwise.
                  </li>
                  <li>
                    Execute the steps to <a class="dfnref" href="#cache-transaction-create">
                    create a cache transaction</a> with the first argument being the
                    <a class="dfnref" href="#data-cache-group">data cache group</a> of this
                    <a href="#DataCache"><code>DataCache</code></a> object and the second
                    argument being <var>off-line</var>.
                  </li>
                  <li>
                    Let <var>result</var> be a new <a href="#CacheTransaction" class="dfnref">
                    <code>CacheTransaction</code></a> object for the <var>transaction</var> 
                    returned from the previous step.
                  </li>
                  <li>
                    If <var>transaction callback</var> is not null, 
                    <span>queue a task</span> to invoke the <var>transaction callback</var>
                    with the aforementioned <a href="#CacheTransaction" class="dfnref">
                    <code>CacheTransaction</code></a> object as its only argument, and wait
                    for that task to be run. 
                  </li>
                  <li>
                    If <var>transaction callback</var> raised an exception, jump to 
                    the last step. 
                  </li>
                  <li>
                    End these steps. The next step is only used when something goes wrong. 
                  </li>
                  <li>
                    <span>Queue a task</span> to invoke the <var>error callback</var>, 
                    if it is not null. 
                  </li>
                </ol>
              </dd>
              <dt><dfn id="swapCache"><code>swapCache()</code></dfn></dt>
              <dd>
                Perform the steps to <a class="dfnref" href="#activate-updates">activate 
                updates</a> with the
                <a class="dfnref" href="#data-cache-group">data cache group</a> of this
                <a href="#DataCache"><code>DataCache</code></a> object.
              </dd>
              <dt><dfn id="eachModificationSince"><code>eachModificationSince()</code></dfn></dt>
              <dd>
                This method takes one to three parameters - <var>low watermark version</var> and
                <var>item callback</var>, and an optional <var> success callback</var>. When
                called, this method must immediately return and asynchronously perform the
                following steps:
                <ol>
                  <li>
                    Let <var>additions</var> be a list of entities with their URIs and 
                    let <var>removals</var> be a list of URIs.
                  </li>
                  <li>
                    Let <var>cache</var> be the <a class="dfnref" href="#data-cache">
                    data cache</a> represented by this <a href="#DataCache"><code>
                    DataCache</code></a> object.
                  </li>
                  <li>
                    For each <a class="dfnref" href="#data-cache">data cache</a> 
                    belonging to <var>cache</var>'s <a class="dfnref" href="#data-cache-group">data 
                    cache group</a>, starting from <var>cache</var>'s 
                    <a href="#data-cache-version" class="dfnref">version</a> down
                    to <var>low watermark version</var>, perform the following substeps:
                    <ol>
                      <li>
                        Let <var>old cache</var> be the
                        <a class="dfnref" href="#data-cache">data cache</a>.
                      </li>
                      <li>
                        Let <var>old version</var> be <var>old cache</var>'s
                        <a href="#data-cache-version" class="dfnref">version</a>.
                      </li>
                      <li>
                        For the entity <var>entity</var>of each <a href="#managed-resource" class="dfnref">
                        managed resource</a> of <var>old cache</var> that was
                        added in the <var>old version</var>, perform
                        the following steps:
                        <ol>
                          <li>
                            Let <var>id</var> be the URI of the
                            <a href="#managed-resource" class="dfnref">managed 
                            resource</a>.
                          </li>
                          <li>
                            If neither <var>additions</var> nor <var>removals</var>
                            already includes <var>id</var>, then add <var>id</var>
                            with <var>entity</var> to <var>additions</var>.
                          </li>
                        </ol>
                      </li>
                      <li>
                        For each <a href="#managed-resource" class="dfnref">
                        managed resource</a> of <var>old cache</var> that was
                        removed in the <var>old version</var>, perform
                        the following steps:
                        <ol>
                          <li>
                            Let <var>id</var> be the URI of the
                            <a href="#managed-resource" class="dfnref">managed 
                            resource</a>.
                          </li>
                          <li>
                            If neither <var>additions</var> nor <var>removals</var>
                            already includes <var>id</var>, then add <var>id</var>
                            to <var>removals</var>.
                          </li>
                        </ol>
                      </li>   
                    </ol>
                  </li>
                  <li>
                    If <var>item callback</var> is not null, then for each item 
                    <var>item</var> in <var>additions</var>, perform the following steps:
                    <ol>
                      <li>
                        For each item <var>item</var> in <var>additions</var>,
                        <span>queue a task</span> to invoke the <var>item callback</var> 
                        with <var>item</var>.
                      </li>
                      <li>
                        For each item <var>item</var> in <var>removals</var>,
                        <span>queue a task</span> to invoke the <var>item callback</var> 
                        with <var>item</var>.
                      </li>
                    </ol>
                  </li>
                  <li>
                    If <var>success callback</var> is not null, then 
                    <span>queue a task</span> to invoke the <var>success callback</var>
                  </li>
                </ol>
              </dd>
              <dt><dfn id="version"><code>version</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the 
                <a href="#data-cache-version" class="dfnref">version</a> of the 
                <a class="dfnref" href="#data-cache">data cache</a> of this
                <a href="#DataCache"><code>DataCache</code></a> object.
              </dd>
              <dt><dfn id="required-cookie"><code>requiredCookie</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the name of the
                <a href="#authorization-cookie" class="dfnref">authorization cookie
                </a> of the <a class="dfnref" href="#data-cache-group">data cache
                group</a> of this <a href="#DataCache"><code>DataCache</code></a> object.
              </dd>
              <dt><dfn id="cache-status"><code>status</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the current state of the 
                <a class="dfnref" href="#data-cache">data cache</a> of this
                <a href="#DataCache"><code>DataCache</code></a> object. This must
                be the appropriate value from the following list:
                <dl>
                  <dt><dfn id="status-IDLE"><code>IDLE</code></dfn></dt>
                  <dd>
                    This <a href="#DataCache"><code>DataCache</code></a> object's
                    <a class="dfnref" href="#cache-host">cache host</a> is aassociated
                    with a <a class="dfnref" href="#data-cache">data cache</a> whose
                    <a class="dfnref" href="#data-cache-group">data cache group</a>'s
                    <a class="dfnref" href="#data-cache-group-status">update status</a>
                    is <var>idle</var> and that <a class="dfnref" href="#data-cache">data 
                    cache</a> is the <a class="dfnref" href="#data-cache-newer">newest</a>
                    cache in its <a class="dfnref" href="#data-cache-group">data cache 
                    group</a>, and the <a class="dfnref" href="#data-cache-group">data
                    cache group</a> is not marked 
                    <a class="dfnref" href="#data-cache-group-obsolete">obsolete</a>.
                  </dd>
                  <dt><dfn id="status-READY"><code>READY</code></dfn></dt>
                  <dd>
                    This <a href="#DataCache"><code>DataCache</code></a> object's
                    <a class="dfnref" href="#cache-host">cache host</a> is aassociated
                    with a <a class="dfnref" href="#data-cache">data cache</a> whose
                    <a class="dfnref" href="#data-cache-group">data cache group</a>'s
                    <a class="dfnref" href="#data-cache-group-status">update status</a>
                    is <var>idle</var>, and whose <a class="dfnref" href="#data-cache-group">
                    data cache group</a> is not marked as
                    <a class="dfnref" href="#data-cache-group-obsolete">obsolete</a>, but
                    that <a class="dfnref" href="#data-cache">data cache</a> is not the 
                    <a class="dfnref" href="#data-cache-newer">newest</a>
                    cache in its <a class="dfnref" href="#data-cache-group">data cache 
                    group</a>.
                  </dd>
                  <dt><dfn id="status-OBSOLETE"><code>OBSOLETE</code></dfn></dt>
                  <dd>
                    This <a href="#DataCache"><code>DataCache</code></a> object's
                    <a class="dfnref" href="#cache-host">cache host</a> is aassociated
                    with a <a class="dfnref" href="#data-cache">data cache</a> whose
                    <a class="dfnref" href="#data-cache-group">data cache group</a>
                    is marked as
                    <a class="dfnref" href="#data-cache-group-obsolete">obsolete</a>.
                  </dd>
                </dl>
              </dd>
            </dl>
          </div>
          
          <div id="sync-datacache-interface" class="section">
            <h4>4.2.6. Synchronous Data Cache API</h4>
  
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="DataCacheSync">DataCacheSync</dfn> : <a href="#DataCache">DataCache</a> {
  <a href="#OnlineTransaction">OnlineTransaction</a> <a href="#online-transaction">transactionSync</a>();
};</code></pre></div></div>
            </div>
            
            <p>
              The <dfn id="transactionSync"><code>transactionSync</code></dfn> method 
              must perform the following steps:
            </p>
            <ol>
              <li>
                Execute the steps to <a class="dfnref" href="#cache-transaction-create">
                create a cache transaction</a> with the first argument being the
                <a class="dfnref" href="#data-cache-group">data cache group</a> of this
                <a href="#DataCache"><code>DataCache</code></a> object and the second
                argument being false.
              </li>
              <li>
                Let <var>result</var> be a new <a href="#CacheTransaction" class="dfnref">
                <code>CacheTransaction</code></a> object for the <var>transaction</var> 
                returned from the previous step.
              </li>
              <li>Return <var>result</var>.</li>
            </ol>
          </div>
          
          <div id="transaction-interface" class="section">
            <h4>4.2.7. Transaction API</h4>
  
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="CacheTransaction">CacheTransaction</dfn> {
  void <a href="#get-item">getItem</a>(in DOMString uri, <a href="#ItemCallback">ItemCallback</a> callback);
  void <a href="#txn-release">release</a>(in DOMString uri);
  void <a href="#commit">commit</a>();
  
  // events
           attribute Function <a href="#oncommitted">oncommitted</a>;
};

interface <dfn id="OnlineTransaction">OnlineTransaction</dfn> : <a href="#CacheTransaction">CacheTransaction</a> {
  void <a href="#network-capture">capture</a>(in DOMString uri, [optional in] DOMStringList dynamicMethods);
  void <a href="#abort">abort</a>();
};

interface <dfn id="OfflineTransaction">OfflineTransaction</dfn> : <a href="#CacheTransaction">CacheTransaction</a> {
  void <a href="#local-capture">capture</a>(in DOMString uri, 
               in DOMString body, 
               [optional in] DOMString contentType, 
               [optional in] DOMStringList dynamicMethods);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="ItemCallback">ItemCallback</dfn> {
  void callback(in <a href="#CacheItem">CacheItem</a> item);
};

interface <dfn id="CacheItem">CacheItem</dfn> {
  const unsigned short <a href="#ready-state-UNCACHED">UNCACHED</a> = 0;
  const unsigned short <a href="#ready-state-FETCHING">FETCHING</a> = 1;
  const unsigned short <a href="#ready-state-CACHED">CACHED</a> = 2;
  const unsigned short <a href="#ready-state-GONE">GONE</a> = 3;
  
  readonly attribute unsigned short <a href="#item-readyState">readyState</a>;
  readonly attribute <span>FileData</span> <a href="#item-body">body</a>;
  readonly attribute DOMStringList <a href="#item-dynamicMethods">dynamicMethods</a>; 
  readonly attribute any <a href="#item-headers">headers</a>;
};</code></pre></div></div>
            </div>

            <dl>
              <dt><dfn id="network-capture"><code>capture()</code></dfn></dt>
              <dd>
                This method takes one or two arguments - a <var>uri</var> of the
                resource to capture and an
                optional list of <var>dynamic methods</var>. When called, this
                method must immediately return and asynchronously perform the steps 
                in the <a href="#cache-resource-capture" class="dfnref">resource
                capturing process</a> with the first argument being <var>uri</var>,
                second being the current <code>window</code> or <code>worker</code> object,
                the third being this <a href="#CacheTransaction" class="dfnref">
                <code>CacheTransaction</code></a> object's associated 
                <a class="dfnref" href="#cache-transaction">cache transaction</a>,
                the fourth being <var>dynamic methods</var>.
              </dd>
              <dt><dfn id="local-capture"><code>capture()</code></dfn></dt>
              <dd>
                This method takes two to four arguments - a <var>uri</var> of the
                resource to capture, an <var>
                entity body</var>, optionally a <var>content type</var>, and an
                optional list of <var>dynamic methods</var>. When called, this
                method must immediately return and asynchronously perform the steps 
                in the <a href="#cache-resource-capture" class="dfnref">resource
                capturing process</a> with the first argument being <var>uri</var>,
                second being the current <code>window</code> or <code>worker</code> object,
                the third being this <a href="#CacheTransaction" class="dfnref">
                <code>CacheTransaction</code></a> object's associated 
                <a class="dfnref" href="#cache-transaction">cache transaction</a>,
                the fourth being <var>dynamic methods</var>, the fifth being 
                <var>entity body</var>, and the sixth being <var>content type</var>.
              </dd>
              <dt><dfn id="txn-release"><code>release()</code></dfn></dt>
              <dd>
                This method takes one argument - <var>uri</var> of the resource to
                release. When called, this method must immediately return and  
                asynchronously perform the steps in the 
                <a href="#cache-resource-release" class="dfnref">resource
                releasing process</a> with the first argument being <var>uri</var>,
                second being the current <code>window</code> or <code>worker</code> object,
                and the third being this <a href="#CacheTransaction" class="dfnref">
                <code>CacheTransaction</code></a> object's associated 
                <a class="dfnref" href="#cache-transaction">cache transaction</a>.
              </dd>
              <dt><dfn id="abort"><code>abort()</code></dfn></dt>
              <dd>
                When called, this method must immediately return and asynchronously 
                perform the steps in the 
                <a href="#cache-transaction-abort" class="dfnref">cache transaction
                abort process</a> with the first argument being this 
                <a href="#CacheTransaction" class="dfnref">
                <code>CacheTransaction</code></a> object's associated 
                <a class="dfnref" href="#cache-transaction">cache transaction</a>,               
                and the second being the <code>window</code> or 
                <code>worker</code> object.
              </dd>
              <dt><dfn id="commit"><code>commit()</code></dfn></dt>
              <dd>
                When called, this method must immediately return and asynchronously 
                perform the following steps:
                <ol>
                  <li>
                    Execute the <a href="#cache-transaction-commit" class="dfnref">cache
                    transaction commit process</a> with the first argument being this 
                    <a href="#CacheTransaction" class="dfnref">
                    <code>CacheTransaction</code></a> object's associated 
                    <a class="dfnref" href="#cache-transaction">cache transaction</a>,              
                    and the second being the current <code>window</code> or 
                    <code>worker</code> object.
                  </li>
                  <li>
                    If <a href="#oncommitted" class="dfnref"><code>oncommitted</code></a>
                    attribute on this <a href="#CacheTransaction" class="dfnref">
                    <code>CacheTransaction</code></a> object is not null, <span>queue a
                    task</span> to invoke the function identified by 
                    <a href="#oncommitted" class="dfnref"><code>oncommitted</code></a> .                    
                  </li>
                </ol>
              </dd>
              <dt><dfn id="get-item"><code>getItem()</code></dfn></dt>
              <dd>
                This method takes two arguments - a <var>uri</var> and an <var>item 
                callback</var>. When called, this method must immediately return and
                asynchronously perform the following steps:
                <ol>
                  <li>
                    If the resource identified by <var>uri</var> does not exist in this 
                    <a href="#CacheTransaction" class="dfnref"><code>CacheTransaction</code></a>
                    object's associated <a class="dfnref" href="#data-cache">data cache</a>, then
                    the method must raise  
                    <a class="dfnref" href="#data-cache">data cache</a>
                    object, then the method must raise the <code>NOT_FOUND_ERR</code>
                    exception and terminate these steps.
                  </li>
                  <li>
                    Let <var>item</var> be the entity in this
                    <a href="#CacheTransaction" class="dfnref"><code>CacheTransaction</code></a>
                    object's associated <a class="dfnref" href="#data-cache">data cache</a>.
                  </li>
                  <li>
                    Create <var>object</var>, a new <a href="#CacheItem"><code>CacheItem</code></a> 
                    object with the associated <var>item</var>.
                  </li>
                  <li>
                    <span>Queue a task</span> to invoke <var>item callback</var> with the
                    aforementioned <a href="#CacheItem"><code>CacheItem</code></a> <var>object</var>
                    as its only argument.
                  </li>
                </ol>
              </dd>
              <dt><dfn id="oncommitted"><code>oncommitted</code></dfn></dt>
              <dd>
                <p>
                  This attribute, on getting, must return the function to be invoked
                  when this <a href="#CacheTransaction" class="dfnref"><code>
                  CacheTransaction</code></a> object has been committed.
                </p>
                <p>
                  This attribute, on setting, must store the function to be invoked
                  when this <a href="#CacheTransaction" class="dfnref"><code>
                  CacheTransaction</code></a> object has been committed.
                </p>
              </dd>
              <dt><dfn id="item-body"><code>body</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the entity body, if any, as a 
                <code>FileData</code> object <a href="#ref-FileAPI">[FileAPI]</a>, 
                of the <a class="dfnref" href="#managed-resource">managed resource</a> 
                associated with this <a href="#CacheItem" class="dfnref">
                <code>CacheItem</code></a> object.                 
              </dd>
              <dt><dfn id="item-dynamicMethods"><code>dynamicMethods</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the list of protocol methods, 
                if any, of the <a class="dfnref" href="#managed-resource">managed
                resource</a> associated with this <a href="#CacheItem" class="dfnref">
                <code>CacheItem</code></a> object.              
              </dd>
              <dt><dfn id="item-headers"><code>headers</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the headers as a native ordered
                dictionary data type from the 
                <a class="dfnref" href="#managed-resource">managed resource</a> 
                associated with this <a href="#CacheItem" class="dfnref">
                <code>CacheItem</code></a> object. In the JavaScript binding, this must be 
                <code>Object</code>. Each header must have one property (or dictionary
                entry), with those properties enumerating in the order that the headers
                were recorded in the <a class="dfnref" href="#managed-resource">
                managed resource</a>. Each property must have the name of the
                header and its value as recorded in the 
                <a class="dfnref" href="#managed-resource">managed resource</a>.
              </dd>
              <dt><dfn id="item-readyState"><code>readyState</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the current state of the 
                <a class="dfnref" href="#managed-resource">managed resource</a>. This
                must be the appropriate value from the following list: 
                <dl>
                  <dt><dfn id="ready-state-UNCACHED"><code>UNCACHED</code></dfn></dt>
                  <dd>
                    This <a href="#CacheItem" class="dfnref"><code>CacheItem</code></a> 
                    object is associated with a 
                    <a class="dfnref" href="#managed-resource">managed resource</a>
                    which has been added for capturing but has not yet been cached. 
                    There is no value available in <a href="#item-body">body</a>
                    or <a href="#item-headers">headers</a>.
                  </dd>
                  <dt><dfn id="ready-state-FETCHING"><code>FETCHING</code></dfn></dt>
                  <dd>
                    This <a href="#CacheItem" class="dfnref"><code>CacheItem</code></a> 
                    object is associated with a 
                    <a class="dfnref" href="#managed-resource">managed resource</a>
                    which is currently being fetched.
                    There is no value available in <a href="#item-body">body</a>
                    or <a href="#item-headers">headers</a>.
                  </dd>
                  <dt><dfn id="ready-state-CACHED"><code>CACHED</code></dfn></dt>
                  <dd>
                    This <a href="#CacheItem" class="dfnref"><code>CacheItem</code></a> 
                    object is associated with a 
                    <a class="dfnref" href="#managed-resource">managed resource</a>
                    which has been cached.
                  </dd>
                  <dt><dfn id="ready-state-GONE"><code>GONE</code></dfn></dt>
                  <dd>
                    This <a href="#CacheItem" class="dfnref"><code>CacheItem</code></a> 
                    object is associated with a 
                    <a class="dfnref" href="#managed-resource">managed resource</a>
                    which has been released. There is no value available in 
                    <a href="#item-body">body</a>, <a href="#item-headers">headers</a>, or 
                    <a href="#item-dynamicMethods">dynamicMethods</a>.
                  </dd>
                </dl>
              </dd>
            </dl>
        
            <p>
              For both <code>capture()</code> methods, <var>dynamic methods</var> 
              is a comma separated list of protocol methods that can be intercepted
              for local processing. An empty string is allowed for this parameter.
            </p>
          </div>          
          
          <div id="events-and-error" class="section">
            <h4>4.2.8. The <a class="idlref" href="#CacheEvent"><code>CacheEvent</code></a></h4>
            <p>
              The <span>task source</span> for this task is the <span>networking 
              task source</span>.
            </p>
            
            <p>
              If the event being fired is 
              <a href="#event-fetching"><code>fetching</code></a>,
              <a href="#event-captured"><code>captured</code></a>, or
              <a href="#event-released"><code>released</code></a>, then the event must
              have its <a href="#event-uri">uri</a> attribute set to the URI of the 
              affected <a class="dfnref" href="#managed-resource">managed resource</a>.
            </p>
            
            <p>
              Otherwise, if the event being fired is 
              <a href="#event-off-line-updating"><code>off-line-updating</code></a>,
              <a href="#event-updating"><code>updating</code></a>, 
              <a href="#event-error"><code>error</code></a>, 
              <a href="#event-obsolete"><code>obsolete</code></a>, or
              <a href="#event-ready"><code>ready</code></a>, then the event must
              have its <a href="#event-uri">uri</a> attribute set to null.
            </p>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="CacheEvent">CacheEvent</dfn> : Event {
  readonly attribute <a href="#DataCache">DataCache</a> <a href="#event-cache">cache</a>;
  readonly attribute DOMString <a href="#event-uri">uri</a>;
  
  void <a href="#initCacheEvent">initCacheEvent</a>(<a href="#DataCache">DataCache</a> cache,
                      in DOMString uri);  
  void <a href="#initCacheEventNS">initCacheEventNS</a>(in DOMString namespaceURI,
                        <a href="#DataCache">DataCache</a> cache,
                        in DOMString uri);
};            
            </code></pre></div></div>
            
            <dl>
              <dt><dfn id="event-cache">cache</dfn></dt>
              <dd>This attribute, on getting, must return a 
              <a class="idlref" href="#DataCache">DataCache</a> object representing 
              the <a class="dfnref" href="#data-cache">data cache</a> on which this event
              is fired.
              </dd>
              <dt><dfn id="event-uri">uri</dfn></dt>
              <dd>This attribute, on getting, must return the URI of the 
              <a class="dfnref" href="#managed-resource">managed resource</a> for which
              this event is fired.
              </dd>
              <dt><dfn id="initCacheEvent">initCacheEvent</dfn> and
              <dfn id="initCacheEventNS">initCacheEventNS</dfn></dt>
              <dd>These methods must initialize the event in a manner analogous to the
              similarly named methods in the DOM Events interfaces. 
              <cite><a href="#ref-DOM3Events">[DOM3Events]</a></cite>
              </dd>
            </dl>
          </div>
        </div>
  
        <div id="local-server" class="section">
          <h3>4.3. Embedded Local Server</h3>
          
          <p>
            <a class="dfnref" href="#embedded-local-server">Embedded local server</a>
            is an application script that generates dynamic responses to resource requests
            without making those requests to the resource host.
          </p>
          
          <p>
            An <dfn id="embedded-local-server">embedded local server</dfn>
            consists of an <dfn id="interceptor">interceptor function</dfn> and
            zero or one <dfn id="reviewer">reviewer function</dfn>.
          </p>
          
          <p>
            An <a class="dfnref" href="#embedded-local-server">embedded local server</a>
            serves requests to resources in its <dfn id="interception-namespace">
            interception namespace</dfn>.
          </p>
          
          <p>
            A <a class="dfnref" href="#cache-host">cache host</a> can be associated with
            zero or more <a class="dfnref" href="#embedded-local-server">embedded local
            servers</a>.
          </p>
          
          <p>
            An resource request issued in a <a class="dfnref" href="#cache-host">cache 
            host</a> can be <dfn id="intercept-request">intercepted</dfn> if the resource is
            in the <a href="#interception-namespace" class="dfnref">interception namespace</a> 
            of an <a class="dfnref" href="#embedded-local-server">embedded local server</a>
            registered in the <span>browsing context</span> of the 
            <a class="dfnref" href="#cache-host">cache host</a> and the resource is a
            <a class="dfnref" href="#dynamic-entry">dynamic entry</a> in the
            <a class="dfnref" href="#effective-data-cache">effective data cache</a>
            of some <a class="dfnref" href="#data-cache-group">data cache group</a>
            associated with the <a class="dfnref" href="#cache-host">cache host</a>
            and the request method is identified as a dynamic method in the 
            <a class="dfnref" href="#dynamic-entry">dynamic entry</a>. 
          </p>
          
          <p>
            If an <a class="dfnref" href="#embedded-local-server">embedded local server</a>
            can <a href="#intercept-request" class="dfnref">intercept a resource request</a>, 
            then it is called a <dfn id="candidate-server">candidate local server</dfn> for
            that request. 
          </p>
          
          <p>
            Multiple <a class="dfnref" href="#embedded-local-server">embedded local servers</a>
            can be the <a class="dfnref" href="#candidate-server">candidate local server</a>
            for a given resource request. If a user agent is to 
            <dfn id="select-local-server">select an embedded local server</dfn> from a list of
            <a class="dfnref" href="#candidate-server">candidate local servers</a> that can
            produce a dynamic representation of the requested resource, then the user agent
            must use the <a class="dfnref" href="#embedded-local-server">embedded local 
            server</a> that has the most specific 
            <a class="dfnref" href="#interception-namespace">interception namespace</a>.
          </p>
          <div id="request-interface" class="section">
            <h4>4.3.1. Local Server API</h4>     
          
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Supplemental, NoInterfaceObject]
interface <dfn id="NavigatorLocalServer">NavigatorLocalServer</dfn> {
  void <a href="#registerOfflineHandler">registerOfflineHandler</a>(in DOMString namespace, 
                       <a href="#InterceptHandler">InterceptHandler</a> intercept, 
                       <a href="#ReviewHandler">ReviewHandler</a> review);
};

<span>Navigator</span> implements <a href="#NavigatorLocalServer">NavigatorLocalServer</a>;

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="InterceptHandler">InterceptHandler</dfn> {
  void callback(in <a href="#HttpRequest">HttpRequest</a> request,
                in <a href="#MutableHttpResponse">MutableHttpResponse</a> response);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="ReviewHandler">ReviewHandler</dfn> {
  void callback(in <a href="#HttpRequest">HttpRequest</a> request,
                in <a href="#HttpResponse">HttpResponse</a> response);
};

interface <dfn id="HttpRequest">HttpRequest</dfn> {
  // properties
  readonly attribute DOMString <a href="#request-method">method</a>;
  readonly attribute DOMString <a href="#request-target">target</a>;
  readonly attribute DOMString <a href="#request-bodyText">bodyText</a>;
  readonly attribute any <a href="#request-headers">headers</a>;
};

interface <dfn id="MutableHttpResponse">MutableHttpResponse</dfn> {
  void <a href="#response-setStatus">setStatus</a>(in unsigned short code, in DOMString message);
  void <a href="#response-setResponseText">setResponseText</a>(in DOMString text);
  void <a href="#response-setResponseHeader">setResponseHeader</a>(in DOMString name, in DOMString value);
  void <a href="#response-send">send</a>();
};

interface <dfn id="HttpResponse">HttpResponse</dfn> {
  // properties
  readonly attribute unsigned short <a href="#response-statusCode">statusCode</a>;
  readonly attribute DOMString <a href="#response-statusMessage">statusMessage</a>;
  readonly attribute DOMString <a href="#response-bodyText">bodyText</a>;
  readonly attribute any <a href="#response-headers">headers</a>;
};</code></pre></div></div>
            </div>
            
            <p>
              The <code>navigator.<dfn id="registerOfflineHandler">registerOfflineHandler</dfn>()</code> 
              method takes two or three arguments
              - a <var>uri</var> for identifying the namespace of resources that are to
              be intercepted, an <var>intercept handler</var> function, and an optional
              <var>review handler</var> function. This method allows applications to
              register themselves as possible handlers for particular URI namespaces.
              Upon being invoked, this method should create a new 
              <a class="dfnref" href="#embedded-local-server">embedded local server</a> called
              <var>server</var> with its <a class="dfnref" href="#interceptor">interceptor 
              function</a> set to <var>intercept handler</var> and its 
              <a class="dfnref" href="#reviewer">reviewer function</a> set to <var>review 
              handler</var> and add <var>server</var> to the 
              <a class="dfnref" href="#cache-host">cache host</a>.
            </p>
            
            <p>
              The user agent must invoke the 
              <a class="idltype" href="#InterceptHandler"><code>InterceptHandler</code></a>,
              with an <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a>
              object <var>request</var> based on the application's resource request and an 
              <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a>
              object <var>response</var>. When the <a class="idlref" href="#response-send">
              <code>send()</code></a> method is invoked on <var>response</var>, the
              user agent must respond to <var>request</var> with the headers, body, and
              status specified in <var>response</var>.
            </p>
            
            <p>
              The user agent must invoke the 
              <a class="idltype" href="#ReviewHandler"><code>ReviewHandler</code></a>,
              with an <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a>
              object <var>request</var> based on the application's resource request and an 
              <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a>
              object <var>response</var> based on the host's response to that request. 
            </p>
            
            <p>
              The following attributes are available on the 
              <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a> object:
            </p>
            <dl>
              <dt><dfn id="request-method"><code>method</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the HTTP method, 
                in upper-case characters, present on this 
                <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a> object.
              </dd>
        
              <dt><dfn id="request-target"><code>target</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the URI of this 
                <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a> object.
              </dd>
              
              <dt><dfn id="request-bodyText"><code>bodyText</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the entity body of this 
                <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a>
                object, if the body has a <code>Content-Type</code> of either
                <code>text/*</code> or <code>application/xml</code>.
              </dd>
              
              <dt><dfn id="request-headers"><code>headers</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the headers as a native ordered
                dictionary data type from this 
                <a class="idltype" href="#HttpRequest"><code>HttpRequest</code></a> object. 
                In the JavaScript binding, this must be 
                <code>Object</code>. Each header must have one property (or dictionary
                entry), with those properties enumerating in the order that the headers
                were present in the request. Each property must have the name of the
                header and its value as present in the request.
              </dd>
            </dl>
            
            <p>
              The following methods are available on the 
              <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a> object:
            </p>
            <dl>
              <dt><dfn id="response-setResponseHeader"><code>setResponseHeader()</code></dfn></dt>
              <dd>
                This method takes two arguments - <var>name</var> and <var>value</var>  
                of a response header. Upon calling, this method must store the header
                with <var>name</var> and <var>value</var> in this 
                <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a>
                object. If a value is already associated with this header, then
                this method must append <var>value</var> to it.
              </dd>
        
              <dt><dfn id="response-setStatus"><code>setStatus()</code></dfn></dt>
              <dd>
                This method takes two arguments - <var>code</var> and <var>message</var>
                of the response status. Upon calling, this method must store the status
                with <var>code</var> and <var>message</var> in this 
                <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a>
                object, replacing any previous values for both.
              </dd>
              
              <dt><dfn id="response-setResponseText"><code>setResponseText()</code></dfn></dt>
              <dd>
                This method takes a single arguments - <var>body</var> of the response entity.
                Upon calling, this method must store the entity <var>body</var> in this 
                <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a>
                object, replacing any previous value.
              </dd>
              
              <dt><dfn id="response-send"><code>send()</code></dfn></dt>
              <dd>
                Upon calling, this method must dispatch this 
                <a class="idltype" href="#MutableHttpResponse"><code>MutableHttpResponse</code></a>
                object. No further changes must be allowed to it. 
              </dd>
            </dl>
            
            <p>
              The following attributes are available on the 
              <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a> object:
            </p>
            <dl>
              <dt><dfn id="response-statusCode"><code>statusCode</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the status code of this 
                <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a>
                object.
              </dd>
        
              <dt><dfn id="response-statusMessage"><code>statusMessage</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the status message of this 
                <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a>
                object.
              </dd>
              
              <dt><dfn id="response-bodyText"><code>bodyText</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the entity body of this 
                <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a> 
                object, if the body has a <code>Content-Type</code> of either
                <code>text/*</code> or <code>application/xml</code>.
              </dd>
              
              <dt><dfn id="response-headers"><code>headers</code></dfn></dt>
              <dd>
                This attribute, on getting, must return the headers as a native ordered
                dictionary data type from this 
                <a class="idltype" href="#HttpResponse"><code>HttpResponse</code></a> object. 
                In the JavaScript binding, this must be 
                <code>Object</code>. Each header must have one property (or dictionary
                entry), with those properties enumerating in the order that the headers
                were present in the response. Each property must have the name of the
                header and its value as present in the response.
              </dd>
            </dl>
          </div>
      
          <div class="section" id="networking-model-changes">
            <h4>4.3.2. Changes to the networking model</h4>
            
            <p>
              When a <a class="dfnref" href="#cache-host">cache host</a> is associated 
              with one or more <a class="dfnref" href="#effective-data-cache">effective 
              data caches</a>, any and all loads for resources related to that
              <a href="#cache-host">cache host</a> other than those for 
              <span>child browsing contexts</span> must go through the
              following steps instead of immediately invoking the mechanisms
              appropriate to that resource's scheme:
            </p>

            <ol>
              <li>
                Let <var>request</var> be the resource request for fetching the resource.
              </li>
              <li>
                If <var>request</var> includes the HTTP header <code>X-Bypass-DataCache</code>
                and the value of that header is <code>true</code>, then fetch the resource
                normally, and abort these steps.
              </li>
              <li>
                Let <var>caches</var> be the set of all 
                <a class="dfnref" href="#effective-data-cache">effective data caches</a>
                for the <a class="dfnref" href="#cache-host">cache host</a>.
              </li>
              <li>
                Let <var>resource</var> be the resource to be fetched.
              </li>
              <li>
                If <var>resource</var> is not <a href="#managed-resource">managed</a> in 
                <var>caches</var>, then fetch a representation of <var>resource</var> 
                normally and abort these steps.
              </li>
              <li>
                <a class="dfnref" href="#select-data-cache">Select a data cache</a> 
                <var>cache</var> from <var>caches</var>.
              </li>
              <li>
                If <var>request</var> is using the HTTP <code>GET</code> mechanism
                and <var>resource</var> is not defined in <var>cache</var> with a 
                <a class="dfnref" href="#dynamic-protocol-method">dynamic <code>GET</code> 
                method</a>, then get the entity for <var>resource</var> from the cache
                (instead of fetching it), and abort these steps.
              </li>
              <li>
                If <var>request</var> is using the HTTP <code>HEAD</code> mechanism
                and <var>resource</var> is not defined in <var>cache</var> with a 
                <a class="dfnref" href="#dynamic-protocol-method">dynamic <code>HEAD</code> 
                method</a>, then get the entity headers for <var>resource</var> from the cache
                (instead of fetching it), and abort these steps.
              </li>
              <li>
                If <var>resource</var> is not defined in <var>cache</var> with the 
                <a class="dfnref" href="#dynamic-protocol-method">dynamic method</a> that
                <var>request</var> is using, then fetch a representation of 
                <var>resource</var> normally and abort these steps.
              </li>
              <li>
                Pick the appropriate steps:
                <dl class="switch">
                  <dt>If the user agent is off-line</dt>
                  <dd><ol>
                      <li>
                        <a href="#select-local-server" class="dfnref">Select an embedded 
                        server</a> <var>server</var> to produce an off-line response.
                      </li>
                      <li>
                        Create a new response object to hold the dynamic response to 
                        <var>request</var>.
                      </li>
                      <li>
                        Call the <a href="#interceptor" class="dfnref">interception function</a>
                        of <var>server</var> passing as arguments <var>request</var> and
                        <var>response</var>.
                      </li>
                      <li>
                        Wait for the <a href="#interceptor" class="dfnref">interception
                        function</a> to dispatch the dynamic response.
                      </li>
                      <li>
                        Handle <var>response</var> as the dynamic response, and abort
                        these steps.
                      </li>
                  </ol></dd>
                  <dt>If the user agent is online</dt>
                  <dd><ol>
                      <li>
                        <a href="#select-local-server" class="dfnref">Select an embedded 
                        server</a> <var>server</var> to review the online response.
                      </li>
                      <li>
                        Fetch a representation of <var>resource</var> normally and call it
                        <var>response</var>. 
                      </li>
                      <li>
                        Call the <a href="#reviewer" class="dfnref">reviewer function</a>
                        of <var>server</var> passing as arguments <var>request</var> and
                        <var>response</var>.
                      </li>
                      <li>
                        Handle <var>response</var> as the dynamic response, and abort
                        these steps.
                      </li>
                  </ol></dd>
                </dl>
              </li>
              <li>Fail the resource load.</li>
            </ol>
          </div>
        </div>
      </div>
      <div id="security" class="section">
        <h2>5. Security Considerations</h2>
        
        <p>
          Apart from requirements affecting security made throughout
          this specification implementations may, at their discretion,
          not expose certain headers, such as HttpOnly cookies. 
        </p>
  
        <p>
          Applications need to verify the identity of their users before
          allowing access to <a class="dfnref" href="#private">private resources</a> they
          manage. Typically a host verifies the identity of its users by
          checking whether the user possesses valid credentials including a
          shared secret, e.g., a password. Applications design their own user
          interface to provide a means for users to supply their credentials
          for authentication. In Web applications, this is typically performed
          using HTML forms and it provides applications with a great deal of
          control over the authentication user interface. Also, applications
          typically do not verify the user's credentials for every request. 
          Instead, applications verify a token stored on the client as a result
          of authentication. This token is a session identifier often stored in
          an HTTP cookie <cite><a href="#ref-RFC2965">[RFC2965]</a></cite>.
          This approach is highly scalable since just the session identifier
          and not credentials are validated for every HTTP request. Use of
          session identifiers gives the data source wide latitude over
          terminating the authorization and restricting access to certain
          scopes. It also allows users to share authorization but not their
          credentials with a variety of less-trustworthy applications.
        </p>
        
        <p>
          The token approach also enables off-line authentication without
          storing any credentials locally. The token produced by the host is
          used by BITSY to authenticate requests served locally and for
          capturing resources from the host. If a data cache is to store
          <a class="dfnref" href="#private">private resources</a>, it must be
          <a href="#data-cache">created with a cookie name</a>. Once such a
          data cache is created, the user agent must serve or intercept requests
          to its captured resources only if the cookie used to secure the cache
          is still present in the current browsing context. 
        </p>
        <p>
          Failing this, the user agent must make the request to the host as
          would be the case if the resource were not captured locally. If the
          user agent receives an HTTP 401 status from a host while capturing a
          resource using a required cookie, then it must automatically destroy
          the data cache originating that capture attempt.
        </p>
      </div>
    </div>

    <div id="appendices">
      <div id="references" class="section">
        <h2>A. References</h2>

        <div id="normative-references" class="section">
          <h3>A.1. Normative references</h3>

          <dl>
            <dt><dfn id="ref-DOM3Core">[DOM3Core]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/DOM-Level-3-Core/">Document Object Model (DOM) Level 3 Core Specification</a></cite>, 
              A. Le Hors (eds.), et al. W3C, April 2004.
            </dd>
            <dt><dfn id="ref-DOM3Events">[DOM3Events]</dfn></dt>
            <dd>
              <cite><a href="http://dev.w3.org/2006/webapi/DOM-Level-3-Events/html/DOM3-Events.html">Document
              Object Model (DOM) Level 3 Events Specification</a></cite>,
              D. Schepers. W3C, July 2009.
            </dd>
            <dt><dfn id="ref-FileAPI">[FileAPI]</dfn></dt>
            <dd>
              <cite><a href="http://dev.w3.org/2006/webapi/FileUpload/publish/FileAPI.html">File API</a></cite>,
              Arun Ranganathan, editor. W3C Editor's Draft, August 2009.
            </dd>
            <dt><dfn id="ref-RFC2119">[RFC2119]</dfn></dt>
            <dd>
              <cite><a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a></cite>,
              S. Bradner. IETF, March 1997.
            </dd>
            <dt><dfn id="ref-RFC2616">[RFC2616]</dfn></dt>
            <dd>
              <cite><a href="http://tools.ietf.org/html/rfc2616">Hypertext transfer protocol -- HTTP 1.1</a></cite>,
              R. Fielding et al. IETF RFC 2616, June 1999.
            </dd>
            <dt><dfn id="ref-RFC2965">[RFC2965]</dfn></dt>
            <dd>
              <cite><a href="http://tools.ietf.org/html/rfc2965">HTTP State Management Mechanism</a></cite>,
              D. Kristol and L. Montulli. IETF, October 2000.
            </dd>
            <dt><dfn id="ref-WebIDL">[WebIDL]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/WebIDL/">Web IDL</a></cite>,
              Cameron McCormack, editor. W3C Working Draft, December 2008.
            </dd>
            <dt><dfn id="ref-WebWorkers">[WebWorkers]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/workers/">Web Workers</a></cite>,
              Ian Hickson, editor. W3C Working Draft, April 2009.
            </dd>
          </dl>
        </div>

        <div id="informative-references" class="section">
          <h3>A.2. Informative references</h3>

          <dl>
            <dt><dfn id="ref-XMLHttpRequest">[XMLHttpRequest]</dfn></dt>
            <dd>
                <cite><a href="http://www.w3.org/TR/XMLHttpRequest/">The XMLHttpRequest Object</a></cite>,
              A. van Kesteren. W3C Working Draft, 15 April 2008.
            </dd>
            <dt><dfn id="ref-HTML5">[HTML5]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/html5/">HTML5: A vocabulary and associated APIs for HTML and XHTML</a></cite>, 
              Ian Hickson, editor, W3C Working Draft, April 2009.
            </dd>          
          </dl>
        </div>
        
      </div>
      
      <div class="section" id="acknowledgements">
        <h2>B. Acknowledgements</h2>
        <div>
          Thanks to Garret Swart, Colm Divilly, Ashish Motivala for their useful comments that 
          have led to improvements to this specification over time.
        </div>
      </div>
    </div>
  </body>
</html>
