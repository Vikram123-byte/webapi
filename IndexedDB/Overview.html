<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
  Overview.html
  WebSimpleDB 

  Note: This file is generated from Overview.xml.  Run "make" to regenerate it.
  -->

<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>WebSimpleDB API</title>
    <meta name="revision" content="$Id: Overview.html,v 1.13 2009-10-26 23:16:25 nmehta3 Exp $" />
    <link rel="stylesheet" href="SimpleDB.css" type="text/css" />
    <script src="section-links.js" type="application/ecmascript"></script>
    <script src="dfn.js" type="application/ecmascript"></script>
    <!--[if IE]>
    <style type='text/css'>
      .ignore {
        -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
        filter: alpha(opacity=50);
      }
    </style>
    <![endif]-->
    <style type="text/css">
      table {
        border-collapse: collapse;
        border-style: hidden hidden none;
      }
      table thead {
        border-bottom: medium solid;
      }
      table td, table th {
        border-bottom: thin solid;
        border-left: medium solid;
        border-right: medium solid;
        padding: 0.2em;
        vertical-align: top;
      }
    </style>

    
  <link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-ED" type="text/css" /></head>

  <body>
    <div class="head"><div><a href="http://www.w3.org/"><img src="http://www.w3.org/Icons/w3c_home" width="72" height="48" alt="W3C" /></a></div><h1>WebSimpleDB API</h1><h2>W3C Editor’s Draft <em>7 October 2009</em></h2><dl><dt>Latest Published Version:</dt><dd><a href="http://www.w3.org/TR/WebSimpleDB/">http://www.w3.org/TR/WebSimpleDB/</a></dd><dt>Latest Editor’s Draft:</dt><dd><a href="http://dev.w3.org/2006/webapi/WebSimpleDB/">http://dev.w3.org/2006/webapi/WebSimpleDB/</a></dd><dt>Previous Version:</dt><dd><a href="http://www.w3.org/TR/2009/WD-WebSimpleDB-20090929/">http://www.w3.org/TR/2009/WD-WebSimpleDB-20090929/</a></dd><dt>Editor:</dt><dd><a href="http://o-micron.blogspot.com/">Nikunj R. Mehta</a>, Oracle Corp &lt;nikunj.mehta@oracle.com&gt;</dd></dl><p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy;  <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>&reg;</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.org/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p></div><hr />

    <div class="section">
      <h2 id="abstract">Abstract</h2>
      <p>
        This document defines APIs for storing and retrieving ordered key-value pairs in a transactional database.
      </p>
    </div>

    <div class="section">
      <h2 id="status-of-this-document">Status of this Document</h2>
      <p><em>
        This section describes the status of this document at the time of
        its publication.  Other documents may supersede this document. A list
        of current W3C publications and the latest revision of this technical
        report can be found in the <a href="http://www.w3.org/TR/">W3C technical
          reports index</a> at http://www.w3.org/TR/.
      </em></p><p>
        This document is the 7 October 2009 <b>Editor’s Draft</b> of the
        <cite>WebSimpleDB API</cite> specification.
      
      If you wish to make comments regarding this document, please send them to
      <a href="mailto:public-webapps@w3.org?subject=[WebSimpleDB]">public-webapps@w3.org</a>
      (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>)
      with “[WebSimpleDB]” at the start of the subject line,
      or submit them using our <a href="http://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsWG&amp;component=WebSimpleDB">public bug database</a>.
    </p>
      <p>
        The latest stable version of the editor's draft of this specification is always available on the W3C CVS server. Change tracking for this document is available at the following location:
      </p>
      <ul>
        <li>
          CVS log: <a href="http://dev.w3.org/cvsweb/2006/webapi/WebSimpleDB/Overview.html">http://dev.w3.org/cvsweb/2006/webapi/WebSimpleDB/Overview.html</a>
        </li>
      </ul>
      <p>
        The 
        <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>, is the W3C Working Group responsible for this specification's progress along the W3C Recommendation track.
      </p>
      <p>
        This is one of the proposals being considered for standardization in the
        area of local, persistent storage in user agents.
      </p>
      <p>
          Publication as an Editor’s Draft does not imply endorsement by the
          W3C Membership.  This is a draft document and may be updated, replaced
          or obsoleted by other documents at any time. It is inappropriate to cite
          this document as other than work in progress.
        </p><p>
      This document was produced by a group operating under the
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February
        2004 W3C Patent Policy</a>. W3C maintains a
      <a href="http://www.w3.org/2004/01/pp-impl/42538/status">public list of
        any patent disclosures</a> made in connection with the deliverables of
      the group; that page also includes instructions for disclosing a patent.
      An individual who has actual knowledge of a patent which the individual
      believes contains
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
        Claim(s)</a> must disclose the information in accordance with
      <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
        6 of the W3C Patent Policy</a>.
    </p>
    </div>

    <div id="toc">
      <h2>Table of Contents</h2>
      <div class="toc"><ul><li><a href="#introduction">1. Introduction</a></li><li><a href="#conformance">2. Conformance Requirements</a><ul><li><a href="#dependencies">2.1. Dependencies</a></li></ul></li><li><a href="#database-api">3. Simple Database API</a><ul><li><a href="#database">3.1. Database</a></li><li><a href="#sync-database">3.2. Synchronous APIs</a><ul><li><a href="#opening-sync">3.2.1. Opening databases</a></li><li><a href="#upgrading-sync">3.2.2. Upgrading databases</a></li><li><a href="#entity-store-sync">3.2.3. Entity Store</a></li><li><a href="#index-sync">3.2.4. Index</a></li><li><a href="#cursor-sync">3.2.5. Cursor</a></li><li><a href="#entity-join-sync">3.2.6. Entity Join</a></li><li><a href="#sequence-sync">3.2.7. Sequence</a></li><li><a href="#queue-sync">3.2.8. Queue</a></li><li><a href="#transaction-sync">3.2.9. Transaction</a></li></ul></li><li><a href="#async-api">3.3. Asynchronous APIs</a><ul><li><a href="#events">3.3.1. Event summary</a></li><li><a href="#opening">3.3.2. The DatabaseRequest Interface</a></li><li><a href="#entity-store">3.3.3. Entity Store</a></li><li><a href="#index">3.3.4. Index</a></li><li><a href="#cursor">3.3.5. Cursor</a></li><li><a href="#sequence">3.3.6. Sequence</a></li><li><a href="#queue">3.3.7. Queue</a></li><li><a href="#transaction">3.3.8. Transaction</a></li><li><a href="#event-handler">3.3.9. Events</a></li></ul></li><li><a href="#algorithms">3.4. Algorithms</a><ul><li><a href="#insertion">3.4.1. Insertion steps</a></li><li><a href="#retrieval">3.4.2. Retrieval steps</a></li><li><a href="#deletion">3.4.3. Deletion steps</a></li></ul></li><li><a href="#database-exception">3.5. Exceptions and Errors</a></li></ul></li><li><a href="#privacy">4. Privacy</a><ul><li><a href="#user-tracking">4.1. User tracking</a></li><li><a href="#cookie-resurrection">4.2. Cookie resurrection</a></li><li><a href="#sensitivity-of-data">4.3. Sensitivity of data</a></li></ul></li><li><a href="#authorization">5. Authorization</a><ul><li><a href="#dns-spoofing-attacks">5.1. DNS spoofing attacks</a></li><li><a href="#cross-directory-attacks">5.2. Cross-directory attacks</a></li><li><a href="#implementation-risks">5.3. Implementation risks</a></li></ul></li></ul><ul><li><a href="#references">A. References</a><ul><li><a href="#normative-references">A.1. Normative references</a></li></ul></li><li><a href="#requirements">B. Requirements</a></li></ul></div>
    </div>

    <div id="sections">
      <div id="introduction" class="section">
        <h2>1. Introduction</h2>

        <p class="norm">This section is non-normative.</p>
        
        <p>
          User agents need to store large numbers of objects locally in
          order to satisfy off-line data requirements of Web applications.
          <cite><a href="#ref-WebStorage">[WebStorage]</a></cite> is useful for
          storing pairs of keys and their corresponding values. However, it does 
          not provide in-order retrieval of keys, efficient searching over
          values, or storage of duplicate values for a key. 
        </p>
        
        <p>
          This specification provides a concrete API to perform advanced key-value data management
          that is at the heart of most sophisticated query processors. It does
          so by using transactional databases to store keys and their 
          corresponding values (one or more per key), and providing a means
          of traversing keys in a deterministic order. This is often implemented
          through the use of persistent B-tree data structures that are considered
          efficient for insertion and deletion as well as in-order traversal of
          very large numbers of data items.
        </p>
        
        <div class="example"><div class="exampleHeader">Example</div>
          <p>
            A script can efficiently find items in an entity store that come 
            closest to the required value provided the value is stored in either 
            a primary or a secondary key.
            In the following example, the 'books' entity store holds data about
            books which are stored by their 'isbn' attribute. Additionally, 
            an index is maintained on the 'author' attribute of the objects
            stored in the entity store. This index can be used to look up books
            for a given author. If an exact match is not found, the next
            matching author is located.
          </p>
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var upgrade = 
  function(txn, db) {
    txn.<a href="#create-entity-store">createEntityStore</a>('books', 'isbn');
    txn.<a href="#create-index">createIndex</a>('BookAuthor', 'books', 'author', Index.MANY_TO_ONE);
    // now db.<a href="#version">version</a> === '1.0'
  };
var db = new <a href="#DatabaseSync">DatabaseSync</a>('books', '1.0', 'Book store', upgrade);
var index = db.<a href="#sync-get-index">getIndex</a>('books', 'BookAuthor', true);
var matching = index.<a href="#sync-index-get">get</a>(author);
if (matching)
  report(matching.isbn, matching.name, matching.author);
else
  report(null);</code></pre></div></div>
          <p>
          Here is an example of a script using this API. First, a function
          <code>prepareDatabase()</code> is defined. This function tries to create 
          the database if necessary, giving it one entity store called "docids" with
          two columns ("id" and "name"). If it is successful, or if the table
          doesn't need creating, it calls the function that does the
          actual work, in this case <code>showDocCount()</code>.
          </p>
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var request = null;
function prepareDatabase(ready, error) {
  request = new <a href="#DatabaseRequest">DatabaseRequest</a>();
  request.<a href="#handler-request-onsuccess">onsuccess</a> = ready;
  request.<a href="#handler-request-onerror">onerror</a> = error;
  var upgrade = 
    function(txn, db) {
      txn.<a href="#create-entity-store">createEntityStore</a>('docids', 'id');
      // now db.<a href="#version">version</a> === '1.0'
    };
  request.<a href="#database-open">open</a>('documents', '1.0', 'Offline document storage', upgrade);
}

function showDocCount(db, span) {
  var storeRequest = new <a href="#EntityStoreRequest">EntityStoreRequest</a>(db);
  storeRequest.<a href="#handler-request-onsuccess">onsuccess</a> = 
    function() {
      var store = storeRequest.<a href="#request-store">store</a>, total = 0;
      var cursorRequest = new <a href="#CursorRequest">CursorRequest</a>(store);
      cursorRequest.<a href="#handler-request-oncomplete">oncomplete</a> = 
        function() {
          span.textContent = total;
        };
      cursorRequest.<a href="#cursor-open">open</a>(function(item, cursor) { 
          total += cursor.<a href="#count">count</a>; 
        }, <a href="#Cursor">Cursor</a>.<a href="#NEXT_NO_DUP">NEXT_NO_DUPLICATE</a>);
    };
  storeRequest.<a href="#entity-store-open">open</a>('docids', true);
};

prepareDatabase(function(evt) {
  // got database
  var span = document.getElementById('doc-count');
  showDocCount(request.<a href="#request-database">database</a>, span);
}, function (evt) {
  // error getting database
  alert(evt.error.message);
});</code></pre></div></div>
        </div>
        
        <div class="note"><div class="noteHeader">Note</div>
          This specification is one of the proposals being considered by the
          WebApps WG for client-side data storage.
        </div>
      </div>

      <div id="conformance" class="section">
        <h2>2. Conformance Requirements</h2>

        <p>
          Everything in this specification is normative except for diagrams,
          examples, notes and sections marked as being informative.
        </p>
        <p>
          The keywords “<span class="rfc2119">MUST</span>”,
          “<span class="rfc2119">MUST NOT</span>”,
          “<span class="rfc2119">REQUIRED</span>”,
          “<span class="rfc2119">SHALL</span>”,
          “<span class="rfc2119">SHALL NOT</span>”,
          “<span class="rfc2119">RECOMMENDED</span>”,
          “<span class="rfc2119">MAY</span>” and
          “<span class="rfc2119">OPTIONAL</span>” in this document are to be
          interpreted as described in
          <cite><a href="http://www.ietf.org/rfc/rfc2119">Key words for use in RFCs to
              Indicate Requirement Levels</a></cite>
          <a href="#ref-RFC2119">[RFC2119]</a>.
        </p>
        <p>
          This specification defines one class of products:
        </p>
        <dl>
          <dt><dfn id="dfn-conforming-user-agent">Conforming user agent</dfn></dt>
          <dd>
            <p>
              A user agent must behave as described in this specification
              in order to be considered conformant.
            </p>
            
            <p>
              User agents may implement algorithms given in this
              specification in any way desired, so long as the end result is
              indistinguishable from the result that would be obtained by the
              specification's algorithms.
            </p>
            
            <p>
              A conforming WebSimpleDatabase user agent must also be a
              <em>conforming implementation</em> of the IDL fragments
              of this specification, as described in the
              “Web IDL” specification. <cite><a href="#ref-WebIDL">[WEBIDL]</a></cite>
            </p>
            
            <div class="note"><div class="noteHeader">Note</div>
              This specification uses both the terms "conforming user agent(s)" 
              and "user agent(s)" to refer to this product class.
            </div>
          </dd>
        </dl>        
        
        <div class="section" id="dependencies">
          <h3>2.1. Dependencies</h3>
          <p>
            This specification relies on several other underlying specifications. 
          </p>
          <dl>
            <dt>HTML5</dt>
            <dd>The terms and algorithms <dfn id="document-base-url">document base URL</dfn>,
              <dfn id="event-handler-attributes">event handler attributes</dfn>, <dfn id="event-handler-event-type">event handler event type</dfn>,
              <dfn id="Function"><code>Function</code></dfn>,
              <dfn id="origin">origin</dfn>, <dfn id="same-origin">same origin</dfn>,
              <dfn id="task">task</dfn>, <dfn id="task-source">task source</dfn>, and
              <dfn id="queue-a-task">queue a task</dfn> are defined by the HTML 5 specification <cite><a href="#ref-HTML5">[HTML5]</a></cite>.
            </dd>
            <dt>WebWorkers</dt>
            <dd>This specification adds capabilities to WebWorkers and uses certain concepts defined in this specification. <cite><a href="#ref-WebWorkers">[WebWorkers]</a></cite></dd>
          </dl>
        </div>
	  </div>
	  
      <div id="database-api" class="section">
        <h2>3. Simple Database API</h2>
        
        <p>
          Each origin has an associated set of databases. Each database has a name
          and a current version. There is no way to enumerate or delete the databases
          available for an origin from this API.
        </p>
        
        <div class="note"><div class="noteHeader">Note</div>
          Each database has one version at a time; a database can't exist in multiple
          versions at once. Versions are intended to allow authors to manage schema
          changes incrementally and non-destructively, and without running the risk
          of old code (e.g. in another browser window) trying to write to a database
          with incorrect assumptions.
        </div>
        
        <div id="database" class="section">
          <h3>3.1. Database</h3>
          <p>
            Two variants of databases are available in this API. The asynchronous 
            version <a class="idltype" href="#Database"><code>Database</code></a>
            is available to both <code>Window</code> and <code>WorkerUtils</code> objects.
            The synchronous version <a class="idltype" href="#DatabaseSync"><code>DatabaseSync</code></a>
            is available only to the <code>WorkerUtils</code> object.
          </p>
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Database">Database</dfn> {
  const unsigned short <a href="#SERIALIZABLE">SERIALIZABLE</a> = 0;
  const unsigned short <a href="#READ_UNCOMMITTED">READ_UNCOMMITTED</a> = 1;
  
  readonly attribute DOMString <a href="#name">name</a>;
  readonly attribute DOMString <a href="#displayName">displayName</a>;  
  readonly attribute DOMString <a href="#version">version</a>;
  readonly attribute <a href="#Transaction">Transaction</a> <a href="#current-transaction">currentTransaction</a>;
  readonly attribute unsigned short <a href="#isolation">isolation</a>;</code></pre></div></div>
          
          <dl>
            <dt><dfn id="name"><code>name</code></dfn></dt>
            <dd>
              On getting, this attribute must return the name of the database.
            </dd>
            <dt><dfn id="displayName"><code>displayName</code></dfn></dt>
            <dd>
              On getting, this attribute must return the display text used for the database.
            </dd>
            <dt><dfn id="version"><code>version</code></dfn></dt>
            <dd>
              On getting, this attribute must return
              the current version of the database (as opposed to the expected version
              of the <a href="#Database"><code>Database</code></a> object).
            </dd>
            <dt><dfn id="current-transaction"><code>currentTransaction</code></dfn></dt>
            <dd>
              On getting, this
              attribute must return a <a href="#Transaction">Transaction</a> object
              corresponding to the transaction that is currently active in this database.
            </dd>
            <dt><dfn id="isolation"><code>isolation</code></dfn></dt>
            <dd>
              On getting, this attribute must return the isolation level of this database.
            </dd>
            <dt><dfn id="SERIALIZABLE"><code>SERIALIZABLE</code></dfn></dt>
            <dd>
              This isolation level is used for exclusive write access to a database object.
              No read lock is permitted when a writer holds a lock. Any number of concurrent
              read locks are permitted. This is the default mode for lock sharing.
            </dd>
            <dt><dfn id="READ_UNCOMMITTED"><code>READ_UNCOMMITTED</code></dfn></dt>
            <dd>
              This isolation level allows a shared read lock to be acquired concurrently
              with an exclusive write lock. 
            </dd>
          </dl>
          <p>
            All strings including the empty string are valid database names. 
            Database names must be compared in a case-sensitive manner.
          </p>
          
          <div class="note"><div class="noteHeader">Note</div>
            Implementations can support this even in environments that only
            support a subset of all strings as database names by mapping
            database names (e.g. using a hashing algorithm) to the supported
            set of names.
          </div>
          
          <p>
            The version that the database was opened with is the expected
            version of this <a class="idltype" href="#Database"><code>Database</code></a> 
            or <a class="idltype" href="#DatabaseSync"><code>DatabaseSync</code></a> 
            object. It can be the empty string, in which case there is no
            expected version — any version is fine.
          </p>
          
          <p>
            User agents are expected to use the display name to optimize
            the user experience.
          </p>
       
        </div>  <!-- Databases -->
        
			  <div id="sync-database" class="section">
          <h3>3.2. Synchronous APIs</h3>
          <p>
            This API can only be used in a Worker 
            <cite><a href="#ref-WebWorkers">[WebWorkers]</a></cite>.
          </p>
          <div id="opening-sync" class="section">
            <h4>3.2.1. Opening databases</h4>
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                In the following example, we open a database synchronously. 
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var db = new <a href="#database-open">DatabaseSync</a>('AddressBook', '1', 'Address Book', function(txn, db) {...});</code></pre></div></div>
            </div>
            <p>
              The synchronous API for databases blocks the calling thread until a
              <a href="#DatabaseSync"><code>DatabaseSync</code></a> object is ready
              to return. Moreover, this API also throws a 
              <a href="#DatabaseException">DatabaseException</a> if an error occurs 
              while the database is being opened.
            </p>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Constructor(in DOMString name, 
               in DOMString version, 
               in DOMString displayName, 
               in optional <a href="#UpgradeCallback">UpgradeCallback</a> upgrade,
               in optional unsigned short isolation)]
interface <dfn id="DatabaseSync">DatabaseSync</dfn> : <a href="#Database">Database</a> {
  <a href="#EntityStoreSync">EntityStoreSync</a> <a href="#sync-get-entity-store">getEntityStore</a>(in DOMString name,
                                 in optional readonly);
  <a href="#IndexSync">IndexSync</a> <a href="#sync-get-index">getIndex</a>(in DOMString name, 
                     in DOMString storeName);
  <a href="#SequenceSync">SequenceSync</a> <a href="#sync-get-sequence">getSequence</a>(in DOMString name);
  <a href="#QueueSync">QueueSync</a> <a href="#sync-get-queue">getQueue</a>(in DOMString name);
  <a href="#TransactionSync">TransactionSync</a> <a href="#sync-transaction">transaction</a>(in optional sequence&lt;any&gt; objects, 
                          in optional unsigned int timeout);
};</code></pre></div></div>  
            <p>
              The <a href="#DatabaseSync"><code>DatabaseSync</code></a> constructor 
              takes the following arguments: a database name, a database version,
              a display name, and optionally an upgrade callback and isolation level.
              When this constructor is invoked, the user agent must run the
              following steps:
            </p>
  
            <ol>
              <li>
                Perform the <a href="#database-open-steps">database opening steps</a>,
                and call its result as <var>result</var>.
              </li>
              <li>
                If the steps were aborted due to an error, then throw a newly constructed
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception with the code of that error and abort these steps.
              </li>
              <li>
                Return <var>result</var>.
              </li>
            </ol>
            
            <p>
              When the user agent is to perform <dfn id="database-open-steps">
              database opening steps</dfn>, with a database name, a database
              version, a display name, and optionally an upgrade callback
              and isolation level, it must perform the following steps
              with all but the first two and the last steps being run atomically:
            </p>
            
            <ol>
              <li>Pick the appropriate steps
                <dl class="switch">
                  <dt>If this method is invoked from an active document</dt>
                  <dd>Let <var>origin</var> be the origin of the active document 
                  from which the method was invoked.</dd>
                  <dt>If this method is invoked from a worker</dt>
                  <dd>Let <var>origin</var> be the origin of the scripts in the worker.</dd>
                </dl>
              </li>
              
              <li>
                If no isolation level is passed to these steps, then use the 
                <a href="#SERIALIZABLE"><code>SERIALIZABLE</code></a> isolation
                level for these steps.
              </li>
              <li>
                If there is already a database with the given name from the origin
                <var>origin</var>, then let <var>db</var> be that database.
              </li>
              
              <li>
                If the database version provided is not the empty string, and
                the <var>db</var>'s version is different than the version provided
                to these steps, then set the <var>needs upgrade</var> flag.
              </li>
              
              <li>
                If no database with the given name from the origin <var>origin</var>
                exists, then 
                  <ol>
                    <li>
                      Create the database <var>db</var> with the name and
                      display name passed to these steps, and let <var>db</var>'s 
                      version be the empty string.
                    </li>
                    <li>
                      Set the <var>needs upgrade</var> flag. 
                    </li>
                  </ol>
              </li>
    
              <li>
                If <var>needs upgrade</var> flag is set and no upgrade callback is passed to 
                these steps, then abort these steps 
                with <code>INVALID_STATE_ERR</code>.
              </li>
              
              <li>Pick the appropriate steps:
                <dl class="switch">
                  <dt>If these steps are performed to synchronously open a database</dt>
                  <dd>
                    Let <var>result</var> be a newly constructed 
                    <a class="idltype" href="#DatabaseSync"><code>DatabaseSync</code></a>
                    object representing <var>db</var> with the isolation level passed
                    to this method.
                  </dd>
                  <dt>If these steps are performed to asynchronously open a database</dt>
                  <dd>
                    Let <var>result</var> be a newly constructed 
                    <a class="idltype" href="#Database"><code>Database</code></a>
                    object representing <var>db</var> with the isolation level passed
                    to this method.                
                  </dd>
                </dl>
                Let <var>result</var> be a newly constructed 
                <a class="idltype" href="#Database"><code>Database</code></a>
                object representing <var>db</var> with the isolation level passed
                to this method.
              </li>
    
              <li>
                If <var>needs upgrade</var> is true, then 
                perform the following steps:
                <ol>
                  <li>
                    Create a transaction for <var>db</var> with an exclusive lock on the database.
                  </li>
                  <li>
                    If a system-level timeout duration is exceeded when 
                    acquiring the lock, then abort these steps 
                    with <a href="#code-timeout"><code>TIMEOUT_ERR</code></a>.              
                  </li>
    
                  <li>
                    Create a new 
                    <a class="idltype" href="#Upgrade"><code>Upgrade</code></a>
                    object called <var>upgrade</var> for the transaction just created.
                  </li>
                  <li>
                    <p>
                      <span>Queue a task</span> to invoke the upgrade callback with <var>upgrade</var>
                      and <var>result</var> as its arguments.
                    </p>
                    <p>
                      If the callback throws an exception, abort these steps with 
                      <a href="#code-unknown"><code>UNKNOWN_ERR</code></a>.
                    </p>
                  </li>
                  <li>
                    Wait for task to be completed.
                  </li>
                  <li>
                    Commit the transaction for <var>upgrade</var>.
                  </li>
                  <li>
                    Store the verson passed to this method in <var>db</var>.
                  </li>
                </ol>
              </li>
              
              <li>
                Return <var>result</var>.
              </li>
            </ol>
            <dl>
              <dt><dfn id="sync-get-entity-store"><code>getEntityStore()</code></dfn></dt>
              <dd>
                <p> 
                  This method returns an 
                  <a class="idltype" href="#EntityStoreSync"><code>EntityStoreSync</code></a> 
                  object to access the objects of the entity store in this database
                  identified by the given name. 
                </p>
                
                <p>
                  If an entity store with the given name, compared in a case-sensitive manner, 
                  does not already exist in the database, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>
              <dt><dfn id="sync-get-index" class="idltype"><code>getIndex()</code></dfn></dt>
              <dd>
                <p>
                  This method returns an 
                  <a class="idltype" href="#IndexSync"><code>IndexSync</code></a> 
                  object representing the named index on the given entity store in this database.
                </p>
        
                <p>    
                  If an index with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>
              <dt><dfn id="sync-get-sequence"><code>getSequence()</code></dfn></dt>
              <dd>
                <p> 
                  This method
                  returns a <a class="idltype" href="#SequenceSync"><code>SequenceSync</code></a> 
                  object to access the items of the sequence in this database identified 
                  by the given name. 
                </p>
                
                <p>    
                  If a sequence with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>            
              </dd>
              <dt><dfn id="sync-get-queue"><code>getQueue()</code></dfn></dt>
              <dd>
                <p> 
                  This method
                  returns a <a class="idltype" href="#QueueSync"><code>QueueSync</code></a> 
                  object to access the items of the queue in this database identified
                  by the given name. 
                </p>
                
                <p>    
                  If a queue with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>            
              </dd>
              <dt><dfn id="sync-transaction"><code>transaction()</code></dfn></dt>
              <dd>
               Perform the <a href="#create-a-transaction-object">transaction creation steps</a>
               with the array of database objects for acquiring locks required in this transaction 
               and an optional timeout duration, and return the resulting 
               <a class="idltype" href="#TransactionSync"><code>TransactionSync</code></a> object.
              </dd>
            </dl>
          </div>
          
          <div id="upgrading-sync" class="section"> 
            <h4>3.2.2. Upgrading databases</h4>            
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                In the following example, a database can be initially setup with an entity
                store where the <em>id</em> property on stored objects is used as the key.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var dbReq = new <a href="#DatabaseRequest">DatabaseRequest</a>();
var upgrade = 
  function(changes, db) {
    changes.<a href="#create-entity-store">createEntityStore</a>('Contact', 'id');
    // after this - db.<a href="#version">version</a> === '1'          
  };
dbReq.<a href="#database-open">open</a>('AddressBook', '1', 'Address Book', upgrade);</code></pre></div></div>
              <p>
                Later this database can be upgraded to add a secondary key 
                for the contact name.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var upgrade = 
  function(changes, db) {
    // db.version === '1'
    changes.<a href="#create-index">createIndex</a>('ContactName', 'Contact', 'name', Index.MANY_TO_ONE);
    // after this - db.<a href="#version">version</a> === '2'
  };
var db = new <a href="#DatabaseSync">DatabaseSync</a>('AddressBook', '2', 'Address Book', upgrade);</code></pre></div></div>
            </div>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Upgrade">Upgrade</dfn> {
  void <a href="#create-entity-store">createEntityStore</a>(in DOMString name, 
                         in DOMString primaryKeyPath, 
                         in optional DOMString sequenceName);
  void <a href="#create-index">createIndex</a>(in DOMString name, 
                   in DOMString storeName,
                   in DOMString keyPath, 
                   in unsigned short cardinality, 
                   in optional unsigned short onRelatedEntityDelete, 
                   in optional DOMString relatedEntity);  
  void <a href="#create-sequence">createSequence</a>(in DOMString name, 
                      in optional long long initial, 
                      in optional long long increment);
  void <a href="#create-queue">createQueue</a>(in DOMString name);                             

  void <a href="#remove-entity-store">removeEntityStore</a>(in DOMString storeName);
  void <a href="#remove-index">removeIndex</a>(in DOMString indexName, in DOMString storeName);
  void <a href="#remove-sequence">removeSequence</a>(in DOMString sequenceName);
  void <a href="#remove-queue">removeQueue</a>(in DOMString queueName);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="UpgradeCallback">UpgradeCallback</dfn> {
  void upgrade(in <a href="#Upgrade">Upgrade</a> txn,
               in <a href="#Database">Database</a> db);
};</code></pre></div></div>
            <dl>
              <dt><dfn id="create-entity-store"><code>createEntityStore()</code></dfn></dt>
              <dd>
                <p> 
                  This method creates a new entity store with the given name. The path of the 
                  primary key in objects stored in this entity store is required to correctly
                  create a unique identifier for each object. This path cannot be the empty string.
                  <!--The empty string is a valid value for this parameter, and it 
                  results in the entire value of objects to be used as the key value. -If a path 
                  is specified and--> If an optional sequence name is also provided, then the named
                  sequence is used to populate a value in the object at the key path and that value
                  is stored as the key value for the object. 
                </p>
                
                <p>    
                  If an entity store with the same name, compared in a
                  case-sensitive manner, already exists, then this method will throw a
                  newly constructed <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a>.
                  If a sequence name is given for generating primary keys but a sequence with
                  that name does not exist, then this method will throw a
                  newly constructed <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>
              
              <dt><dfn id="create-index" class="idltype"><code>createIndex()</code></dfn></dt>
              <dd>
                <p>
                  This method is used to define a new index on this entity store. An index is 
                  created using four required parameters - name, entity store name, key path, 
                  and cardinality - and two optional parameters - action to be performed when 
                  related entity is deleted, and the name of the related entity. 
                </p>
        
                <p>    
                  If an index with the same name, compared in a
                  case-sensitive manner, already exists, then this method will throw a
                  newly constructed <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a>.
                  If the entity store with the given name does not exist, then this method will
                  throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>            
              </dd>
              
              <dt><dfn id="create-sequence"><code>createSequence()</code></dfn></dt>
              <dd>
                <p> 
                  This method creates a new sequence with the given name. The optional 
                  parameters for initial value and increment size are used to create the
                  sequence. If the increment parameter value is 0, then a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code 
                  <a href="#code-data"><code>DATA_ERR</code></a> is 
                  thrown. If a negative value is used, the sequence decrements its values.
                </p>
                
                <p>    
                  If a sequence with the same name, compared in a
                  case-sensitive manner, already exists, then this method will throw a
                  newly constructed <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a>.
                </p>
              </dd>
              
              <dt><dfn id="create-queue"><code>createQueue()</code></dfn></dt>
              <dd>
                <p> 
                  This method creates a new queue with the given name. 
                </p>
                
                <p>    
                  If a queue with the same name, compared in a case-sensitive manner,
                  already exists, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code
                  <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a>.
                </p>
              </dd>
              
              <dt><dfn id="remove-entity-store"><code>removeEntityStore()</code></dfn></dt>
              <dd>
                <p>
                  This method is used to destroy the entity store as well as all associated indices. 
                </p>
                
                <p>    
                  If an entity store with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code 
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>          
  
              <dt><dfn id="remove-index"><code>removeIndex()</code></dfn></dt>
              <dd>
                <p>
                  This method is used to destroy the named index on the given entity store. 
                </p>
                
                <p>    
                  If an index with the given name does not exist on the named entity store, 
                  then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code 
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>          
  
            <!--p> 
              The <dfn id="modify-entity-store"><code>modifyEntityStore()</code></dfn> method
              modifies an existing entity store with the given name and returns a 
              <a class="idltype" href="#EntityStore"><code>EntityStore</code></a> object to 
              access the objects of the modified entity store. The path of the primary key in 
              objects stored in this entity store is modified to the one provided in this call. 
              If this path is different from that currently defined on the entity store, then
              the entity store is reorganized to use the new primary key path. If the entity
              store uses a sequence to generate primary keys, and this call omits the optional 
              sequence name, then the existing sequence is no longer used to populate a value 
              in the object at the key path. If a different sequence is specified, then the
              new sequence is used to generate keys. 
            </p>
            
            <p>    
              If an entity store with the given name, compared in a case-sensitive manner, 
              does not already exist, then this method will throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code 
              <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
            </p-->
              <dt><dfn id="remove-sequence"><code>removeSequence()</code></dfn></dt>
              <dd>
                <p> 
                  This method is used to destroy a sequence.
                </p>
                
                <p>    
                  If a sequence with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code 
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>
              <dt><dfn id="remove-queue"><code>removeQueue()</code></dfn></dt>
              <dd>
                <p> 
                  This method is used to destroy a queue.
                </p>
                
                <p>    
                  If a queue with the given name, compared in a case-sensitive manner, 
                  does not already exist, then this method will throw a newly constructed 
                  <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                  exception with code 
                  <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a>.
                </p>
              </dd>
            </dl>   
          </div>
          <div class="section" id="entity-store-sync">  
            <h4>3.2.3. Entity Store</h4>
            <p>
              An entity store is a persistent structure that holds key-value pairs sorted
              by keys so as to enable fast insertion and look up as well as ordered retrieval.
              The store provides a mechanism by which to read and write stored objects. 
              Operations on an entity store must follow the transaction used to create 
              or obtain the entity store.
            </p>
            
            <p>
              Each <a href="#EntityStore" class="idltype"><code>EntityStore</code></a>
               object provides access to a set of key/value pairs, which are sometimes
               called items. Values can be any data type supported by the 
               <span>structured clone algorithm</span> <cite><a href="#ref-HTML5">[HTML5]</a></cite>. 
               Keys themselves can be of any simple data type. They can be extracted
               from objects being stored or generated from a monotonic sequence.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                In the following example, we set up an entity store to use the 
                property <em>id</em> from objects to store as the key.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var upgrade = function(changes, db) {
                changes.<a href="#create-sequence">createSequence</a>('ContactSeq');
                changes.<a href="#create-entity-store">createEntityStore</a>('Contact', 'id', 'ContactSeq');
              });

var db = new <a href="#DatabaseSync">DatabaseSync</a>('AddressBook', '1', 'Address Book', upgrade);</code></pre></div></div>
              <p>
                Using this database, we can store objects in the <em>Contact</em>
                entity store.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var store = db.<a href="#sync-get-entity-store">getEntityStore</a>('Contact');
function saveContact(contact) {
  var obj = store.<a href="#entity-store-put">put</a>(contact);  
  return obj;
};

var lincoln = {name: 'Lincoln', number: '7012'};
var contact = saveContact(lincoln);
// contact.id === 1</code></pre></div></div>
              <p>
                A stored value can be retrieved using the same key used for storage.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var contact = store.<a href="#entity-store-get">get</a>(1);
// contact.name === 'Lincoln'</code></pre></div></div>
              <p>
                Additionally, all the objects of an entity store matching a certain
                range of secondary or primary keys can be retrieved in key order.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var range = new <a href="#CursorRange">CursorRange</a>(2, 4, <a href="#CursorRange">CursorRange</a>.<a href="#INCLUDE_START">INCLUDE_START</a> &amp; <a href="#CursorRange">CursorRange</a>.<a href="#INCLUDE_START">INCLUDE_END</a>);
var count = store.<a href="#store-for-each">forEach</a>(function(item, cursor) {
              // these are all the contacts     
              // with names whose first letters are either L or M
              }, range);</code></pre></div></div>
            </div>
  			    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="EntityStore">EntityStore</dfn> {  
  readonly attribute DOMString <a href="#entity-store-name">name</a>;
  readonly attribute DOMString <a href="#entity-store-key-path">keyPath</a>;
  readonly attribute DOMStringList <a href="#entity-store-index-names">indexNames</a>;
};

interface <dfn id="EntityStoreSync">EntityStoreSync</dfn> : <a href="#EntityStore">EntityStore</a> {
  unsigned long long <a href="#store-for-each">forEach</a>(in <a href="#CursorCallback">CursorCallback</a> callback,
                             in optional <a href="#CursorRange">CursorRange</a> range, 
                             in optional unsigned short direction);

  any <a href="#entity-store-put">put</a>(in any object);
  <a href="#entity-store-delete">delete</a>(in any key);
  any <a href="#entity-store-get">get</a>(in any key);
};</code></pre></div></div>
        
        <p>
          On getting, <dfn id="entity-store-name"><code>name</code></dfn> will
          provide the name of the entity store.        
        </p>

        <p>
          On getting, <dfn id="entity-store-key-path"><code>keyPath</code></dfn> will
          provide the path of the key used as the primary key of objects stored in this
          entity store. This path can be the empty string if the object value is used
          as the key.
        </p>
        
        <p>
          On getting, <dfn id="entity-store-index-names"><code>indexNames</code></dfn> will
          provide a list of the names of indexes on objects in this entity store.
        </p>
        
        <p>
          The <dfn id="entity-store-put"><code>put()</code></dfn> method is used to 
          store the given object in the entity store. Insert the object by performing the 
          <a href="#insertion-steps">insertion steps</a>.
        </p>

        <p>
          The <dfn id="entity-store-get"><code>get()</code></dfn> method is used to retrieve
          the object associated with the given key in the entity store. The following steps 
          must be run for retrieving the object with the following parameters: <var>key</var>.
        </p>
          
        <ol>
          <li>
            If <var>key</var> is not defined or null, then throw a newly constructed 
            <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
            exception with code
            <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a> and terminate these steps.
          </li>            
          <li>
            Use the <var>key</var> to look up an object in the entity store. Let 
            <var>value</var> be that object.
          </li>
          
          <li>
            If <var>object</var> is not found in the entity store, then throw a newly constructed 
            <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
            exception with code
            <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a> and terminate these steps.
          </li>
        </ol>

        <p>
          The <dfn id="entity-store-delete"><code>delete()</code></dfn> method is used to 
          delete the object associated with the given key in the entity store. Delete the
          object by performing the <a href="#deletion-steps">deletion steps</a>.
        </p>

        <p>    
          If an index with the given name, compared in a case-sensitive manner, 
          already exists, then this method will throw a newly constructed 
          <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
          exception with code
          <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a> and terminate these steps.
        </p>
        
        <p>
          If there are two or more secondary indexes set for an entity store, then 
          sets of objects can be retrieved from it based on the intersection of
          multiple index values using an <a href="#EntityJoin"><code>EntityJoin</code></a> object. 
          The <dfn id="entity-store-join"><code>join()</code></dfn> method is
          used to obtain such an object.
        </p>
            
          </div>
          <div id="index-sync" class="section">  
            <h4>3.2.4. Index</h4>
            <p>
              Usually database objects are retrieved by means of the object's key. However,
              the key used for an object will not always contain the information required
              to provide rapid access to the data that may be needed. 
            </p>
            
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                An object can be retrieved using <em>secondary</em> keys, provided these keys
                are defined for the entity store holding such objects. If the <code>upgrade()</code>
                function above were redefined as below, an index would be maintained
                on the <em>name</em> property of objects in <em>Contact</em>.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var upgrade = function(changes, db) {
                changes.<a href="#create-sequence">createSequence</a>('ContactSeq');
                changes.<a href="#create-entity-store">createEntityStore</a>('Contact', 'id', 'ContactSeq');
                changes.<a href="#create-index">createIndex</a>('ContactName', 'Contact', 'name', Index.MANY_TO_ONE);
              });</code></pre></div></div>
              <p>
                For example, the object with <em>name</em> property value as
                'Lincoln' can be retrieved using this <em>ContactName</em> index.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var index = db.<a href="#sync-get-index">getIndex</a>('ContactName', 'Contact');
var contact = index.<a href="#entity-store-get">get</a>('Lincoln');
// contact.id === 1</code></pre></div></div>              
              <p>
                Additionally, all the objects of an entity store matching a certain
                range of secondary or primary keys can be retrieved in key order.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var range = new <a href="#CursorRange">CursorRange</a>('L', 'M');
var count = index.<a href="#index-for-each">forEach</a>(function(item, cursor) {
              // these are all the contacts     
              // with names whose first letters are either L or M
              }, range);</code></pre></div></div>
            </div>
            
            <p>
              An index can indicate a relationship of objects in one entity store to 
              those in another. A relation has three attributes - the two entities
              that are related and a cardinality.
              Because an <a href="#Index"><code>Index</code></a> object relates two entity
              stores, it is important to consider the consequence of the deletion of
              an object on the related objects. If this is the case, foreign key
              constraints can be used to control data integrity. 
            </p>
            
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                For example, if one entity store holds <em>Contact</em> objects, and
                another holds <em>Account</em> objects, such that each <em>Account</em> 
                object holds a key to one <em>Contact</em> object. In this example, 
                an entity store holding <em>Account</em> objects has a <code>MANY_TO_ONE</code>
                relationship with an entity store holding <em>Contact</em> objects.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var contacts = [
      {id: 1, name: 'John', email: 'john@him.com'},
      {id: 2, name: 'Jane', email: 'jane@her.com'},
      {id: 3, name: 'Dan', email: 'dan@him.com'},
      {id: 4, name: 'Kim', email: 'kim@her.com'},              
    ];
    
    var accounts = [
      {acct: 'x1', owner: 1, type: 'checking'},
      {acct: 'x3', owner: 2, type: 'saving'},
      {acct: 'y1', owner: 1, type: 'brokerage'},
      {acct: 'z4', owner: 4, type: 'saving'}
     ];</code></pre></div></div>
              <p>
                If an <em>Account</em> is destroyed, it has no impact on the <em>Contact</em>
                objects that were referenced in the <em>Account</em>. However, the opposite
                action would have more interesting consequences. If the contact 'John' were
                to be destroyed, then two accounts owned by 'John' are affected. 
              </p>
            </div>
    
            <p>
              When a foreign key constraint is declared:
            </p>
            <ol>
              <li>
                a new secondary key for the object is stored, it is checked to make
                sure it exists as a primary key for the related entity object. If
                it does not, then a newly constructed 
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception with code
                <a href="#code-constraint"><code>CONSTRAINT_ERR</code></a> is thrown.
              </li>
              <li>
                When a related entity is deleted, some action is automatically taken
                for the entities that refer to this object. The exact action can be
                one of the following:
                <ol>
                  <li><p>Nullify</p>
                    The referencing object can be modified to change its referring property
                    to null.
                  </li>
                  <li><p>Cascade</p>
                    The referencing object can be deleted.
                  </li>
                  <li><p>Abort</p>
                    The delete action can be aborted so that no dangling references are left.
                  </li>
                </ol>
              </li>
            </ol>
    
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Index">Index</dfn> {  
  const unsigned short <a href="#ONE_TO_ONE">ONE_TO_ONE</a> = 0;
  const unsigned short <a href="#MANY_TO_ONE">MANY_TO_ONE</a> = 1;
  const unsigned short <a href="#ONE_TO_MANY">ONE_TO_MANY</a> = 2;
  const unsigned short <a href="#MANY_TO_MANY">MANY_TO_MANY</a> = 3;

  const unsigned short <a href="#NULLIFY">NULLIFY</a> = 0;
  const unsigned short <a href="#CASCADE">CASCADE</a> = 1;
  const unsigned short <a href="#ABORT">ABORT</a> = 2;

  readonly attribute DOMString <a href="#index-name">name</a>;
  readonly attribute DOMString <a href="#index-key-path">keyPath</a>;
  readonly attribute unsigned short <a href="#index-cardinality">cardinality</a>;
  readonly attribute unsigned short <a href="#index-on-related-entity-delete">onRelatedEntityDelete</a>; 
  readonly attribute DOMString <a href="#index-related-entity">relatedEntity</a>;
};

interface <dfn id="IndexSync">IndexSync</dfn>: <a href="#Index">Index</a> { 
  unsigned long long <a href="#for-each">forEach</a>(in <a href="#CursorCallback">CursorCallback</a> callback,
                             in optional <a href="#CursorRange">CursorRange</a> range, 
                             in optional unsigned short direction);

  any <a href="#sync-index-get">get</a>(in any key);
  void <a href="#sync-index-delete">delete</a>(in any key);
};</code></pre></div></div>
            <p>
              The <dfn id="ONE_TO_ONE">ONE_TO_ONE</dfn> cardinality option indicates
              that the secondary key is unique to the object. If an object is stored
              with a secondary key that already exists in the entity store.
            </p>
            <p>
              The <dfn id="MANY_TO_ONE">MANY_TO_ONE</dfn> cardinality option indicates
              the secondary key may be used for multiple objects in the entity store. 
              That is, the key appears more than once, but for each stored object it
              can be used only once. 
            </p>
            <p>
              The <dfn id="ONE_TO_MANY">ONE_TO_MANY</dfn> cardinality option indicates
              that the secondary key might be used more than once for a given object. 
              Secondary keys themselves are assumed to be unique, but multiple instances
              of the secondary key can be used per object. 
            </p>
            <p>
              The <dfn id="MANY_TO_MANY">MANY_TO_MANY</dfn> cardinality option indicates
              there can be multiple keys for any given object, and for any given key
              there can be many related objects. 
            </p>
            <p>
              The <dfn id="NULLIFY">NULLIFY</dfn> foreign constraint action option indicates
              that all entities related to the deleted entity are updated so that
              the pertinent property in objects is nullified.
            </p>
            <p>
              The <dfn id="CASCADE">CASCADE</dfn> cardinality option indicates
              that the secondary key might be used more than once for a given object. 
              Secondary keys themselves are assumed to be unique, but multiple instances
              of the secondary key can be used per object. 
            </p>
            <p>
              The <dfn id="ABORT">ABORT</dfn> foreign constraint action indicates
              that the delete operation is not allowed. This is the default behavior.         
            </p>
            <p>
              On getting, <dfn id="index-name"><code>name</code></dfn> will
              provide the name of the index.        
            </p>
    
            <p>
              On getting, <dfn id="index-key-path"><code>keyPath</code></dfn> will
              provide the path of the key used as the secondary key of objects stored in this
              index. This path can be the empty string if the object value is used
              as the key.
            </p>
            
            <p>
              On getting, <dfn id="index-cardinality"><code>cardinality</code></dfn> will
              describe whether duplicate objects can be found in the index for a given
              secondary key. If the cardinality is <a href="#ONE_TO_ONE" class="idltype">
              <code>ONE_TO_ONE</code></a> or <a href="#ONE_TO_MANY" class="idltype">
              <code>ONE_TO_MANY</code></a>, duplicates will not occur. For the other 
              cardinality levels, duplicates may occur.
            </p>
            
            <p>
              On getting, <dfn id="index-on-related-entity-delete"><code>onRelatedEntityDelete</code></dfn>
              identifies the foreign key constraint action to take when the related entity
              is deleted.
            </p>
            <p>
              On getting, <dfn id="index-related-entity"><code>relatedEntity</code></dfn>
              identifies the name of the entity store that holds the related foreign entity for 
              enforcing foreign key constraints.
            </p>
            
            <p>
              The <dfn id="sync-index-get"><code>get()</code></dfn> method is used to 
              retrieve the object associated with the given secondary key in the entity store
              by looking up the primary keys for the given secondary key and performing the 
              <a href="#retrieval-steps">retrieval steps</a> for each of the primary keys.
            </p>

            <p>
              The <dfn id="sync-index-delete"><code>delete()</code></dfn> method is used to 
              delete the object associated with the given secondary key in the entity store. 
              by looking up the primary keys for the given secondary key and performing the 
              <a href="#deletion-steps">deletion steps</a> for each of the primary keys.
            </p>

          </div>
          <div class="section" id="cursor-sync">  
            <h4>3.2.5. Cursor</h4>
            <p>
              Cursors are a mechanism by which applications iterate over 
              the records in a database. Cursors can be used to get, put,
              and delete database records. If a database allows duplicate 
              records, then cursors are the only mechanism by which to
              access anything other than the first duplicate for a given 
              key. Although storage operations can be performed on a 
              cursor, a cursor itself is a transient object with all the
              real storage happening in objects that yield the cursor.
            </p>
            
            <p>
              The initial position of a cursor is set by specifying the
              direction in which the cursor should iterate over matching
              items. Once the cursor is created, it yield items only in 
              that direction.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                By default, a cursor walks over objects starting at the
                first item and ending at the last item including
                all the duplicates encountered along the way. If the
                cursor callback returns true, then the iteration is 
                stopped.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var cursor = objects.forEach(function(object) {;
  // act on each object and return true to exit the cursor  
});</code></pre></div></div>
              
              <p>
                To start at the last item and end in the first item,
                the cursor should be created with the direction parameter.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var count = objects.forEach(function(object) {;
  // act on each object and return true to exit the cursor  
}, <a href="#Cursor">Cursor</a>.<a href="#PREV">PREV</a>);</code></pre></div></div>

              <p>
                To start at a certain key and end in the last item, i.e.,
                for a lower-bounded cursor, while skipping duplicates,
                the cursor should be created with both the required 
                start key and the direction parameter. 
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var range = new <a href="#CursorRange">CursorRange</a>(<a href="#CursorRange">CursorRange</a>.<a href="#INDIVIDUAL">INDIVIDUAL</a>, key);
objects.forEach(function(object) {
  // act on each object and return true to exit the cursor  
}, range, <a href="#Cursor">Cursor</a>.<a href="#NEXT_NO_DUP">NEXT_NO_DUPLICATE</a>);</code></pre></div></div>
          
              <p>
                It is also possible to create a bounded cursor, i.e., with
                application-specified starting and ending points, the
                cursor should be created with both the required keys.
                If the range is inclusive of both keys, then additional
                flags are required. In the following example, all keys
                with values in the inclusive range (<code>start</code>, 
                <code>end</code>) are returned with all their duplicates,
                from the beginning of the range to its end.
              </p>
    
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var range = new <a href="#CursorRange">CursorRange</a>(<a href="#CursorRange">CursorRange</a>.<a href="#INCLUDE_START">INCLUDE_START</a> &amp; <a href="#CursorRange">CursorRange</a>.<a href="#INCLUDE_END">INCLUDE_END</a>, start, end);
objects.forEach(function(object) {
  // act on each object and return true to exit the cursor  
}, range);</code></pre></div></div>
            </div>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Cursor">Cursor</dfn> {
  const unsigned short <a href="#NEXT">NEXT</a> = 0;
  const unsigned short <a href="#NEXT_NO_DUP">NEXT_NO_DUPLICATE</a> = 1;
  const unsigned short <a href="#PREV">PREV</a> = 2;
  const unsigned short <a href="#PREV_NO_DUP">PREV_NO_DUPLICATE</a> = 3;
  
  readonly attribute unsigned short <a href="#direction">direction</a>;
  readonly attribute unsigned long long <a href="#count">count</a>;
};

interface <dfn id="CursorSync">CursorSync</dfn>: <a href="#Cursor">Cursor</a> {
  boolean <a href="#update">update</a>(any object);
  <a href="#cursor-delete">delete</a>();
};

[Constructor(in unsigned short mode, in optional any start, in optional end)]
interface <dfn id="CursorRange">CursorRange</dfn> {
  const unsigned short <a href="#INCLUDE_START">INCLUDE_START</a> = 1;
  const unsigned short <a href="#INCLUDE_END">INCLUDE_END</a> = 2;
  const unsigned short <a href="#INDIVIDUAL">INDIVIDUAL</a> = 4;
  
  readonly attribute any <a href="#range-start">start</a>;
  readonly attribute any <a href="#range-end">end</a>;
  readonly attribute unsigned short <a href="#range-mode">mode</a>;
};

[FunctionOnly, NoInterfaceObject]
interface <dfn id="CursorSyncCallback">CursorSyncCallback</dfn> {
  bool handle(in any object, in <a href="#CursorSync" class="idlref">CursorSync</a> cursor);
};</code></pre></div></div>
            <p>
              On getting <dfn id="count"><code>count</code></dfn>, the user agent
              returns the total number of objects that share the current key.
            </p>
            <p>
              On getting <dfn id="direction"><code>direction</code></dfn>, the user agent
              returns the the traversal direction of the cursor.
            </p>
            <p>
              The <dfn id="for-each" class="idltype"><code>forEach()</code></dfn>
              method is used to navigate items in a cursor in the direction
              identified by the <var>direction</var> parameter, which can be
              either of <a href="#NEXT" class="idlref"><code>NEXT</code></a>,
              <a href="#NEXT_NO_DUP" class="idlref"><code>NEXT_NO_DUP</code></a>,
              <a href="#PREV" class="idlref"><code>PREV</code></a>, or
              <a href="#PREV_NO_DUP" class="idlref"><code>PREV_NO_DUP</code></a>.
              If <var>direction</var> is unspecified, then the cursor uses
              the <a href="#NEXT" class="idlref"><code>NEXT</code></a> direction.
              The parameters <var>inclusiveFrom</var> and <var>inclusiveTo</var>
              are used to signal whether ranges are open or closed on the
              range boundaries.
            </p>
            
            <p>
              For each object that matches the cursor condition, the user agent
              calls the <a href="#CursorCallback" class="idlref"><code>
              CursorCallback</code></a>. This <var>callback</var> is passed two
              parameters - the object that matches the cursor condition, and
              a <a href="#Cursor" class="idlref"><code>Cursor</code></a> object
              to make changes to the database at the <a href="#Cursor" class="idlref"><code>
              Cursor</code></a> position. If this callback returns a <code>true</code>
              value, then the cursor traversal is exited whether or not the
              range conditions have been satisfied.
            </p>
            
            <p>
              The <dfn id="NEXT"><code>NEXT</code></dfn> direction indicates
              that cursor should yield all values, including duplicates 
              starting from the beginning of the range to its end.
            </p>
            
            <p>
              The <dfn id="NEXT_NO_DUP"><code>NEXT_NO_DUPLICATE</code></dfn> direction 
              indicates that cursor should return all values, skipping over duplicate
              objects for every key starting from the beginning of the range to 
              its end. For every key with duplicate values, only the first value
              is yielded.
            </p>
            
            <p>
              The <dfn id="PREV"><code>PREV</code></dfn> direction indicates
              that cursor should yield all values, including duplicates 
              starting from the end of the range to its beginning.
            </p>
            
            <p>
              The <dfn id="PREV_NO_DUP"><code>PREV_NO_DUPLICATE</code></dfn> direction 
              indicates that cursor should return all values, skipping over duplicate
              objects for every key starting from the end of the range to its
              beginning. For every key with duplicate values, only the first value
              is yielded.
            </p>
            
            <p>
              The <dfn id="update"><code>update()</code></dfn> method is used to 
              update the object at which the cursor is currently positioned. If 
              the object is updated, then this method returns true. The update 
              method is only allowed if the <a href="#Cursor" class="idltype"><code>
              Cursor</code></a> is obtained from an entity store. The key of
              the <var>object</var> parameter must match the key in the current
              cursor position. Otherwise, the database will throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code <a class="idltype" href="#code-data"><code>DATA_ERR</code></a>.
            </p>
            <p>
              The <dfn id="cursor-delete"><code>delete()</code></dfn> method
              is used to delete the object at which the cursor is currently
              positioned. The <a href="#cursor-delete" class="idltype"><code>delete()</code></a> 
              method will return false if this method is called more than once 
              inside a <a href="#CursorCallback"><code>CursorCallback</code></a>.
            </p>

          </div>
          <div id="entity-join-sync" class="section">
            <h4>3.2.6. Entity Join</h4>
            <p>
              An entity join is used to perform an equality join on two or more 
              secondary keys of an entity store. An equality join is a match on
              all entities in a given entity store that have two or more specific
              index values. Only exact keys are matched and key ranges may not
              be used.
            </p>
            
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                In a database that stores records about employment records that 
                includes individuals, their employer and job title, 
                an application can use an entity join to find an individual
                for a given title and employer.
              </p>
              
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var db = ...
var employer = db.<a href="#get-index">getIndex</a>('employer', 'employment');
var title = db.<a href="#get-index">getIndex</a>('title', 'employment');
var join = employment.<a href="#join">join</a>();
join.<a href="#add-condition">addCondition</a>(employer, 'ORCL');
join.<a href="#add-condition">addCondition</a>(title, 'Engineer');

join.<a href="#join-for-each">forEach</a>(function(employee) {
  // process each employee working at ORCL as an Engineer
});</code></pre></div></div>
            </div>
            
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="EntityJoin">EntityJoin</dfn> {
  <a href="#addCondition">addCondition</a>(in <a href="#Index">Index</a> index, 
               in any key);
};

interface <dfn id="EntityJoinSync">EntityJoinSync</dfn> : <a href="">EntityJoin</a> {
  unsigned long long <a href="#join-for-each">forEach</a>(in <a href="#CursorCallback">CursorCallback</a> callback);
};</code></pre></div></div>  
            </div>
            
            <p>
              The <dfn id="addCondition"><code>addCondition()</code></dfn> method is used
              to add an index condition to the join operation. If the parameter <var>index</var>
              is already added to this join operation, then a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code 
              <a class="idltype" href="#code-non-transient"><code>NON_TRANSIENT_ERR</code></a>
              is thrown. If the parameter <var>index</var> is not on the same entity store
              as the entity join itself, then also, a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code 
              <a class="idltype" href="#code-non-transient"><code>NON_TRANSIENT_ERR</code></a> 
              is thrown. The parameter <var>key</var> is used to set a starting point in
              the index.
            </p>
            
            <p>
              The <dfn id="entity-join-for-each"><code>forEach()</code></dfn> method 
              is used to traverse the objects in an entity store that satisfy all the
              conditions specified in the join. 
            </p>
          </div>
          
          <div id="sequence-sync" class="section">
            <h4>3.2.7. Sequence</h4>
            <p>
              Sequences provide an arbitrary number of persistent objects that return
              an increasing or decreasing sequence of integers. Implementations
              may cache blocks of values for a sequence to reduce contention. 
              It is not necessary that the implementation
              provide consecutive values as long as it maintains the monotonically
              increasing or decreasing sequence of values.
              It is necessary that values be spaced at least as far apart as the
              increment value used at the time of creating the sequence.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                If a sequence is created with the initial value 3 and increment of 2, 
                then the first value will be 3. Subsequently, a sequence may offer
                values of 5, 7, and so on. It is also possible that two consecutive
                calls to obtain the next value produce non-consecutive odd numbers,
                e.g., 9 and 15.
              </p>
            </div>
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Sequence">Sequence</dfn> {
  readonly attribute DOMString <a href="#sequence-name">name</a>;
  readonly attribute long long <a href="#sequence-current">current</a>;
};

interface <dfn id="SequenceSync">SequenceSync</dfn> : <a href="#Sequence">Sequence</a> {
  <a href="#change-increment">changeIncrement</a>(in long long increment);
  long long <a href="#sequence-next">next</a>();
};</code></pre></div></div>  
            </div>
            <p>
              On getting, <dfn id="sequence-name"><code>name</code></dfn> will
              provide the name of the sequence.        
            </p>
            <p>
              On getting, <dfn id="sequence-current"><code>current</code></dfn> will
              provide the present value of the sequence. Unless a value is provided,
              the initial value of a sequence will be 1.
            </p>
            
            <p>
              The <dfn id="change-increment"><code>changeIncrement()</code></dfn> 
              method is used to alter the amount by which the sequence is 
              incremented (or decremented) each time the <a href="#sequence-next" class="idlref">
              <code>next()</code></a> method is called.
            </p>
            
            <p>
              The <dfn id="sequence-next"><code>next()</code></dfn> method is used to 
              advance the sequence and obtain the next number in the sequence
              as calculated from its current value and increment. Unless a value is provided,
              the sequence will increment its value by 1.
            </p>
            
          </div>
          <div class="section" id="queue-sync">  
            <h4>3.2.8. Queue</h4>
            <p>
              A queue is a simple first-in-first-out store that can hold data sorted
              by their arrival so as to enable fast insertion and sequential retrieval.
              Unlike entity stores, queues do not provide externally visible key-based
              retrieval of values. Nor is it possible to store items with an application
              specified key.
            </p>
            <div>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="Queue">Queue</dfn> {  
  readonly attribute DOMString <a href="#queue-name">name</a>;
};

interface <dfn id="QueueSync">QueueSync</dfn> : <a href="#Queue">Queue</a> {
  <a href="#push">push</a>(in any object);
  any <a href="#pop">pop</a>();
};</code></pre></div></div>  
            </div>
            <p>
              On getting, <dfn id="queue-name"><code>name</code></dfn> will
              provide the name of the queue.        
            </p>
            <p>
              The <dfn id="push"><code>push()</code></dfn> method is used to 
              store the given object at the head of the queue.
            </p>
    
            <p>
              The <dfn id="pop"><code>pop()</code></dfn> method is used to 
              delete the object that is at the head of the queue as ordered by their 
              insertion in to the queue. The deleted object is also returned as result.
            </p>
          </div>
          <div id="transaction-sync" class="section">
            <h4>3.2.9. Transaction</h4>
            <p>
              A transaction represents an atomic and durable set of 
              database access and mutation operations. Transactions offer data protection
              from application or system failures. 
            </p>
            
            <p>
              A transaction may be used to store multiple data items or to conditionally 
              modify certain data items. 
            </p>
            
            <p>
              A <a href="#Database"><code>Database</code></a> object may have at most one 
              transaction at any given time. 
            </p>
            
            <p>  
              Transactions are expected to be short lived. Conforming user agents may
              terminate transactions that take too long to complete in order to free up
              storage resources that are locked by a long running transaction.         
            </p>                    

            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="TransactionSync">TransactionSync</dfn> {  
  void <a href="#abort">abort</a>();
  void <a href="#commit">commit</a>();
};</code></pre></div></div>

          <dl>
            <dt><dfn id="abort"><code>abort()</code></dfn></dt>
            <dd>
              This method is used to signal
              the need to cancel the effects of database operations performed in a 
              transaction. To perform this method, the database ignores all the changes
              performed in this transaction through calls to this 
              <a class="idltype" href="#Transaction"><code>Transaction</code></a> object.
            </dd>
            <dt><dfn id="commit"><code>commit()</code></dfn></dt>
            <dd>
              This method is used to signal
              the normal and satisfactory completion of a transaction to the database. At
              this point, the database durably stores the result of all the operations
              performed in this transaction through calls to this 
              <a class="idltype" href="#Transaction"><code>Transaction</code></a> object.
            </dd>       
          </dl>
            <p>
              The API for a transaction consists of mechanisms for committing
              and rolling back the effects of database operations performed
              in that transaction. However, asynchronous databases also 
              automatically commit a transaction whenever the transaction
              callback completes. Asynchronous databases also automatically
              rollback a transaction if an error occurs inside the transaction
              callback.
            </p>
            <div class="note"><div class="noteHeader">Note</div>
              Applications must not assume that committing the transaction
              produces an instantaneously durable result. The user agent
              may delay flushing data to durable storage until an appropriate
              time.
            </div>
            
            <p>
              When the user agent is to <dfn id="create-a-transaction-object">create a
              <a class="idltype" href="#Transaction"><code>Transaction</code></a> object</dfn>
              it must run the following steps:
            </p>
            
            <ol>
              <li>
                Pick the appropriate steps:
                <dl class="switch">
                  <dt>If these steps are not called with an array of database objects</dt>
                  <dd>Acquire a lock on the entire database.</dd>
                  <dt>If these steps are called with a non-empty array of database objects</dt>
                  <dd><ol>
                    <li>
                      If any of the objects in this array is not a database object,
                      then set <var>code</var> to
                      <a href="#code-non-transient"><code>NON_TRANSIENT_ERR</code></a>
                      and jump to the last step.
                    </li>
                    <li>
                      Acquire appropriate locks on each of the database objects and
                      the objects they depend on in an ordered sequence. 
                      <div class="note"><div class="noteHeader">Note</div>
                        If the database does not allow fine grained locking,
                        then a user agent may obtain a shared or exclusive lock on the database.
                      </div>
                    </li>
                  </ol></dd>
                  <dt>If these steps are called with an empty array of database objects</dt>
                  <dd>
                      Do not acquire locks on any database objects now. Locks are obtained as
                      the application attempts to access those objects.
                      <div class="note"><div class="noteHeader">Note</div>
                        Using the database in this style may lead to deadlocks. Programmers
                        must use caution to acquire and release database objects in the same
                        global order to avoid deadlocks.
                      </div>
                  </dd>
                </dl>
              </li>
  
              <li>
                If a timeout duration is passed to these steps and is exceeded when 
                acquiring locks, then set <var>code</var> to 
                <a href="#code-timeout"><code>TIMEOUT_ERR</code></a> and
                jump to the last step.
              </li>
  
              <li>
                Open a new transaction to the database, and create a
                <code><a class="idltype" href="#Transaction">Transaction</a></code> object
                that represents that transaction. Let <var>transaction</var> be this object.
              </li>
              
              <li>
                Set the current transaction of this 
                <a href="#Database"><code>Database</code></a> object
                to <var>transaction</var>.
              </li>
              <li>
                Return <var>transaction</var>. End these steps.
              </li>
              <li>
                This step is only performed in case of error. If this step is performed
                asynchronously, then run the 
                <a class="dfnref" href="#database-failure-steps">database failure steps</a>
                with the code <var>code</var>. Otherwise, raise a newly constructed 
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception exception with the code <var>code</var>.
              </li>
            </ol>
                      
            <p>
              Once a transaction is aborted or committed, that 
              <a class="idltype" href="#Transaction"><code>Transaction</code></a> 
              object can no longer be used. If any calls are made on that
               object, then the database will throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code <a href="#code-non-transient"><code>NON_TRANSIENT_ERR</code></a>. 
              To perform database operations under the control of a new transaction, 
              a fresh <a class="idltype" href="#Transaction"><code>Transaction</code></a>
              object is needed.
            </p>
          </div> <!-- Transaction -->
          
        </div>
        <div class="section" id="async-api"> 
          <h3>3.3. Asynchronous APIs</h3>
          <p>
            The asynchronous database API returns without blocking the calling thread.
            This API can only be used in a Window or in a Worker 
            <cite><a href="#ref-WebWorkers">[WebWorkers]</a></cite>.
          </p>
          <div class="section" id="events">
            <h4>3.3.1. Event summary</h4>
            <div class="norm">This section is non-normative.</div>
            <p>
              Events are fired during asynchronous database access as database objects
              are created and data is consumed from these objects. As requests for
              database objects are made, the user agent loads information about them
              into memory and when the required object handle is available, it 
              alerts the application through the firing of events. The events are
              as follows:
            </p>
            <table>
              <thead><tr><th>Event name</th><th>Interface</th><th>Dispatched when...</th></tr></thead>
              <tbody>
                <tr>
                  <td><dfn id="event-success"><code>success</code></dfn></td>
                  <td><code>Event</code></td>
                  <td>The database object which was requested is available.</td>
                </tr>
                <tr>
                  <td><dfn id="event-error"><code>error</code></dfn></td>
                  <td><a href="#DatabaseErrorEvent"><code>DatabaseErrorEvent</code></a></td>
                  <td>There was an error performing the database request.</td>
                </tr>
                <tr>
                  <td><dfn id="event-complete"><code>complete</code></dfn></td>
                  <td><code>Event</code></td>
                  <td>The cursor has been completely traversed.</td>
                </tr>
                <tr>
                  <td><dfn id="event-commit"><code>commit</code></dfn></td>
                  <td><code>Event</code></td>
                  <td>The transaction commit has been completed.</td>
                </tr>
                <tr>
                  <td><dfn id="event-abort"><code>abort</code></dfn></td>
                  <td><code>Event</code></td>
                  <td>The transaction abort has been completed.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="section" id="opening">
            <h4>3.3.2. The DatabaseRequest Interface</h4>
            <p>
              This interface provides methods for opening databases and accessing
              database objects using event handler attributes
              <cite><a href="#ref-DOM3Events">[DOM3Events]</a></cite>.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                In the following example, we open a database asynchronously. Various event
                handlers are registered for responding to various situations.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var dbReq = new <a href="#DatabaseRequest">DatabaseRequest</a>();
dbReq.<a href="#handler-request-onsuccess">onsuccess</a> = function(evt) {...};
dbReq.<a href="#handler-request-onerror">onerror</a> = function(evt) {...};
dbReq.<a href="#database-open">open</a>('AddressBook', '1', 'Address Book', function(txn, db) {...});</code></pre></div></div>
            </div>
            <p>
              This API uses an event handler mechanism to obtain database objects.
              If an error occurs while opening the database, an error handler is invoked.
              Otherwise, a success handler is invoked.
            </p>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="DatabaseRequest">DatabaseRequest</dfn> {
  readonly attribute <a href="#Database">Database</a> database;
  
  void <a href="#database-request-open">open</a>(in DOMString name, 
            in DOMString version, 
            in DOMString displayName, 
            in optional <a href="#UpgradeCallback">UpgradeCallback</a> upgrade,
            in optional unsigned short isolation);
  //events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

<a href="#DatabaseRequest">DatabaseRequest</a> implements EventTarget;</code></pre></div></div>  
            <p>
              The <dfn id="database-request-open"><code>open()</code></dfn>
              method takes the following arguments: a database name, a database
              version, a display name, an optional upgrade callback, and an optional 
              isolation level. When called, this method must return immediately and 
              asynchronously perform the following steps, with all but the first two
              and last steps being run atomically:
            </p>
            
            <ol>
   
              <li>
                <span>Queue a task</span> to fire an event with the name <code>success</code>,
                with no namespace, which does not bubble, is not cancelable, and which uses the
                <a href="#DatabaseEvent"><code>DatabaseEvent</code></a> interface
                and <var>result</var> at each <code>Window</code> or <code>WorkerUtils</code> object.
              </li>
            </ol>
          
            <p>
              The <dfn id="database-failure-steps">database failure steps</dfn> performed with an 
              error code are as follows:
            </p>
          
            <ol>
              <li>
                Create a <a href="#DatabaseError" class="idlref">DatabaseError</a> object 
                <var>error</var> where code is the error code passed to these steps and status is 0.
              </li>
              <li>
                <span>Queue a task</span> to fire an event with the name <code>error</code>,
                with no namespace, which does not bubble, is not cancelable, and which uses the
                <a href="#DatabaseErrorEvent"><code>DatabaseErrorEvent</code></a> interface
                and <var>error</var> at each <code>Window</code> or <code>WorkerUtils</code> object.
              </li>
            </ol>
                    
            <p>
              The <span>task source</span> for these tasks is the 
              <dfn id="database-access-task-source">database access task source</dfn>.
            </p>    
          </div>
          
          <div class="section" id="entity-store">  
            <h4>3.3.3. Entity Store</h4>
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                In the following example, we set up an entity store to use the 
                property <code>id</code> from objects to store as the key.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var store = null;
var dbReq = new <a href="#DatabaseRequest">DatabaseRequest</a>();
dbReq.<a href="#handler-request-onsuccess">onsuccess</a> = 
  function(db) {
    var storeReq = new <a href="#EntityStoreRequest">EntityStoreRequest</a>(db);
    storeReq.<a href="#handler-request-onsuccess">onsuccess</a> = function(s) { store = s; };
    storeReq.<a href="#store-request-open">open</a>('Contact');
  };
var upgrade = 
  function(txn, db) {
    txn.<a href="#create-entity-store">createEntityStore</a>('Contact', 'id');
    txn.<a href="#commit">commit</a>();
  });
dbReq.<a href="#database-request-open">open</a>('AddressBook', '1', 'Address Book');</code></pre></div></div>
    
              <p>
                The <code>put()</code> operation will store an object using the value 
                of the property <code>id</code> from the object as the key.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">function saveContact(contact) {
  var txnReq = new <a href="#TransactionRequest">TransactionRequest</a>(db);
  txnReq.<a href="#handler-request-onsuccess">onsuccess</a> = 
    function(txn) {
      store.<a href="#entity-store-put">put</a>(contact);  
      txn.<a href="#commit">commit</a>();
    };
  txnReq.<a href="#txn-request-open">open</a>();
};

var lincoln = {id: 1, name: 'Lincoln', number: '7012'};
saveContact(lincoln);</code></pre></div></div>
              <p>
                Objects in the entity store can be read using their key.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var req = new <a href="#DatabaseRequest">DatabaseRequest</a>();
  function(db) {
    var storeReq = new <a href="#EntityStoreRequest">EntityStoreRequest</a>(db);
    storeReq.<a href="#handler-request-onsuccess">onsuccess</a> = 
      function(store) {
        var txnReq = new <a href="#TransactionRequest">TransactionRequest</a>(db);
        txnReq.<a href="#handler-request-onsuccess">onsuccess</a> = 
          function(txn) {
            var lincolnContact = store.get(1);
            // lincolnContact.id === 1 &amp;&amp; lincolnContact.name === 'Lincoln';
            txn.<a href="#commit">commit</a>();
          };
        txnReq.<a href="#txn-request-open">open</a>();
      };
    storeReq.<a href="#store-request-open">open</a>('Contact');
  };
req.<a href="#database-request-open">open</a>('AddressBook', '1', 'Address Book');</code></pre></div></div>
            </div>
            <p>
              An entity store does not allow multiple items to be stored with the same primary.
              key If the same key is used to store a different item, then it will replace
              the object currently stored with the same key.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>				
              <p>
                Continuing with the earlier example, the second put operation will
                replace the object stored by the first put operation.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var abraham = {id: 1, name: 'Abraham', number: '2107'};
    
database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  var abrahamID = store.put(abraham);
  // 1 === abrahamID
});</code></pre></div></div>
              <p>
                Now when the entity store is read with the same key, the result 
                is different compared to the object read in the previous example.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  var abrahamContact = store.get(1);
  // abrahamContact.id === 1 &amp;&amp; abrahamContact.name === 'Abraham';
});</code></pre></div></div>
            </div>
            <p>
              If an application does not generate its own keys, it can use keys 
              generated by a <a class="idltype" href="#Sequence"><code>Sequence</code></a> 
              object.
            </p>
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                Contrasted with the previous examples, the entity store below is designed
                to use a <a class="idltype" href="#Sequence"><code>Sequence</code></a> 
                object.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var lincoln = {name: 'Lincoln', number: '7012'};
    
var database = window.openDatabase('AddressBook', '1', 'Address Book', null, 
  function(Transaction txn) {
    txn.createSequence('ContactSeq');
    txn.createEntityStore('Contact', 'id', 'ContactSeq');
  });
var lincolnID = null;
database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  lincolnID = store.put(lincoln);  
  // lincoln["id"] === lincolnID
});</code></pre></div></div>
              <p>
                When an object is stored in 'Contact', the 'ContactSeq' sequence is used
                to produce a key for that object. This key is also stored as part of the 
                stored object as can be seen from the following code. 
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">database = window.openDatabase('AddressBook', '1', 'Address Book', true);
database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  var lincolnContact = store.get(lincolnID);
  // lincolnID == lincolnContact["id"] &amp;&amp; lincolnContact["name"] == 'Lincoln';
});</code></pre></div></div>
            </div>
          
            <p>
              An entity store arranges stored objects by their key, also referred to 
              as the primary key. Each object contains the value of its primary key. 
              Additionally, entity stores may also have one or more secondary keys 
              declared for stored objects. Indices store data about secondary keys
              and refer to a primary key somewhere in the entity store.
            </p>
            
            <div class="example"><div class="exampleHeader">Example</div>
              <p>
                Continuing with the previous examples, the entity store below is configured
                with an index on the 'name' attribute.
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var lincoln = {name: 'Lincoln', number: '7012'};
var abraham = {name: 'Abraham', number: '2107'};

var database = window.openDatabase('AddressBook', '1', 'Address Book', null, 
  function(Transaction txn) {
    txn.createSequence('ContactSeq');
    var store = txn.createEntityStore('Contact', 'id', 'ContactSeq');
    store.createIndex('ContactName', 'name', Index.MANY_TO_ONE);
  });
  
database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  store.put(lincoln);  
  store.put(abraham);
});</code></pre></div></div>
              <p>
                When objects are retrieved from the entity store, they are arranged by
                the value of the 'id' attribute. On the other hand, when objects are
                retrieved using the 'ContactName' index, they are arranged by the value
                of the 'name' attribute of objects. 
              </p>
              <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">database = window.openDatabase('AddressBook', '1', 'Address Book', true);
database.transaction(function(Transaction txn) {
  var store = txn.getEntityStore('Contact');
  var index = store.getIndex('ContactName').entities('L');
  var l1 = null, l2 = null, count = 0;
  index.forEach('L', function(contact) {
    l1 = contact;
    if (++count === 2)
      return true;
  });
  store.forEach(function(contact) {
    l2 = contact;
    return true;
  });
  // l1["id"] === l2["id"]
});</code></pre></div></div>
            </div>
    
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Constructor(in Database db)]
interface <dfn id="EntityStoreRequest">EntityStoreRequest</dfn> {
  readonly attribute EntityStore store;
  
  void <a href="#entity-store-open">open</a>(in DOMString name,
            in optional readonly);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in EntityStore store), Constructor(in Index index)]
interface GetRequest {
  readonly attribute any value;
  
  void open(in any key);
  //events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in EntityStore store)]
interface PutRequest {
  readonly attribute any value;
  
  void open(in any object);
  //events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in EntityStore store), Constructor(in Index index), Constructor(in Cursor cursor)]
interface DeleteRequest {
  void open(in any key);
  //events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
                       
            <p>
              The <dfn id="entity-store-put"><code>put()</code></dfn> method is used to 
              store the given object in the entity store. Insert the object by performing the 
              <a href="#insertion-steps">insertion steps</a>.
            </p>
    
            <p>
              The <dfn id="entity-store-get"><code>get()</code></dfn> method is used to retrieve
              the object associated with the given key in the entity store. The following steps 
              must be run for retrieving the object with the following parameters: <var>key</var>.
            </p>
              
            <ol>
              <li>
                If <var>key</var> is not defined or null, then throw a newly constructed 
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception (<a href="#code-3">Error code 3</a>)
                and terminate these steps.
              </li>            
              <li>
                Use the <var>key</var> to look up an object in the entity store. Let 
                <var>value</var> be that object.
              </li>
              
              <li>
                If <var>object</var> is not found in the entity store, then throw a newly constructed 
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception (<a href="#code-3">Error code 3</a>)
                and terminate these steps.
              </li>
            </ol>
    
            <p>
              The <dfn id="entity-store-delete"><code>delete()</code></dfn> method is used to 
              delete the object associated with the given key in the entity store. Delete the
              object by performing the <a href="#deletion-steps">deletion steps</a>.
            </p>
    
            <p>    
              If an index with the given name, compared in a case-sensitive manner, 
              already exists, then this method will throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception (<a href="#code-4">Error code 4</a>).
            </p>
            
            <p>
              If there are two or more secondary indexes set for an entity store, then 
              sets of objects can be retrieved from it based on the intersection of
              multiple index values using an <a href="#EntityJoin"><code>EntityJoin</code></a> object. 
              The <dfn id="entity-store-join"><code>join()</code></dfn> method is
              used to obtain such an object.
            </p>
          </div>
          <div id="index" class="section">  
            <h4>3.3.4. Index</h4>
    		    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="IndexRequest">IndexRequest</dfn> {
  readonly attribute <a href="#Index">Index</a> index;
  
  void open(in DOMString name,
            in DOMString storeName,
            in optional readonly); 
  // events          
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
            
          </div>
          <div class="section" id="cursor">
            <h4>3.3.5. Cursor</h4>
        <div class="example"><div class="exampleHeader">Example</div>
          <p>
            By default, a cursor walks over objects starting at the
            first item and ending at the last item including
            all the duplicates encountered along the way. If the
            cursor callback returns true, then the iteration is 
            stopped.
          </p>
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var req = new CursorRequest(objects);
req.oneach = function(object) {
  // act on each object and return true to exit the cursor  
});
req.open();</code></pre></div></div>
          
          <p>
            To start at the last item and end in the first item,
            the cursor should be created with the direction parameter.
          </p>
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var req = new CursorRequest(objects);
req.oneach = function(object) {
  // act on each object and return true to exit the cursor  
});
req.open(<a href="#Cursor">Cursor</a>.<a href="#PREV">PREV</a>);</code></pre></div></div>

          <p>
            To start at a certain key and end in the last item, i.e.,
            for a lower-bounded cursor, while skipping duplicates,
            the cursor should be created with both the required 
            start key and the direction parameter. 
          </p>
          
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var range = new Range(Range.INDIVIDUAL, key);
var req = new CursorRequest(objects);
req.oneach = function(object) {
  // act on each object and return true to exit the cursor  
});
req.open(range, <a href="#Cursor">Cursor</a>.<a href="#NEXT_NO_DUP">NEXT_NO_DUPLICATE</a>);</code></pre></div></div>
          
          <p>
            It is also possible to create a bounded cursor, i.e., with
            application-specified starting and ending points, the
            cursor should be created with both the required keys.
            If the range is inclusive of both keys, then additional
            flags are required. In the following example, all keys
            with values in the inclusive range (<code>start</code>, 
            <code>end</code>) are returned with all their duplicates,
            from the beginning of the range to its end.
          </p>

          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">ECMAScript</span></div><div class="blockContent"><pre class="code"><code class="es-code">var objects = ...
var range = new Range(Range.INCLUDE_START &amp; Range.INCLUDE_END, start, end);
var req = new CursorRequest(objects);
req.oneach = function(object) {
  // act on each object and return true to exit the cursor  
});
req.open(range);</code></pre></div></div>
        </div>
        
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Constructor(in EntityStore store), Constructor(in Index index), Constructor(in EntityJoin join)]
interface <dfn id="CursorRequest">CursorRequest</dfn> {
  readonly attribute unsigned long long count;
  
  void <a href="#open">open</a>(in CursorCallback callback,
            in optional <a href="#CursorRange">CursorRange</a> range, 
            in optional unsigned short direction);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[FunctionOnly, NoInterfaceObject]
interface <dfn id="CursorCallback">CursorCallback</dfn> {
  bool handle(in any object, in <a href="#Cursor" class="idlref">Cursor</a> cursor);
};

[Constructor(in Cursor cursor)]
interface UpdateRequest {  
  void open(in any object);
  //events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
          </div>
          <div class="section" id="sequence">
            <h4>3.3.6. Sequence</h4>
			    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Constructor(in Database db)]
interface <dfn id="SequenceRequest">SequenceRequest</dfn> {
  readonly attribute Sequence sequence;
  
  void <a href="#sequence-open">open</a>(in DOMString name);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in Sequence sequence)]
interface IncrementRequest {
  void <a href="#change-open">open</a>(in long long increment);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in Sequence sequence)]
interface NextRequest {
  readonly attribute long long value;
  
  void <a href="#next-open">open</a>();
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
            
          </div>
          <div class="section" id="queue">
            <h4>3.3.7. Queue</h4>
			    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">[Constructor(in Database db)]
interface <dfn id="QueueRequest">QueueRequest</dfn> {
  readonly attribute Queue queue;
  
  void <a href="#queue-open">open</a>(in DOMString name);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in Queue queue)]
interface PushRequest {
  void <a href="#push-open">open</a>(in any object);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};

[Constructor(in Queue queue)]
interface PopRequest {
  readonly attribute any value;
  
  void <a href="#pop-open">open</a>();
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
            
          </div>
          <div class="section" id="transaction">
            <h4>3.3.8. Transaction</h4>
            <p><dfn id="transaction"><code>transaction()</code></dfn>
              When called, this
              method must immediately return and then asynchronously perform the
              <a href="#transaction-steps">transaction steps</a>.
            </p>
            <p>
              The <dfn id="transaction-steps">transaction steps</dfn> are as follows. 
              These steps are invoked with a
              transaction callback, and the following optional arguments - a success
              callback, an error callback, an array of database objects for acquiring
              locks required in this transaction, and a timeout duration.
            </p>
            
            <ol>
              <li>
                 Perform the <a href="#create-a-transaction-object">transaction creation steps</a> 
                 with the array of database objects and timeout duration passed to these
                 steps. Let the resulting
                 <code><a class="idltype" href="#Transaction">Transaction</a></code>
                 object be <var title="">transaction</var>.
              </li>
              
              <li>
                <span>Queue a task</span> to invoke the <em>transaction callback</em> 
                with <var>transaction</var> as its only argument, and wait for 
                that task to be run.
              </li>
              
              <li>
                If the callback couldn't be called (e.g. it was null), or if the
                callback was invoked and raised an exception, jump to the last step.
              </li>
  
              <li>
                <span>Queue a task</span> to invoke the <em>success callback</em>.
              </li>
  
              <li>
                End these steps. 
              </li>
              
              <li>This step is only used when something goes wrong.
                <ol>
                  <li>
                    If <var>transaction</var> is still not committed or rolled back,
                    then rollback the transaction.
                  </li>
                  
                  <li>
                    If an error callback was passed to these steps, then <span>queue a task</span> 
                    to invoke the it with a newly constructed 
                    <a class="idltype" href="#DatabaseError"><code>DatabaseError</code></a>
                    with code
                    <a href="#code-unknown"><code>UNKNOWN_ERR</code></a>.
                  </li>
                </ol>
              </li>
            </ol>
            <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface Transaction : TransactionSync {
            attribute <a href="#Function">Function</a> <a href="#handler-request-oncommitted">oncommitted</a>;
            attribute <a href="#Function">Function</a> <a href="#handler-request-onaborted">onaborted</a>;
};

[Constructor(in Database db)]
interface TransactionRequest {
  readonly attribute Transaction transaction;
  
  void open(in optional&lt;any&gt; objects,
            in optional unsigned int timeout);
  // events
           attribute <a href="#Function">Function</a> <a href="#handler-request-onsuccess">onsuccess</a>;
           attribute <a href="#Function">Function</a> <a href="#handler-request-onerror">onerror</a>;
};</code></pre></div></div>  
        </div>        
        <div class="section" id="event-handler">
          <h4>3.3.9. Events</h4>
          <p>
            The following are the <span>event handlers</span> (and their corresponding 
            <span>event handler event types</span>) that must be supported, as IDL
            attributes, by objects implementing the various interfaces:
          </p>
          
          <table>
            <thead><tr>
              <th><span>Event handler</span> </th>
              <th>Supported by interfaces</th>
              <th><span>Event handler event type</span></th>
            </tr></thead>
            <tbody>
              <tr>
                <td><dfn id="handler-request-onsuccess"><code>onsuccess</code></dfn> </td>
                <td> <code><a href="#event-success">success</a></code></td>
                <td> 
                  <code><a href="#DatabaseRequest">DatabaseRequest</a></code>,
                  <code><a href="#EntityStoreRequest">EntityStoreRequest</a></code>,
                  <code><a href="#GetRequest">GetRequest</a></code>,
                  <code><a href="#PutRequest">PutRequest</a></code>,
                  <code><a href="#DeleteRequest">DeleteRequest</a></code>,
                  <code><a href="#IndexRequest">IndexRequest</a></code>,
                  <code><a href="#UpdateRequest">UpdateRequest</a></code>,
                  <code><a href="#SequenceRequest">SequenceRequest</a></code>,
                  <code><a href="#IncrementRequest">IncrementRequest</a></code>,
                  <code><a href="#NextRequest">NextRequest</a></code>,
                  <code><a href="#QueueRequest">QueueRequest</a></code>,
                  <code><a href="#NextRequest">NextRequest</a></code>,
                  <code><a href="#QueueRequest">QueueRequest</a></code>,
                  <code><a href="#PushRequest">PushRequest</a></code>,
                  <code><a href="#PopRequest">PopRequest</a></code>,
                  <code><a href="#TransactionRequest">TransactionRequest</a></code>
                </td>
              </tr>
              <tr>
                <td><dfn id="handler-request-onerror"><code>onerror</code></dfn> </td>
                <td> <code><a href="#event-error">error</a></code></td>
                <td> 
                  <code><a href="#DatabaseRequest">DatabaseRequest</a></code>,
                  <code><a href="#EntityStoreRequest">EntityStoreRequest</a></code>
                  <code><a href="#GetRequest">GetRequest</a></code>,
                  <code><a href="#PutRequest">PutRequest</a></code>,
                  <code><a href="#DeleteRequest">DeleteRequest</a></code>,
                  <code><a href="#IndexRequest">IndexRequest</a></code>,
                  <code><a href="#CursorRequest">CursorRequest</a></code>,
                  <code><a href="#UpdateRequest">UpdateRequest</a></code>,
                  <code><a href="#SequenceRequest">SequenceRequest</a></code>,
                  <code><a href="#IncrementRequest">IncrementRequest</a></code>,
                  <code><a href="#NextRequest">NextRequest</a></code>,
                  <code><a href="#QueueRequest">QueueRequest</a></code>,
                  <code><a href="#NextRequest">NextRequest</a></code>,
                  <code><a href="#QueueRequest">QueueRequest</a></code>,
                  <code><a href="#PushRequest">PushRequest</a></code>,
                  <code><a href="#PopRequest">PopRequest</a></code>,
                  <code><a href="#TransactionRequest">TransactionRequest</a></code>
                </td>
              </tr>
              <tr>
                <td><dfn id="handler-request-oncomplete"><code>oncomplete</code></dfn> </td>
                <td> <code><a href="#event-complete">complete</a></code></td>        
                <td> <code><a href="#CursorRequest">CursorRequest</a></code></td>
              </tr>
              <tr>
                <td><dfn id="handler-request-oncommitted"><code>oncommitted</code></dfn> </td>
                <td> <code><a href="#event-commit">commit</a></code></td>        
                <td> <code><a href="#TransactionRequest">TransactionRequest</a></code></td>
              </tr>
              <tr>
                <td><dfn id="handler-request-onaborted"><code>onaborted</code></dfn> </td>
                <td> <code><a href="#event-abort">abort</a></code></td>        
                <td> <code><a href="#TransactionRequest">TransactionRequest</a></code></td>
              </tr>
            </tbody>
          </table>        
          <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="DatabaseErrorEvent">DatabaseErrorEvent</dfn> : Event {
  readonly attribute <a href="#DatabaseError">DatabaseError</a> <a href="#event-error">error</a>;
  
  initEvent(in DOMString typeArg, 
            in boolean canBubbleArg, 
            in boolean cancelableArg, 
            in <a href="#DatabaseError">DatabaseError</a> error);
  initEventNS(in DOMString namespaceURI,
              in DOMString typeArg, 
              in boolean canBubbleArg, 
              in boolean cancelableArg, 
              in <a href="#DatabaseError">DatabaseError</a> error);
};

[Callback=FunctionOnly, NoInterfaceObject]
interface <dfn id="Function">Function</dfn> {
  any <a href="#call">call</a>(in any... arguments);
};</code></pre></div></div>
          <p>The <dfn id="call">call(...)</dfn> method is the object's callback.</p>

          <div class="note"><div class="noteHeader">Note</div>In JavaScript, any <code>Function</code> object implements this interface.</div>
        </div>
      </div>
      
      <div class="section" id="algorithms">
        <h3>3.4. Algorithms</h3>
        <div class="section" id="insertion">
          <h4>3.4.1. Insertion steps</h4>
            The <dfn id="insertion-steps">insertion steps</dfn> are as follows. 
            These steps must be run with three parameters: <var>object</var>, 
            <var>key path</var>, and optional <var>sequence name</var>.
            <ol>
              <li>
                Let <var>key</var> be the property of the <var>object</var> at the 
                <var>key path</var>.
              </li>
              <li>
                If <var>key</var> is defined and not null, then skip the next step.
              </li>
              <li>
                If the <var>sequence name</var> is defined for the insertion steps, 
                then perform the following steps.              
                <ol>
                  <li>
                    If the database does not contain a sequence whose name matches, compared 
                    in a case-sensitive manner, with <var>sequence name</var>, then 
                    throw a newly constructed 
                    <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                    exception (<a href="#code-4">Error code 4</a>)
                    and terminate these steps.
                  </li>
                  <li>
                    Let <var>sequence</var> be the 
                    <a href="#Sequence" class="idltype"><code>Sequence</code></a> object
                    for the <var>sequence name</var> 
                  </li>
                    
                  <li>
                    From the <var>sequence</var> get the next value. Store that value as
                    <var>key</var>.
                  </li>
                  <li>
                    Store <var>key</var> as the property value for the <var>object</var> at the 
                    <var>key path</var>.
                  </li>
                </ol>
              </li>
              
              <li>
                If the <var>key</var> is not defined or null, then throw a newly constructed 
                <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
                exception (<a href="#code-5">Error code 5</a>)
                and terminate these steps.
              </li>
              
              <li>
                Insert the <var>object</var> with <var>key</var> as its key. If any
                indexes are maintained for objects in this entity store, then perform
                the following steps for each index. These steps must be run with three
                parameters: <var>object</var>, <var>key path</var>, and <var>index</var>.
                
                <ol>
                  <li>
                    Let <var>value</var> be the property of the <var>object</var> at the 
                    <var>key path</var>.
                  </li>
                  <li>
                    Let <var>index key path</var> be the key path of <var>index</var>.                             
                  </li>
                  <li>
                    Let <var>key</var> be the property of the <var>object</var> at the 
                    <var>index key path</var>.
                  </li>
                  <li>
                    Insert the <var>value</var> with <var>key</var> as its key in the
                    <var>index</var>.
                  </li>
                </ol>
            </li>
            
            <li>
              Return the <var>key</var>.
            </li>
          </ol>
        </div>
        
        <div id="retrieval" class="section">
          <h4>3.4.2. Retrieval steps</h4>
          <p>
            The <dfn id="retrieval-steps">retrieval steps</dfn> are as follows.
            These steps must be run for retrieving the object with the following
            parameters: <var>key</var>.
          </p>
            
          <ol>
            <li>
              If <var>key</var> is not defined or null, then throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code
              <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a> and terminate these steps.
            </li>            
            <li>
              Use the <var>key</var> to look up an object in the entity store. Let 
              <var>value</var> be that object.
            </li>
            
            <li>
              If <var>object</var> is not found in the entity store, then throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code
              <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a> and terminate these steps.
            </li>
          </ol>
  
          
        </div>
        
        <div id="deletion" class="section">
          <h4>3.4.3. Deletion steps</h4>
          <p>
            The <dfn id="deletion-steps">deletion steps</dfn> are as follows. 
            These steps must be run with one parameter: <var>key</var>, 
            <var>key path</var>, and optional <var>sequence name</var>.
          </p>
          <ol>
            <li>
              If <var>key</var> is not defined or null, then throw a newly constructed 
              <a class="idltype" href="#DatabaseException"><code>DatabaseException</code></a> 
              exception with code
              <a href="#code-not-found"><code>NOT_FOUND_ERR</code></a> and terminate these steps.
            </li>            
            
            <li>
              Use the <var>key</var> to look up an object in the entity store. Let 
              <var>object</var> be that object.
            </li>
            
            <li>
              If any indexes are maintained for objects in this entity store, then perform
              the following steps for each index. These steps must be run with three
              parameters: <var>object</var>, <var>key path</var>, and <var>index</var>.
              
              <ol>
                <li>
                  Let <var>index key path</var> be the key path of <var>index</var>.                             
                </li>
                <li>
                  Let <var>value</var> be the property of the <var>object</var> at the 
                  <var>index key path</var>.
                </li>
                <li>
                  Delete the record for <var>value</var> from <var>index</var>.
                </li>
              </ol>
            </li>
            <li>
              Delete the object stored with the key <var>key</var> in the entity store. 
            </li>
          </ol>
        </div>
      </div>
      
      <div id="database-exception" class="section">
        <h3>3.5. Exceptions and Errors</h3>
        <p>
          Errors in the asynchronous database API are reported using 
          callbacks that have a 
          <a class="idltype" href="#DatabaseError"><code>DatabaseError</code></a> 
          object as one of their arguments.
        </p>
			  <div>
			    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">interface <dfn id="DatabaseError">DatabaseError</dfn> {
  const unsigned short <a href="#code-unknown">UNKNOWN_ERR</a> = 0;
  const unsigned short <a href="#code-non-transient">NON_TRANSIENT_ERR</a> = 1; 
  const unsigned short <a href="#code-version">VERSION_ERR</a> = 2; 
  const unsigned short <a href="#code-not-found">NOT_FOUND_ERR</a> = 3;
  const unsigned short <a href="#code-constraint">CONSTRAINT_ERR</a> = 4;
  const unsigned short <a href="#code-data">DATA_ERR</a> = 5;
  const unsigned short <a href="#code-feature">FEATURE_ERR</a> = 6;
  const unsigned short <a href="#code-serial">SERIAL_ERR</a> = 11;
  const unsigned short <a href="#code-too_large">TOO_LARGE_ERR</a> = 12;
  const unsigned short <a href="#code-recoverable">RECOVERABLE_ERR</a> = 21;<!--
  const unsigned short QUOTA_ERR = 22;-->
  const unsigned shrot <a href="#code-transient">TRANSIENT_ERR</a> = 31;
  const unsigned short <a href="#code-deadlock">TIMEOUT_ERR</a> = 32;
  unsigned short <a href="#error-code">code</a>;
  int <a href="#error-status">status</a>;
  DOMString <a href="#error-message">message</a>;
};</code></pre></div></div>  
          <p>
            The <dfn id="error-code">code</dfn> IDL attribute must return
            the most appropriate code.
          </p>
          
          <p>
            The <dfn id="error-status">status</dfn> IDL attribute must return
            the detailed error status of the database.
          </p>
          
          <p>
            The <dfn id="error-message">message</dfn> IDL attribute must
            return an error message describing the error encountered. 
            The message should be localized to the user's language.
          </p>

			    <div class="block"><div class="blockTitleDiv"><span class="blockTitle">IDL</span></div><div class="blockContent"><pre class="code"><code class="idl-code">exception <dfn id="DatabaseException">DatabaseException</dfn> {
  const unsigned short <a href="#code-unknown">UNKNOWN_ERR</a> = 0;
  const unsigned short <a href="#code-non-transient">NON_TRANSIENT_ERR</a> = 1; 
  const unsigned short <a href="#code-version">VERSION_ERR</a> = 2; 
  const unsigned short <a href="#code-not-found">NOT_FOUND_ERR</a> = 3;
  const unsigned short <a href="#code-constraint">CONSTRAINT_ERR</a> = 4;
  const unsigned short <a href="#code-data">DATA_ERR</a> = 5;
  const unsigned short <a href="#code-feature">FEATURE_ERR</a> = 6;
  const unsigned short <a href="#code-serial">SERIAL_ERR</a> = 11;
  const unsigned short <a href="#code-too_large">TOO_LARGE_ERR</a> = 12;
  const unsigned short <a href="#code-recoverable">RECOVERABLE_ERR</a> = 21;<!--
  const unsigned short QUOTA_ERR = 22;-->
  const unsigned shrot <a href="#code-transient">TRANSIENT_ERR</a> = 31;
  const unsigned short <a href="#code-deadlock">TIMEOUT_ERR</a> = 32;
  unsigned short <a href="#exception-code">code</a>;
  int <a href="#exception-status">status</a>;
  DOMString <a href="#exception-message">message</a>;
};</code></pre></div></div>  

          <p>
            The <dfn id="exception-code">code</dfn> IDL attribute must return
            the most appropriate code.
          </p>
          
          <p>
            The <dfn id="exception-status">status</dfn> IDL attribute must return
            the detailed error status of the database.
          </p>
          
          <p>
            The <dfn id="exception-message">message</dfn> IDL attribute must
            return an error message describing the exception raised. 
            The message should be localized to the user's language.
          </p>
          <p>
            The error codes and their meanings are given below.
          </p>
          <table>
            <thead><tr><th>Constant</th><th>Code</th><th>Situation</th></tr></thead>
            <tbody>
              <tr>
                <td><dfn id="code-unknown"><code>UNKNOWN_ERR</code></dfn></td>
                <td>The operation failed for reasons unrelated to the database
                  itself and not covered by any other error code.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-non-transient"><code>NON_TRANSIENT_ERR</code></dfn></td>
                <td>This error occurred because an operation was not allowed on 
                an object. A retry of the same operation would fail unless the
                cause of the error is corrected.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-version"><code>VERSION_ERR</code></dfn></td>
                <td>The operation failed because the actual database version was
                not what it should be. The <code title="dom-database-sync-changeversion"><a href="#change-version">Transaction.changeVersion()</a></code>
                method was passed a version that doesn't match the actual
                database version.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-not-found"><code>NOT_FOUND_ERR</code></dfn></td>
                <td>The operation failed because the requested database
                object could not be found. For example, an entity store
                did not exist but was being opened, or a sequence was 
                used to create an entity store, but did not exist.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-constraint"><code>CONSTRAINT_ERR</code></dfn></td>
                <td>A mutation operation in the transaction failed due to a
                because a constraint was not satisfied. For example, an
                object such as an entity store, sequence, or index already
                exists and a new one was being attempted to be created.
                In another example, an object was deleted but was required 
                to satisfy the foreign key constraint on a related entity
                store.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-data"><code>DATA_ERR</code></dfn></td>
                <td>Data provided to an operation does not meet requirements,
                e.g., if the increment value for a sequence is set to 0.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-feature"><code>FEATURE_ERR</code></dfn></td>
                <td>A feature defined in this API was used but is not supported
                by the underlying implementation.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-serial"><code>SERIAL_ERR</code></dfn></td>
                <td>The operation failed because of the size of the data set 
                being returned or because there was a problem in serializing or 
                deserializing the object being processed.</td>
              </tr>

              <tr>
                <td><dfn id="code-too_large"><code>TOO_LARGE_ERR</code></dfn></td>
                <td>The operation failed because the data returned from the
                database was too large.</td>
              </tr>
              
              <tr>
                <td><dfn id="code-recoverable"><code>RECOVERABLE_ERR</code></dfn></td>
                <td>The operation failed because the database was prevented
                from taking an action. The operation might be able to succeed
                if the application performs some recovery steps and retries
                the entire transaction. For example, there was not enough 
                remaining storage space, or the storage quota was reached
                and the user declined to give more space to the database.</td>
              </tr>
             
              <!--tr>
                <td><dfn id="code-quota" title="dom-DatabaseException-code-QUOTA"><code>QUOTA_ERR</code></dfn></td>
                <td><dfn id="code-4" title="code-4">4</dfn></td>
                <td>The statement failed because there was not enough remaining
     storage space, or the storage quota was reached and the user
     declined to give more space to the database.</td>
              </tr-->
              <tr>
                <td><dfn id="code-transient"><code>TRANSIENT_ERR</code></dfn></td>
                <td>The operation failed because of some temporary problems.
                The failed operation might be able to succeed when the
                operation is retried without any intervention by 
                application-level functionality.</td>
              </tr>
             
              <tr>
                <td><dfn id="code-timeout"><code>TIMEOUT_ERR</code></dfn></td>
                <td>A lock for the transaction could not be obtained in a
                reasonable time.</td>
              </tr>

              <tr>
                <td><dfn id="code-deadlock"><code>DEADLOCK_ERR</code></dfn></td>
                <td>The current transaction was automatically rolled back
                by the database becuase of deadlock or other transaction
                serialization failures.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>     
      </div> <!-- API -->      
      
      <div id="privacy" class="section">
        <h2>4. Privacy</h2>
        
        <div id="user-tracking" class="section">
          <h3>4.1. User tracking</h3>
          
          <p>
            A third-party host (or any entity capable of getting content 
            distributed to multiple sites) could use a unique identifier 
            stored in its client-side database to track a user across multiple 
            sessions, building a profile of the user's activities. In conjunction
            with a site that is aware of the user's real identity (for 
            example an e-commerce site that requires authenticated credentials),
            this could allow oppressive groups to target individuals with
            greater accuracy than in a world with purely anonymous Web usage.
          </p>
          
          <p>
            There are a number of techniques that can be used to mitigate the
            risk of user tracking:
          </p>
          
          <dl>
            <dt>Blocking third-party storage</dt>
            <dd>
              User agents may restrict access to the database objects
              to scripts originating at the domain of the top-level document of
              the <span>browsing context</span>, for instance denying access to
              the API for pages from other domains running in <code>iframe</code>s.
            </dd>

            <dt>Expiring stored data</dt>
            <dd>
              <p>User agents may automatically delete stored data after a period
              of time.</p>

              <p>This can restrict the ability of a site to track a user, as the
              site would then only be able to track the user across multiple
              sessions when he authenticates with the site itself (e.g. by
              making a purchase or logging in to a service).</p>
          
              <p>However, this also puts the user's data at risk.</p>
            </dd>

            <dt>Treating persistent storage as cookies</dt>
            <dd>          
              <p>User agents should present the database feature
              to the user in a way that associates them strongly with HTTP
              session cookies. <a href="#ref-COOKIES">[COOKIES]</a></p>
          
              <p>This might encourage users to view such storage with healthy
              suspicion.</p>
            </dd>

            <dt>Site-specific white-listing of access to databases</dt>
            <dd>
              <p>User agents may require the user to authorize access to
              databases before a site can use the feature.</p>
            </dd>
        
            <dt>Origin-tracking of stored data</dt>          
            <dd>
              <p>User agents may record the <span title="origin">origins</span>
              of sites that contained content from third-party origins that
              caused data to be stored.</p>
              
              <p>If this information is then used to present the view of data
              currently in persistent storage, it would allow the user to make
              informed decisions about which parts of the persistent storage to
              prune. Combined with a blacklist ("delete this data and prevent
              this domain from ever storing data again"), the user can restrict
              the use of persistent storage to sites that he trusts.</p>
            </dd>
        
            <dt>Shared blacklists</dt>
            <dd>          
              <p>User agents may allow users to share their persistent storage
              domain blacklists.</p>
        
              <p>This would allow communities to act together to protect their
              privacy.</p>
            </dd>
          </dl>
  
          <p>
            While these suggestions prevent trivial use of this API for user
            tracking, they do not block it altogether. Within a single domain, a
            site can continue to track the user during a session, and can then
            pass all this information to the third party along with any
            identifying information (names, credit card numbers, addresses)
            obtained by the site. If a third party cooperates with multiple
            sites to obtain such information, a profile can still be
            created.
          </p>
          
          <p>
            However, user tracking is to some extent possible even with no
            cooperation from the user agent whatsoever, for instance by using
            session identifiers in URLs, a technique already commonly used for
            innocuous purposes but easily repurposed for user tracking (even
            retroactively). This information can then be shared with other
            sites, using using visitors' IP addresses and other user-specific
            data (e.g. user-agent headers and configuration settings) to combine
            separate sessions into coherent user profiles.          
          </p>
        </div>

        <div id="cookie-resurrection" class="section">
          <h3>4.2. Cookie resurrection</h3>
          
          <p>
            If the user interface for persistent storage presents data in the
            persistent storage features described in this specification
            separately from data in HTTP session cookies, then users are likely
            to delete data in one and not the other. This would allow sites to
            use the two features as redundant backup for each other, defeating a
            user's attempts to protect his privacy.
          </p>
        </div>
        
        <div id="sensitivity-of-data" class="section">
          <h3>4.3. Sensitivity of data</h3>
          
          <p>
            User agents should treat persistently stored data as potentially
            sensitive; it's quite possible for e-mails, calendar appointments,
            health records, or other confidential documents to be stored in this
            mechanism.
          </p>
          
          <p>To this end, user agents should ensure that when deleting data,
            it is promptly deleted from the underlying storage.
          </p>
        </div>
      </div> <!-- Privacy -->

      <div id="authorization" class="section">
        <h2>5. Authorization</h2>
        
        <div id="dns-spoofing-attacks" class="section">
          <h3>5.1. DNS spoofing attacks</h3>
          
          <p>
            Because of the potential for DNS spoofing attacks, one cannot
            guarantee that a host claiming to be in a certain domain really is
            from that domain. To mitigate this, pages can use SSL. Pages using
            SSL can be sure that only pages using SSL that have certificates
            identifying them as being from the same domain can access their
            databases.
          </p>
        </div>
    
        <div id="cross-directory-attacks" class="section">
          <h3>5.2. Cross-directory attacks</h3>
          
          <p>
            Different authors sharing one host name, for example users
            hosting content on <code>geocities.com</code>, all share one
            set of databases.
          </p>
          
          <p>
            There is no feature to restrict the access by pathname. Authors on
            shared hosts are therefore recommended to avoid using these
            features, as it would be trivial for other authors to read the data
            and overwrite it.
          </p>
          
          <p class="note">Even if a path-restriction feature was made
            available, the usual DOM scripting security model would make it
            trivial to bypass this protection and access the data from any
            path.
          </p>
        </div>
        
        <div id="implementation-risks" class="section">
          <h3>5.3. Implementation risks</h3>
          
          <p>The two primary risks when implementing these persistent storage
          features are letting hostile sites read information from other
          domains, and letting hostile sites write information that is then
          read from other domains.</p>
          
          <p>Letting third-party sites read data that is not supposed to be
          read from their domain causes <em>information leakage</em>, For
          example, a user's shopping wishlist on one domain could be used by
          another domain for targeted advertising; or a user's
          work-in-progress confidential documents stored by a word-processing
          site could be examined by the site of a competing company.</p>
          
          <p>Letting third-party sites write data to the persistent storage of
          other domains can result in <em>information spoofing</em>, which is
          equally dangerous. For example, a hostile site could add items to a
          user's wishlist; or a hostile site could set a user's session
          identifier to a known ID that the hostile site can then use to track
          the user's actions on the victim site.</p>
          
          <p>Thus, strictly following the <span>origin</span> model described
          in this specification is important for user security.</p>
        </div>
      </div> <!-- authorization -->
    </div> <!-- sections -->
    
    <div id="appendices">
      <div id="references" class="section">
        <h2>A. References</h2>

        <div id="normative-references" class="section">
          <h3>A.1. Normative references</h3>

          <dl>
            <dt id="ref-COOKIES">[COOKIES]</dt>
            <dd>
              <cite><a href="http://tools.ietf.org/html/draft-abarth-cookie">HTTP State
                Management Mechanism</a></cite>, A. Barth. IETF, August 2009.
            </dd>
            <dt><dfn id="ref-HTML5">[HTML5]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/html5/">HTML5: A vocabulary and associated APIs for HTML and XHTML</a></cite>, 
              Ian Hickson, editor, W3C Working Draft, August 2009.
            </dd>
            <dt><dfn id="ref-RFC2119">[RFC2119]</dfn></dt>
            <dd>
              <cite><a href="http://www.ietf.org/rfc/rfc2119.txt">Key words for use in RFCs to Indicate Requirement Levels</a></cite>,
              S. Bradner. IETF, March 1997.
            </dd>
            <dt><dfn id="ref-WebIDL">[WebIDL]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/WebIDL/">Web IDL</a></cite>,
              Cameron McCormack, editor. W3C Working Draft, December 2008.
            </dd>
            <dt><dfn id="ref-WebStorage">[WebStorage]</dfn></dt>
            <dd>
              <cite><a href="http://dev.w3.org/html5/webstorage/">Web Storage</a></cite>,
              Ian Hickson, editor. W3C Working Draft, September 2009.
            </dd>
            <dt><dfn id="ref-WebWorkers">[WebWorkers]</dfn></dt>
            <dd>
              <cite><a href="http://www.w3.org/TR/workers/">Web Workers</a></cite>,
              Ian Hickson, editor. W3C Working Draft, April 2009.
            </dd>
          </dl>
        </div>

        <!--div id='informative-references' class='section'>
          <h3>Informative references</h3>

        </div-->
      </div>
      <div class="section" id="requirements">
        <h2>B. Requirements</h2>
        <div class="ednote"><div class="ednoteHeader">Editorial note</div>
          Requirements will be written with an aim to verify that these were actually
          met by the API specified in this document.
        </div>
      </div>
    </div>
  </body>
</html>
