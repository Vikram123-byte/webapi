<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- http://www.w3.org/mid/op.tlv3d8sp64w2qv@id-c0020 -->

<html lang=en-US>
 <head><meta content="text/html;charset=UTF-8" http-equiv=Content-Type>

  <title>Selectors API</title>

  <style type="text/css">
   pre.idl { border:solid thin; background:#eee; color:#000; padding:0.5em }

   pre.idl :link, pre.idl :visited { color:inherit; background:transparent }
   div.example { border-left:double; padding-left:1em }
   dfn { font-style:normal; font-weight:bolder }
   em.ct { font-style:normal; font-weight:normal; font-variant:small-caps }
   p.note {  margin-left:2em; color:green; font-style:italic; font-weight:bold }
   p.note::before { content:"Note: " }
   .issue { padding:.5em; border:solid red }
   .issue::before { content:"Issue: " }
   code { color:orangered }
   code :link, code :visited { color:inherit }
  </style>
  <link href="http://www.w3.org/StyleSheets/TR/base.css" rel=stylesheet>

 <body>
  <div class=head>
   <p><a href="http://www.w3.org/"><img alt=W3C
    src="http://www.w3.org/Icons/w3c_home"></a></p>

   <h1 id=title>Selectors API</h1>
   <!-- "DOM Selectors" was not acceptable. "DOM Level 4 Selectors" and
   conforming to the DOM specification template (if there is such a thing) is
   just silly so we got stuck with this weird name. -->
   
   <h2 class="no-num no-toc" id=W3C-doctype>Editor's Draft
    <!--W3C Working Draft--> 23 June 2007</h2>

   <dl>
    <dt>This Version:

    <dd><a
     href="http://www.w3.org/TR/2007/WD-selectors-api-20070623">http://www.w3.org/TR/2007/WD-selectors-api-20070623/</a>

    <dt>Latest Version:

    <dd><a
     href="http://www.w3.org/TR/selectors-api/">http://www.w3.org/TR/selectors-api/</a>

    <dt>Previous Versions:

    <dd><a
     href="http://www.w3.org/TR/2006/WD-selectors-api-20060926/">http://www.w3.org/TR/2006/WD-selectors-api-20060926/</a>

    <dd><a
     href="http://www.w3.org/TR/2006/WD-selectors-api-20060525/">http://www.w3.org/TR/2006/WD-selectors-api-20060525/</a>

    <dt>Editors:

    <dd><a href="http://lachy.id.au/">Lachlan Hunt</a> (Invited Expert)
     &lt;<a
     href="mailto:lachlan.hunt@lachy.id.au">lachlan.hunt@lachy.id.au</a>&gt;

    <dd><a href="http://annevankesteren.nl/">Anne van Kesteren</a> (<a
     href="http://www.opera.com/">Opera Software ASA</a>) &lt;<a
     href="mailto:annevk@opera.com">annevk@opera.com</a>&gt;
   </dl>

   <p class=copyright><a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>
    © 2006 <a href="http://www.w3.org/"><abbr title="World Wide Web
    Consortium">W3C</abbr></a><sup>®</sup> (<a
    href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of
    Technology">MIT</abbr></a>, <a href="http://www.ercim.org/"><abbr
    title="European Research Consortium for Informatics and
    Mathematics">ERCIM</abbr></a>, <a
    href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
    <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a>
    and <a
    href="http://www.w3.org/Consortium/Legal/copyright-documents">document
    use</a> rules apply.</p>
  </div>

  <hr>

  <h2 class="no-num no-toc" id=abstract>Abstract</h2>

  <p>The Selectors API specification defines methods for retrieving
   <code>Element</code> nodes from the <abbr title="Document Object
   Model">DOM</abbr> by matching against a group of selectors [<cite><a
   href="#ref-selectors">Selectors</a></cite>]. It is often desirable to
   perform DOM operations on a specific set of elements in a document. These
   methods simplify the process of aquiring specific elements, especially
   compared with the more verbose techniques defined and used in the past.

  <h2 class="no-num no-toc" id=sotd>Status of this Document</h2>

  <p><em>This section describes the status of this document at the time of
   its publication. Other documents may supersede this document. A list of
   current W3C publications and the latest revision of this technical report
   can be found in the <a href="http://www.w3.org/TR/">W3C technical reports
   index</a> at http://www.w3.org/TR/.</em>

  <p>This document is produced by the <a
   href="http://www.w3.org/2006/webapi/">Web API WG</a>, part of the <a
   href="http://www.w3.org/2006/rwc/Activity">Rich Web Clients Activity</a>
   in the W3C <a href="http://www.w3.org/Interaction/">Interaction
   Domain</a>.

  <p>Web content and browser developers are encouraged to review this draft.
   Please send comments to <a
   href="mailto:public-webapi@w3.org">public-webapi@w3.org</a> with
   <kbd>[selectors-api]</kbd> at the start of the subject line. <a
   href="http://lists.w3.org/Archives/Public/public-webapi/">Archives</a> of
   this list are available. The editor's copy of this specification is <a
   href="http://dev.w3.org/cvsweb/~checkout~/2006/webapi/selectors-api/Overview.html?content-type=text/html;%20charset=utf-8">available
   in W3C CVS</a>. A detailed list of changes is also available <a
   href="http://dev.w3.org/cvsweb/2006/webapi/selectors-api/">from the CVS
   server</a>.</p>
  <!-- XXX: dino!!! -->

  <p>Implementors should be aware that this specification is not stable.
   <strong>Implementors who are not taking part in the discussions are likely
   to find the specification changing out from under them in incompatible
   ways.</strong> Vendors interested in implementing this specification
   before it eventually reaches the Candidate Recommendation stage should
   join the aforementioned mailing lists and take part in the discussions.

  <p>This document was produced by a group operating under the <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February
   2004 W3C Patent Policy</a>. W3C maintains a <a
   href="http://www.w3.org/2004/01/pp-impl/38482/status"
   rel=disclosure>public list of any patent disclosures</a> made in
   connection with the deliverables of the group; that page also includes
   instructions for disclosing a patent. An individual who has actual
   knowledge of a patent which the individual believes contains <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
   Claim(s)</a> must disclose the information in accordance with <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
   6 of the W3C Patent Policy</a>.

  <h2 class="no-num no-toc" id=toc>Table of Contents</h2>
  <!--begin-toc-->

  <ul class=toc>
   <li><a href="#introduction"><span class=secno>1. </span>Introduction</a>
    <ul class=toc>
     <li><a href="#examples"><span class=secno>1.1. </span>Examples</a>

     <li><a href="#conformance"><span class=secno>1.2. </span>Conformance
      Requirements</a>
      <ul class=toc>
       <li><a href="#terminology"><span class=secno>1.2.1. </span>Terminology
        and Conventions</a>

       <li><a href="#interoperability"><span class=secno>1.2.2.
        </span>Interoperability Considerations</a>

       <li><a href="#extensibility"><span class=secno>1.2.3.
        </span>Extensibility</a>
      </ul>

     <li><a href="#security"><span class=secno>1.3. </span>Security
      Considerations</a>

     <li><a href="#privacy"><span class=secno>1.4. </span>Privacy
      Considerations </a>
    </ul>

   <li><a href="#documentselector"><span class=secno>2. </span>The <code
    title="">selectElement()</code> and <code
    title="">selectAllElements()</code> methods</a>
    <ul class=toc>
     <li><a href="#nsresolver-interface"><span class=secno>2.1. </span>The
      <code title="">NSResolver</code> Interface</a>

     <li><a href="#staticnodelist"><span class=secno>2.2. </span>The <code
      title="">StaticNodeList</code> Interface</a>
    </ul>

   <li class=no-num><a href="#references">References</a>

   <li class=no-num><a href="#acknowledgements">Acknowledgements</a>
  </ul>
  <!--end-toc-->

  <h2 id=introduction><span class=secno>1. </span>Introduction</h2>

  <p><em>This section is non-normative.</em>

  <p>This specification introduces two methods that take a group of selectors
   (often simply referred to as selector) as an argument and return the
   matching elements [<cite><a href="#ref-selectors">Selectors</a></cite>].
   With these methods, it’s easier to match a set of <code>Element</code>
   nodes based on specific criteria. So instead of having to filter the
   result of a <code>getElementsByTagName()</code> call authors can directly
   “filter” in the query.

  <h3 id=examples><span class=secno>1.1. </span>Examples</h3>

  <p><em>This section is non-normative.</em>

  <p>Some [<cite><a href="#ref-ecma262">ECMAScript</a></cite>] examples:

  <div class=example>
   <pre>&lt;table id="score">
  &lt;thead>
    &lt;tr>
      &lt;th>Test
      &lt;th>Result
  &lt;tfoot>
    &lt;tr>
      &lt;th>Average
      &lt;td>82%
  &lt;tbody>
    &lt;tr>
      &lt;td>A
      &lt;td>87%
    &lt;tr>
      &lt;td>B
      &lt;td>78%
    &lt;tr>
      &lt;td>C
      &lt;td>81%
&lt;/table></pre>

   <p>In order to obtain the cells containing the results in the table, which
    might be done, for example, to plot the values on a graph, there are at
    least two approaches that may be taken. Using only the APIs from DOM
    Level 2, it requires a script like the following that iterates through
    each <code>tr</code> within each <code>tbody</code> in the
    <code>table</code> to find the second cell of each row.</p>

   <pre>var table = document.getElementById("score");
var tbody = table.getElementsByTagName("tbody");
var tr = null;
var cells = new Array();

for (var i = 0; i &lt; tbody.length; i++) {
  tr = tbody[i].getElementsByTagName("tr");
  for (var j = 0; j &lt; tr.length; j++) {
    cells.push(tr[j].getElementsByTagName("td")[1]);
  }
}</pre>

   <p>Alternatively, using the <code title=document-selectallelements><a
    href="#document-selectallelements">selectAllElements()</a></code> method,
    that script becomes much more consise.</p>

   <pre>var cells = document.selectAllElements("#score tbody td:nth-of-type(2)");</pre>
  </div>

  <p class=issue>Need to consider revising the following example.

  <div class=example>
   <pre>&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  &lt;head>
    &lt;title&gt;Selectors API Example&lt;/title&gt;
  &lt;/head>
  &lt;body>
    &lt;p>I like graphics:
       &lt;svg xmlns="http://www.w3.org/2000/svg" … > … &lt;/svg>&lt;/p>
    &lt;p id="x" xmlns:svg="http://www.w3.org/2000/svg">
      They are great:
      &lt;svg:svg … > … &lt;/svg:svg>
    &lt/p>
  &lt;/body>
&lt;/html></pre>

   <p>If you apply the following script to the above XML document …

   <pre>function resolver(prefix) {
  var defaultNS = "";
  var ns = {
    "xh": "http://www.w3.org/1999/xhtml",
    "svg":"http://www.w3.org/2000/svg"
  };
  return (prefix == "") ? defaultNS : ns[prefix];
}

var <var>a</var> = document.selectAllElements("xh|p &gt; svg|svg", resolver);
var <var>b</var> = a.selectElement("svg, span");</pre>

   <p><var>a</var> will be a <code><a
    href="#dom-staticnodelist">StaticNodeList</a></code> containing all the
    <code>svg</code> elements in the <code>http://www.w3.org/2000/svg</code>
    namespace whose parent is the <code>p</code> element in the
    <code>http://www.w3.org/1999/xhtml</code> namespace. <var>b</var> will be
    the first <code>svg</code> or <code>span</code> element which is a
    descendent of the first element in the document with an ID of
    <code>x</code>. So in this case it will be the <code>svg</code> element.</p>

   <pre>function test() {
  var d = document.selectAllElements(":root"),
      e = document.documentElement;
  return d[0] === e;
}</pre>

   <p><code>test()</code> would return <code>true</code> when both <code
    title=document-selectallelements><a
    href="#document-selectallelements">selectAllElements()</a></code> and
    <code>:root</code> are supported. Note that this example is just to
    illustrate how it would work. In the real world you would use <code
    title=document-selectelement><a
    href="#document-selectelement">selectElement()</a></code> for things that
    can only yield a single result and for selecting the root element you
    would simply use <code>document.documentElement</code>.</p>

   <pre>var <var>f</var> = document.selectAllElements("p.warning, p.alert");</pre>

   <p>The above code snippet shows that besides using a single selector you
    can also pass a group of selectors (basically comma-separated selectors)
    as the argument. <var>f</var> would contain a <code><a
    href="#dom-staticnodelist">StaticNodeList</a></code> with all
    <code>p</code> elements in the document that have a <code>warning</code>
    or <code>alert</code> class.</p>

   <pre>var <var>g</var> = document.selectElement("#foo, #bar");</pre>

   <p><var>g</var> would contain the first element in the document either
    having an ID of <code>foo</code> or <code>bar</code> (or both).</p>
  </div>

  <h3 id=conformance><span class=secno>1.2. </span>Conformance Requirements</h3>

  <p>All diagrams, examples and notes in this specification are
   non-normative, as are all sections explicitly marked non-normative.
   Everything else in this specification is normative.

  <p>The key words <em class=ct>must</em>, <em class=ct>must not</em>, <em
   class=ct>required</em>, <em class=ct>shall</em>, <em class=ct>shall
   not</em>, <em class=ct>should</em>, <em class=ct>should not</em>, <em
   class=ct>recommended</em>, <em class=ct>may</em>, and <em
   class=ct>optional</em> in the normative parts of this document are to be
   interpreted as described in [<cite><a
   href="#ref-rfc2119">RFC2119</a></cite>].

  <p>The following conformance classes are defined (and considered) by this
   specification:

  <dl>
   <dt><dfn id=conforming-implementation>conforming implementation</dfn>

   <dd>A user agent that implements all interfaces described in this
    specification and follows all <em class=ct>must</em>-, <em
    class=ct>required</em>- and <em class=ct>shall</em>-level of critera in
    this specification that apply to implementations.

   <dt><dfn id="conforming document">conforming document</dfn>

   <dd>A document that follows all <em class=ct>must</em>-, <em
    class=ct>required</em>- and <em class=ct>shall</em>-level of critera in
    this specification that apply to documents.

   <dt><dfn id=conforming-authoring-tool>conforming authoring tool</dfn>

   <dd>One that produces conforming documents.
  </dl>

  <h4 id=terminology><span class=secno>1.2.1. </span>Terminology and
   Conventions</h4>

  <p>The terminology used in this specification is that from [<cite><a
   href="#ref-selectors">Selectors</a></cite>].

  <p>The algorithms described in this specification are there for clarity.
   User agents are not required to follow them as long as the result is the
   same. In doing so, user agents <a href="#interoperability">may</a> assume
   that the object implementing the <code><a
   href="#nsresolver">NSResolver</a></code> interface (or ECMAScript
   <code>Function</code>) only relies on scoped variables, doesn't invoke
   processes outside the object and returns consistent results when its
   <code><a href="#lookupnamespaceuri">lookupNamespaceURI</a></code> method
   is invoked.

  <h4 id=interoperability><span class=secno>1.2.2. </span>Interoperability
   Considerations</h4>

  <p>User agents are allowed to optimize the algorithms described within this
   specification. This entails that some might use the object implementing
   the <code><a href="#nsresolver">NSResolver</a></code> interface more than
   others. If the object (or ECMAScript <code>Function</code>) causes side
   effects this might lead to interoperability concerns. The same goes for
   retrieving different results each time the method is invoked using the
   same prefix as the argument. Authors are strongly discouraged from
   creating content that does that.

  <div class=example>
   <pre>var <var>x</var> = document.selectAllElements("test|*:empty > test|p", resolver)
function resolver(prefix) {
  sideEffect();
  if("test" == prefix)
    return "http://example.org/test"
}</pre>

   <p>Some user agents may have decided not to <a
    href="#resolve-namespace-prefix">resolve namespace prefixes</a> in order
    to determine <var>x</var>. This causes <code>sideEffect()</code> to not
    be invoked.</p>
  </div>

  <h4 id=extensibility><span class=secno>1.2.3. </span>Extensibility</h4>

  <p><em>This section is non-normative.</em>

  <p>Extensions of the APIs defined in this specification are <em>strongly
   discouraged</em>. User agents, Working Groups and other interested parties
   should discuss extensions on a relevant public forum, such as <a
   href="mailto:public-webapi@w3.org">public-webapi@w3.org</a>.

  <h3 id=security><span class=secno>1.3. </span>Security Considerations</h3>

  <p>It is expected that implementing this specification introduces no new
   security risks for users.

  <p>User agents <em class=ct>should</em> ensure they remain stable when
   facing a hostile <code><a href="#nsresolver">NSResolver</a></code> object.
   Potential hostile things such an object could do include:

  <ul>
   <li>Returning inconsistent results;

   <li>Hanging;

   <li>Changing the DOM during the operation.
  </ul>

  <h3 id=privacy><span class=secno>1.4. </span>Privacy Considerations</h3>

  <p>History theft is a potential privacy issue because the
   <code>:visited</code> pseudo-class in [<cite><a
   href="#ref-selectors">Selectors</a></cite>] allows authors to query which
   links have been visited.

  <p class=note>This is not a new problem, as it can already be exploited
   using existing CSS and DOM APIs, such as <code>getComputedStyle()</code>
   [<cite><a href="#ref-dom2style">DOM2Style</a></cite>].

  <div class=example>
   <p>In this example, <var>vlinks</var> will aquire a list of links that the
    user has visited. The author can then obtain the URIs and potentially
    exploit this knowledge.</p>

   <pre>var vlinks = document.selectAllElements(":visited");
for (var i = 0; i &lt; vlinks.length; i++) {
  doSomethingEvil(vlinks[i].href);
}</pre>
  </div>

  <p>As <a href="http://www.w3.org/TR/css3-selectors/#link">defined in
   <cite>Selectors</cite></a>, user agents may treat all links as unvisited
   links, or implement other measures to preserve the user's privacy.

  <h2 id=documentselector><span class=secno>2. </span>The <code
   title="">selectElement()</code> and <code
   title="">selectAllElements()</code> methods</h2>

  <p>Objects implementing the <code>Document</code> interface <em
   class=ct>must</em> also implement the <code><a
   href="#dom-document-selector">DocumentSelector</a></code> interface.
   Likewise objects implementing the <code>Element</code> interface <em
   class=ct>must</em> also implement the <code><a
   href="#dom-element-selector">ElementSelector</a></code> interface.
   [<cite><a href="#ref-dom3core">DOM3Core</a></cite>]

  <pre
   class=idl>interface <dfn id=dom-document-selector>DocumentSelector</dfn> {
  Node            <a href="#document-selectelement" title=document-selectelement>selectElement</a>(in DOMString <var>selectors</var>);
  Node            <a href="#document-selectelement" title=document-selectelement>selectElement</a>(in DOMString <var>selectors</var>, in <a href="#nsresolver">NSResolver</a> <var title="">nsresolver</var>);
  <a href="#dom-staticnodelist">StaticNodeList</a>  <a href="#document-selectallelements" title=document-selectallelements>selectAllElements</a>(in DOMString <var>selectors</var>);
  <a href="#dom-staticnodelist">StaticNodeList</a>  <a href="#document-selectallelements" title=document-selectallelements>selectAllElements</a>(in DOMString <var>selectors</var>, in <a href="#nsresolver">NSResolver</a> <var title="">nsresolver</var>);
};

interface <dfn id=dom-element-selector>ElementSelector</dfn> {
  Node            <a href="#element-selectelement" title=element-selectelement>selectElement</a>(in DOMString <var>selectors</var>);
  Node            <a href="#element-selectelement" title=element-selectelement>selectElement</a>(in DOMString <var>selectors</var>, in <a href="#nsresolver">NSResolver</a> <var title="">nsresolver</var>);
  <a href="#dom-staticnodelist">StaticNodeList</a>  <a href="#element-selectallelements" title=element-selectallelements>selectAllElements</a>(in DOMString <var>selectors</var>);
  <a href="#dom-staticnodelist">StaticNodeList</a>  <a href="#element-selectallelements" title=element-selectallelements>selectAllElements</a>(in DOMString <var>selectors</var>, in <a href="#nsresolver">NSResolver</a> <var title="">nsresolver</var>);
}
</pre>

  <p>The <dfn id=document-selectelement
   title=document-selectelement><code>selectElement()</code></dfn> methods on
   the <code><a href="#dom-document-selector">DocumentSelector</a></code>
   interface <em class=ct>must</em>, when invoked, return the first
   <code>Element</code> node within the document, in document order (using
   depth-first pre-order traversal), that matches the group of selectors
   (<var>selectors</var>), if any. Otherwise it <em class=ct>must</em> return
   <code>null</code>.

  <p>The <dfn id=element-selectelement
   title=element-selectelement><code>selectElement()</code></dfn> methods on
   the <code><a href="#dom-element-selector">ElementSelector</a></code>
   interface <em class=ct>must</em>, when invoked, return the first
   <code>Element</code> node in document order (using depth-first pre-order
   traversal) that is a descendant of the element on which the method was
   invoked and matches the group of selectors (<var>selectors</var>), if any.
   Otherwise it <em class=ct>must</em> return <code>null</code>.

  <p>The <dfn id=document-selectallelements
   title=document-selectallelements><code>selectAllElements()</code></dfn>
   methods on the <code><a
   href="#dom-document-selector">DocumentSelector</a></code> interface <em
   class=ct>must</em>, when invoked, return a <code><a
   href="#dom-staticnodelist">StaticNodeList</a></code> of all the
   <code>Element</code> nodes within the document that match the group of
   selectors (<var>selectors</var>) in document order, if any. Otherwise it
   <em class=ct>must</em> return an empty <code><a
   href="#dom-staticnodelist">StaticNodeList</a></code>.

  <p>The <dfn id=element-selectallelements
   title=element-selectallelements><code>selectAllElements()</code></dfn>
   methods on the <code><a
   href="#dom-element-selector">ElementSelector</a></code> interface <em
   class=ct>must</em>, when invoked, return a <code><a
   href="#dom-staticnodelist">StaticNodeList</a></code> of all the
   <code>Element</code> nodes that are descendants of the element on which
   the method was invoked and matches the group of selectors
   (<var>selectors</var>), if any. Otherwise it <em class=ct>must</em> return
   an empty <code><a href="#dom-staticnodelist">StaticNodeList</a></code>.

  <p>Both <code title=document-selectelement><a
   href="#document-selectelement">selectElement()</a></code> and <code
   title=document-selectallelements><a
   href="#document-selectallelements">selectAllElements()</a></code> take a
   group of selectors (<var>selectors</var>) as the first argument and
   optionally an <code><a href="#nsresolver">NSResolver</a></code> (<var
   title="">nsresolver</var>) as the second. User agents <em
   class=ct>must</em> use the <var title="">nsresolver</var> argument to <a
   href="#resolve-namespace-prefix">resolve namespace prefixes</a> to
   namespaces or to <a href="#get-default-namespace">get the default
   namespace</a>. When the <var title="">nsresolver</var> argument is
   <code>null</code> user agents <em class=ct>must</em> ignore it. [<cite><a
   href="#ref-selectors">Selectors</a></cite>]

  <p>When authors use namespace prefixes within <var>selectors</var> or wish
   to set a default namespace, they <em class=ct>must</em> create an object
   implementing the <code><a href="#nsresolver">NSResolver</a></code>
   interface (or a <code>Function</code> in the case of ECMAScript) and pass
   that as the argument for <var title="">nsresolver</var>. Otherwise,
   authors <em class=ct>may</em> set the argument to <code>null</code> or
   omit it if the language binding permits.

  <p>If the given group of selectors (<var>selectors</var>) is invalid, the
   user agent <em class=ct>must</em> raise a <code>SYNTAX_ERR</code>
   exception.

  <p>An <dfn id=unresolvable-namespace>unresolvable namespace</dfn> is a
   namespace that cannot be resolved because there was no <code><a
   href="#nsresolver">NSResolver</a></code> provided or the given <code><a
   href="#nsresolver">NSResolver</a></code> does not return a namespace for
   the namespace prefix. When an unresolvable namespace is encountered, a
   <code>NAMESPACE_ERR</code> exception <em class=ct>must</em> be raised.

  <p class=note>Not defining a default namespace is ok.

  <p>In languages that support optional arguments for methods, like
   ECMAScript, omitting the <var title="">nsresolver</var> argument in either
   the <code title=document-selectelement><a
   href="#document-selectelement">selectElement()</a></code> or <code
   title=document-selectallelements><a
   href="#document-selectallelements">selectAllElements()</a></code> method
   <em class=ct>must</em> return the same result as if the method was invoked
   with the <var title="">nsresolver</var> argument being <code>null</code>.

  <p class=note>Using pseudo-elements in one of the selectors could mean that
   nothing is returned for that particular selector when it doesn't resolve
   in one or more <code>Element</code> nodes..

  <h3 id=nsresolver-interface><span class=secno>2.1. </span>The <code
   title="">NSResolver</code> Interface</h3>

  <p>The <code><a href="#nsresolver">NSResolver</a></code> interface allows
   prefixes to be bound to a namespace URI. The object implementing this
   interface is expected to be implemented by authors.

  <p class=note>Other specifications may introduce methods that return an
   object implementing <code><a href="#nsresolver">NSResolver</a></code> in
   which case it would be implemented by the user agent.

  <pre class=idl>interface <dfn id=nsresolver>NSResolver</dfn> {
  DOMString          <a href="#lookupnamespaceuri">lookupNamespaceURI</a>(in DOMString <var>prefix</var>);
};</pre>

  <p>The <dfn id=lookupnamespaceuri
   title=lookupnamespaceuri><code>lookupNamespaceURI(<var>prefix</var>)</code></dfn>
   method <em class=ct>must</em> return the namespace belonging to the prefix
   (<var>prefix</var>) or the default namespace if the <var>prefix</var>
   argument is either <code>null</code> or an empty string.

  <p>To <dfn id=resolve-namespace-prefix>resolve namespace prefixes</dfn>
   user agents <em class=ct>must</em> pass the prefix, preserving case, to
   the <code><a href="#lookupnamespaceuri">lookupNamespaceURI()</a></code>
   method. User agents must handle prefixes case sensitively. If the method
   does not return a <code>DOMString</code>, the prefix represents an <a
   href="#unresolvable-namespace">unresolvable namespace</a>. Otherwise, the
   return value is the namespace for the given prefix.

  <p class=note>The case sensitivity of namespace prefixes is effectively
   determined by the implementation of the <code><a
   href="#nsresolver">NSResolver</a></code> object that is used to resolve
   the namespaces.

  <p class=note>In Unicode, caseless matching requires both strings that are
   being compared, to be case folded prior to performing a binary comparison
   [<cite><a href="#ref-casemap">CaseMap</a></cite>]. However, since case
   folding is not the same as simply uppercasing or lowercasing both strings
   and because the comparison is being performed by the <code><a
   href="#nsresolver">NSResolver</a></code> object implemented by the author,
   this specification cannot require case insensitive namespace prefixes.

  <p>To <dfn id=get-default-namespace>get the default namespace</dfn> user
   agents <em class=ct>must</em> invoke the <code><a
   href="#lookupnamespaceuri">lookupNamespaceURI()</a></code> method with the
   empty string as the argument. If the method returns an empty string,
   <code>null</code>, or does not return a value (<code>void</code>), then
   there is no default namespace. Otherwise, if the method does not return a
   <code>DOMString</code>, the default namespace is an <a
   href="#unresolvable-namespace">unresolvable namespace</a>. Otherwise, the
   return value is the default namespace.

  <p>The number of times that a user agent may invoke the <code><a
   href="#lookupnamespaceuri">lookupNamespaceURI()</a></code> method with
   each prefix and the order in which prefixes are resolved is not defined by
   this specification.

  <p>When the <code><a
   href="#lookupnamespaceuri">lookupNamespaceURI()</a></code> method is
   invoked with a prefix as the argument, authors <em class=ct>must</em>
   ensure that it returns the namespace URI for the given prefix. When the
   <code><a href="#lookupnamespaceuri">lookupNamespaceURI()</a></code> method
   is invoked with an empty string as the argument (representing the default
   namespace), it <em class=ct>must</em> do either of the following:

  <ul>
   <li>If there is a default namespace, it <em class=ct>must</em> return the
    default namespace URI.

   <li>If there is no default namespace, it <em class=ct>must</em> return
    either <code>null</code>, the empty string, or (if permitted by the
    language binding) no return value (<code>void</code>).<br>
  </ul>

  <p>Authors are strongly encouraged to ensure that the method returns
   consistent results each time it is invoked.

  <p>In ECMAScript (and languages that allow similar constructs), this object
   <em class=ct>may</em> be implemented as a <code>Function</code>. In such
   languages, user agents <em class=ct>must</em> support <code><a
   href="#nsresolver">NSResolver</a></code> being implemented as a
   <code>Function</code>.

  <div class=example>
   <p>The <code><a href="#nsresolver">NSResolver</a></code> may be
    implemented as an object with a <code><a
    href="#lookupnamespaceuri">lookupNamespaceURI</a></code> method.</p>

   <pre>var resolver = {
  lookupNamespaceURI: function(prefix) {
    var defaultNS = "";
    var ns = {
      "xh"  :"http://www.w3.org/1999/xhtml",
      "svg" :"http://www.w3.org/2000/svg",
      "xbl" :"http://www.w3.org/ns/xbl",
      "math":"http://www.w3.org/1998/Math/MathML"
    };
    return (prefix == "") ? defaultNS : ns[prefix];
  }
}</pre>

   <p>For convenience, in ECMAScript, the <code><a
    href="#nsresolver">NSResolver</a></code> may also be implemented as a
    function. In the above example, namespace prefixes are resolved case
    sensitively. If case insensitve namespace prefixes are desired, it is
    possible to implement this in the resolver by altering the case of the
    prefix before comparison.</p>

   <pre>function resolver(prefix) {
  var defaultNS = "";
  var ns = {
    "xh"  :"http://www.w3.org/1999/xhtml",
    "svg" :"http://www.w3.org/2000/svg",
    "xbl" :"http://www.w3.org/ns/xbl",
    "math":"http://www.w3.org/1998/Math/MathML"
  };
  return (prefix == "") ? defaultNS : ns[prefix.toLowerCase()];
}</pre>

   <p>Using the case insensitive namespace resolver, the prefix
    <code>xh</code> will be resolved as
    <code>http://www.w3.org/1999/xhtml</code> and <code>SVG</code> as
    <code>http://www.w3.org/2000/svg</code>.</p>

   <pre>document.selectAllElements(&quot;xh|p SVG|svg&quot;, resolver);</pre>

   <p>In the following example, the <code>foo</code> namespace is undefined
    and will result in an unresolvable namespace. The
    <code>NAMESPACE_ERR</code> exception can be handled using a
    <code>try</code>/<code>catch</code> block.</p>

   <pre>try {
  document.selectAllElements(&quot;foo|bar&quot;, resolver);
} catch (e) {
  switch (e.code) {
  case DOMException.NAMESPACE_ERR:
    // Namespace error
    break;
  case DOMException.SYNTAX_ERR:
    // Syntax error
    break;
  default:
    // Unknown error
  }
}</pre>

   <p>Authors are adivsed that writing namespace resolvers that return
    inconsistent results each time they are invoked may result in
    non-interoperable behaviour.</p>

   <pre>var i = 0;
function resolver(prefix) {

  var ns = ["http://example.org/foo",
            "http://example.org/bar",
            "http://example.org/baz"]
  return ns[i++];
}

var <var>x</var> = document.selectAllElements(&quot;foo|x, foo|y, bar|z", resolver);
</pre>

   <p>Depending on the order in which namespace prefixes are resolved and the
    number of times the resolver is invoked to for the <code>foo</code>
    prefix, this could result in selecting <code>x</code>, <code>y</code> and
    <code>z</code> elements from almost any combination of namespaces that
    may be returned. The result is unpredictable and different results may
    occur in different user agents.</p>
  </div>

  <h3 id=staticnodelist><span class=secno>2.2. </span>The <code
   title="">StaticNodeList</code> Interface</h3>

  <pre
   class=idl>typedef <dfn id=dom-staticnodelist>StaticNodeList</dfn> NodeList;</pre>

  <p>The <code><a href="#dom-staticnodelist">StaticNodeList</a></code> <em
   class=ct>must</em> be implemented identically to the <code>NodeList</code>
   interface as defined in [<cite><a
   href="#ref-dom3core">DOM3Core</a></cite>] with the exception that the
   interface, as the name suggests, is static and not live.

  <div class=example>
   <p>This example demonstrates how to iterate through the items in a
    <code><a href="#dom-staticnodelist">StaticNodeList</a></code>.</p>

   <pre>var lis = document.selectAllElements(&quot;ul.nav&gt;li&quot;);
for (var i = 0; i &lt; items.length; i++) {
  process(lis.item(i));
}</pre>

   <p>In ECMAScript, the language binding also allows <code>NodeList</code>s
    and <code><a href="#dom-staticnodelist">StaticNodeList</a></code>s to be
    addressed using the array notation, so that loop could be rewritten like
    this:</p>

   <pre>for (var i = 0; i &lt; items.length; i++) {
  process(lis[i]);
}</pre>

   <p>Since a <code><a href="#dom-staticnodelist">StaticNodeList</a></code>
    is not live, changes to the DOM do not affect the content of the list.
    Consider the <code>process()</code> function called in the previous
    examples is defined as follows:</p>

   <pre>funtction process(elmt) {
  elmt.parentNode.removeChild(elmt);

}</pre>

   <p>This would cause each selected element to be removed from the DOM, but
    each element will remain in the <code><a
    href="#dom-staticnodelist">StaticNodeList</a></code>. If the list were a
    live <code>NodeList</code>, removing an item from the DOM would also
    remove the element from the list and adjust the indexes of subsequent
    elements. That would have adverse effects upon the loop because not all
    selected elements would be processed.</p>
  </div>

  <h2 class=no-num id=references>References</h2>

  <dl>
   <dt id=ref-css21>[CaseMap]

   <dd>(Informative) <a
    href="http://unicode.org/reports/tr21/tr21-5.html">Unicode Standard Annex
    #21 Case Mappings</a>, M. Davis, editor, Unicode Consortium, March 2001.

   <dt id=ref-dom3core>[DOM2Style]

   <dd>(Informative) <cite><a
    href="http://www.w3.org/TR/DOM-Level-2-Style/">Document Object Model
    (DOM) Level 2 Style Specification</a></cite>, C. Wilson, P. Le Hégaret,
    V. Apparao, editors. World Wide Web Consortium, November 2000.

   <dt id=ref-dom3core>[DOM3Core]

   <dd><cite><a href="http://www.w3.org/TR/DOM-Level-3-Core">Document Object
    Model (DOM) Level 3 Core Specification</a></cite>, A. Le Hors, P. Le
    Hégaret, L. Wood, G. Nicol, J. Robie, M. Champion, S. Byrne, editors.
    World Wide Web Consortium, April 2004.

   <dt id=ref-ecma262>[ECMAScript]

   <dd><cite><a
    href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ECMAScript
    Language Specification</a></cite>, Third Edition. ECMA, December 1999.

   <dt id=ref-selectors>[Selectors]

   <dd><cite><a
    href="http://www.w3.org/TR/css3-selectors">Selectors</a></cite>, D.
    Glazman, T. Çelik, I. Hickson, P. Linss, J. Williams, editors. World
    Wide Web Consortium, December 2005.

   <dt id=ref-rfc2119>[RFC2119]

   <dd><cite><a href="http://ietf.org/rfc/rfc2119">RFC 2119: Key words for
    use in RFCs to Indicate Requirement Levels</a></cite>, S. Bradner. IETF,
    March 1997.
  </dl>

  <h2 class=no-num id=acknowledgements>Acknowledgements</h2>

  <p>The editor would like to thank to the following people who have
   contributed to this specification (ordered on first name):

  <ul>
   <li>Alex Russell

   <li>Björn Höhrmann

   <li>Cameron McCormack

   <li>Charles McCathieNevile

   <li>Chris Wilson

   <li>Daniel Schierbeck

   <li>Dave Massy

   <li>Dean Jackson

   <li>Ian Hickson

   <li>Jim Ley

   <li>Jonas Sicking

   <li>Jorgen Horstink

   <li>Karl Dubost

   <li>Maciej Stachowiak

   <li>Mohamed Zergaoui

   <li>Robert Sayre

   <li>Robin Berjon

   <li>Simon Pieters

   <li>Tarquin Wilton-Jones

   <li>Travis Leithead
  </ul>

  <p>Thanks to all those who have helped to improve this specification by
   sending suggestions and corrections. (Please, keep bugging us with your
   issues!)
