<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html lang=en-US>
 <head>
  <title>XMLHttpRequest Level 2</title>

  <style type="text/css">
   pre.idl { border:solid thin; background:#eee; color:#000; padding:0.5em }
   pre.idl :link, pre.idl :visited { color:inherit; background:transparent }
   pre code { color:inherit; background:transparent }
   div.example { margin-left:1em; padding-left:1em; border-left:double; color:#222; background:#fcfcfc }
   .note { margin-left:2em; font-weight:bold; font-style:italic; color:#008000 }
   p.note::before { content:"Note: " }
   .XXX { padding:.5em; border:solid #f00 }
   p.XXX::before { content:"Issue: " }
   dl.switch { padding-left:2em }
   dl.switch > dt { text-indent:-1.5em }
   dl.switch > dt:before { content:'\21AA'; padding:0 0.5em 0 0; display:inline-block; width:1em; text-align:right; line-height:0.5em }
   em.ct { text-transform:lowercase; font-variant:small-caps; font-style:normal }
   dfn { font-weight:bold; font-style:normal }
   code { color:orangered }
   code :link, code :visited { color:inherit }
   hr:not(.top) { display:block; background:none; border:none; padding:0; margin:2em 0; height:auto }
   table { border-collapse:collapse; border-style:hidden hidden none hidden }
   table thead { border-bottom:solid }
   table tbody th:first-child { border-left:solid }
   table td, table th { border-left:solid; border-right:solid; border-bottom:solid thin; vertical-align:top; padding:0.2em }
  </style>
  <link href="http://www.w3.org/StyleSheets/TR/W3C-ED" rel=stylesheet>

 <body>
  <div class=head>
   <p><a href="http://www.w3.org/"><img alt=W3C height=48
    src="http://www.w3.org/Icons/w3c_home" width=72></a></p>

   <h1 class=head id=xmlhttprequest-level-2>XMLHttpRequest Level 2</h1>

   <h2 class="no-num no-toc" id=w3c-doctype>Editor's Draft 16 February 2010</h2>

   <dl>
    <dt>This Version:

    <dd><a
     href="http://www.w3.org/TR/2010/ED-XMLHttpRequest2-20100216/">http://www.w3.org/TR/2010/ED-XMLHttpRequest2-20100216/</a>

    <dt>Latest Version:

    <dd><a
     href="http://www.w3.org/TR/XMLHttpRequest2/">http://www.w3.org/TR/XMLHttpRequest2/</a>

    <dt>Latest Editor Version:

    <dd><a
     href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/">http://dev.w3.org/2006/webapi/XMLHttpRequest-2/</a>

    <dt>Previous Versions:

    <dd><a
     href="http://www.w3.org/TR/2009/WD-XMLHttpRequest2-20090820/">http://www.w3.org/TR/2009/WD-XMLHttpRequest2-20090820/</a>

    <dd><a
     href="http://www.w3.org/TR/2008/WD-XMLHttpRequest2-20080930/">http://www.w3.org/TR/2008/WD-XMLHttpRequest2-20080930/</a>

    <dd><a
     href="http://www.w3.org/TR/2008/WD-XMLHttpRequest2-20080225/">http://www.w3.org/TR/2008/WD-XMLHttpRequest2-20080225/</a>

    <dt>Editor:

    <dd><a href="http://annevankesteren.nl/">Anne van Kesteren</a> (<a
     href="http://www.opera.com/">Opera Software ASA</a>) &lt;<a
     href="mailto:annevk@opera.com">annevk@opera.com</a>&gt;
   </dl>

   <p class=copyright><a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>
    &copy; 2009 <a href="http://www.w3.org/"><acronym title="World Wide Web
    Consortium">W3C</acronym></a><sup>&reg;</sup> (<a
    href="http://www.csail.mit.edu/"><acronym title="Massachusetts Institute
    of Technology">MIT</acronym></a>, <a
    href="http://www.ercim.org/"><acronym title="European Research Consortium
    for Informatics and Mathematics">ERCIM</acronym></a>, <a
    href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
    <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a>
    and <a
    href="http://www.w3.org/Consortium/Legal/copyright-documents">document
    use</a> rules apply.</p>
  </div>

  <hr>

  <h2 class="no-num no-toc" id=specabstract>Abstract</h2>

  <p>The XMLHttpRequest Level 2 specification enhances the <code
   title="">XMLHttpRequest</code> object with new features, such as
   cross-origin requests, progress events, and the handling of byte streams
   for both sending and receiving.

  <h2 class="no-num no-toc" id=sotd>Status of this Document</h2>

  <p><em>This section describes the status of this document at the time of
   its publication. Other documents may supersede this document. A list of
   current W3C publications and the latest revision of this technical report
   can be found in the <a href="http://www.w3.org/TR/">W3C technical reports
   index</a> at http://www.w3.org/TR/.</em>

  <p>This is the 16 February 2010 <!--Last Call Working Draft-->Editor's
   Draft of XMLHttpRequest Level 2. Please send comments to <a
   href="mailto:public-webapps@w3.org?subject=[XHR2]%20">public-webapps@w3.org</a>
   (<a
   href="http://lists.w3.org/Archives/Public/public-webapps/">archived</a>)
   with <samp>[XHR2]</samp> at the start of the subject line.

  <p>This document is produced by the <a
   href="http://www.w3.org/2008/webapps/">Web Applications</a> (WebApps)
   Working Group. The WebApps Working Group is part of the <a
   href="http://www.w3.org/2006/rwc/Activity">Rich Web Clients Activity</a>
   in the W3C <a href="http://www.w3.org/Interaction/">Interaction
   Domain</a>.

  <p>This document was produced by a group operating under the <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February
   2004 W3C Patent Policy</a>. W3C maintains a <a
   href="http://www.w3.org/2004/01/pp-impl/42538/status"
   rel=disclosure>public list of any patent disclosures</a> made in
   connection with the deliverables of the group; that page also includes
   instructions for disclosing a patent. An individual who has actual
   knowledge of a patent which the individual believes contains <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
   Claim(s)</a> must disclose the information in accordance with <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
   6 of the W3C Patent Policy</a>.

  <p>Publication as a Working Draft does not imply endorsement by the W3C
   Membership. This is a draft document and may be updated, replaced or
   obsoleted by other documents at any time. It is inappropriate to cite this
   document as other than work in progress.

  <h2 class="no-num no-toc" id=toc>Table of Contents</h2>
  <!--begin-toc-->

  <ul class=toc>
   <li><a href="#introduction"><span class=secno>1. </span>Introduction</a>

   <li><a href="#conformance"><span class=secno>2. </span>Conformance
    Criteria</a>
    <ul class=toc>
     <li><a href="#dependencies"><span class=secno>2.1.
      </span>Dependencies</a>

     <li><a href="#terminology"><span class=secno>2.2. </span>Terminology</a>
      

     <li><a href="#extensibility"><span class=secno>2.3.
      </span>Extensibility</a>
    </ul>

   <li><a href="#the-xmlhttprequest-interface"><span class=secno>3.
    </span>The <code title="">XMLHttpRequest</code> Interface</a>
    <ul class=toc>
     <li><a href="#origin-and-base-url"><span class=secno>3.1. </span>Origin
      and Base URL</a>

     <li><a href="#task-sources"><span class=secno>3.2. </span>Task
      Sources</a>

     <li><a href="#constructors"><span class=secno>3.3.
      </span>Constructors</a>

     <li><a href="#event-handler-attributes"><span class=secno>3.4.
      </span>Event Handler Attributes</a>

     <li><a href="#states"><span class=secno>3.5. </span>States</a>

     <li><a href="#request"><span class=secno>3.6. </span>Request</a>
      <ul class=toc>
       <li><a href="#the-open-method"><span class=secno>3.6.1. </span>The
        <code title="">open()</code> method</a>

       <li><a href="#the-setrequestheader-method"><span class=secno>3.6.2.
        </span>The <code title="">setRequestHeader()</code> method</a>

       <li><a href="#the-timeout-attribute"><span class=secno>3.6.3.
        </span>The <code title="">timeout</code> attribute</a>

       <li><a href="#the-withcredentials-attribute"><span class=secno>3.6.4.
        </span>The <code title="">withCredentials</code> attribute</a>

       <li><a href="#the-upload-attribute"><span class=secno>3.6.5.
        </span>The <code title="">upload</code> attribute</a>

       <li><a href="#the-send-method"><span class=secno>3.6.6. </span>The
        <code title="">send()</code> method</a>

       <li><a href="#infrastructure-for-the-send-method"><span
        class=secno>3.6.7. </span>Infrastructure for the <code
        title="">send()</code> method</a>

       <li><a href="#the-abort-method"><span class=secno>3.6.8. </span>The
        <code title="">abort()</code> method</a>
      </ul>

     <li><a href="#response"><span class=secno>3.7. </span>Response</a>
      <ul class=toc>
       <li><a href="#the-status-attribute"><span class=secno>3.7.1.
        </span>The <code title="">status</code> attribute</a>

       <li><a href="#the-statustext-attribute"><span class=secno>3.7.2.
        </span>The <code title="">statusText</code> attribute</a>

       <li><a href="#the-getresponseheader-method"><span class=secno>3.7.3.
        </span>The <code title="">getResponseHeader()</code> method</a>

       <li><a href="#the-getallresponseheaders-method"><span
        class=secno>3.7.4. </span>The <code
        title="">getAllResponseHeaders()</code> method</a>

       <li><a href="#response-entity-body0"><span class=secno>3.7.5.
        </span>Response Entity Body</a>

       <li><a href="#the-overridemimetype-method"><span class=secno>3.7.6.
        </span>The <code title="">overrideMimeType()</code> method</a>

       <li><a href="#the-responsebody-attribute"><span class=secno>3.7.7.
        </span>The <code title="">responseBody</code> attribute</a>

       <li><a href="#the-responsetext-attribute"><span class=secno>3.7.8.
        </span>The <code title="">responseText</code> attribute</a>

       <li><a href="#the-responsexml-attribute"><span class=secno>3.7.9.
        </span>The <code title="">responseXML</code> attribute</a>
      </ul>

     <li><a href="#events"><span class=secno>3.8. </span>Events summary</a>
    </ul>

   <li><a href="#the-formdata-interface"><span class=secno>4. </span>The
    <code title="">FormData</code> Interface</a>
    <ul class=toc>
     <li><a href="#formdata-constructors"><span class=secno>4.1.
      </span>Constructors</a>

     <li><a href="#the-append-method"><span class=secno>4.2. </span>The <code
      title="">append()</code> method</a>
    </ul>

   <li><a href="#exceptions"><span class=secno>5. </span>Exceptions</a>

   <li class=no-num><a href="#differences">Differences from
    XMLHttpRequest</a>

   <li class=no-num><a href="#references">References</a>

   <li class=no-num><a href="#acknowledgments">Acknowledgments</a>
  </ul>
  <!--end-toc-->

  <h2 id=introduction><span class=secno>1. </span>Introduction</h2>

  <p><em>This section is non-normative.</em>

  <p>The <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object
   implements an interface exposed by a scripting engine that allows scripts
   to perform HTTP client functionality, such as submitting form data or
   loading data from a server. It is the ECMAScript HTTP API.

  <p>The name of the object is <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> for compatibility with
   the Web, though each component of this name is potentially misleading.
   First, the object supports any text based format, including XML. Second,
   it can be used to make requests over both HTTP and HTTPS (some
   implementations support protocols in addition to HTTP and HTTPS, but that
   functionality is not covered by this specification). Finally, it supports
   "requests" in a broad sense of the term as it pertains to HTTP; namely all
   activity involved with HTTP requests or responses for the defined HTTP
   methods.

  <div class=example>
   <p>Some simple code to do something with data from an XML document fetched
    over the network:</p>

   <pre><code>function test(data) {
 // taking care of data
}

function handler() {
 if(this.readyState == 4 &amp;&amp; this.status == 200) {
  // so far so good
  if(this.responseXML != null &amp;&amp; this.responseXML.getElementById('test').firstChild.data)
     // success!
   test(this.responseXML.getElementById('test').firstChild.data);
  else
   test(null);
 } else if (this.readyState == 4 &amp;&amp; this.status != 200) {
  // fetched the wrong page or network error...
  test(null);
 }
}

var client = new XMLHttpRequest();
client.onreadystatechange = handler;
client.open("GET", "unicorn.xml");
client.send();</code></pre>

   <p>If you just want to log a message to the server:</p>

   <pre><code>function log(message) {
 var client = new XMLHttpRequest();
 client.open("POST", "/log");
 client.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
 client.send(message);
}</code></pre>

   <p>Or if you want to check the status of a document on the server:</p>

   <pre><code>function fetchStatus(address) {
 var client = new XMLHttpRequest();
 client.onreadystatechange = function() {
  // in case of network errors this might not give reliable results
  if(this.readyState == 4)
   returnStatus(this.status);
 }
 client.open("HEAD", address);
 client.send();
}</code></pre>
  </div>

  <h2 id=conformance><span class=secno>2. </span>Conformance Criteria</h2>

  <p>Everything in this specification is normative except for diagrams,
   examples, notes and sections marked non-normative.

  <p>The key words <em class=ct>must</em>, <em class=ct>must not</em>, <em
   class=ct>should</em>, <em class=ct>should not</em>, and <em
   class=ct>may</em> in this document are to be interpreted as described in
   RFC 2119. [<cite><a href="#ref-rfc2119">RFC2119</a></cite>]

  <p>This specification defines a single conformance class:

  <dl>
   <dt><dfn id=conforming-user-agent>Conforming user agent</dfn>

   <dd>
    <p>A user agent <em class=ct>must</em> behave as described in this
     specification in order to be considered conformant.</p>

    <p>User agents <em class=ct>may</em> implement algorithms given in this
     specification in any way desired, so long as the end result is
     indistinguishable from the result that would be obtained by the
     specification's algorithms.</p>

    <p class=note>This specification uses both the terms "conforming user
     agent(s)" and "user agent(s)" to refer to this product class.</p>
  </dl>

  <h3 id=dependencies><span class=secno>2.1. </span>Dependencies</h3>

  <p>This specification relies on several underlying specifications.

  <dl>
   <dt>Cross-Origin Resource Sharing

   <dd>
    <p>A <a href="#conforming-user-agent" title="conforming user
     agent">conforming user agent</a> <em class=ct>must</em> support the
     algorithms of the Cross-Origin Resource Sharing specification. [<cite><a
     href="#ref-cors">CORS</a></cite>]

   <dt>DOM

   <dd>
    <p>A <a href="#conforming-user-agent" title="conforming user
     agent">conforming user agent</a> <em class=ct>must</em> support at least
     the subset of the functionality defined in DOM Events and DOM Core that
     this specification relies upon, such as various exceptions and
     <code>EventTarget</code>. [<cite><a
     href="#ref-dom2events">DOM2Events</a></cite>] [<cite><a
     href="#ref-dom3core">DOM3Core</a></cite>]

   <dt>HTML5

   <dd>
    <p>A <a href="#conforming-user-agent">conforming user agent</a> <em
     class=ct>must</em> support at least the subset of the functionality
     defined in HTML5 that this specification relies upon, such as the basics
     of the <code>Window</code> object and serializing a
     <code>Document</code> object. [<cite><a
     href="#ref-html5">HTML5</a></cite>]</p>

    <p class=note>The <a
     href="http://www.w3.org/TR/2006/WD-Window-20060407/">Window Object
     1.0</a> draft is not referenced normatively as it appears to be no
     longer maintained and HTML5 defines the <code>Window</code> object in
     more detail. This specification already depends on HTML5 for other
     reasons so there is not much additional overhead because of this.</p>

   <dt>HTTP

   <dd>
    <p>A <a href="#conforming-user-agent" title="conforming user
     agent">conforming user agent</a> <em class=ct>must</em> support some
     version of the HTTP protocol. Requirements regarding HTTP are made
     throughout the specification. [<cite><a
     href="#rfc-rfc2616">RFC2616</a></cite>]

   <dt>Web IDL

   <dd>
    <p>A <a href="#conforming-user-agent">conforming user agent</a> <em
     class=ct>must</em> also be a conforming implementation of the IDL
     fragments in this specification, as described in the Web IDL
     specification. [<cite><a href="#ref-webidl">WebIDL</a></cite>]

   <dt>XML

   <dd>
    <p>A <a href="#conforming-user-agent" title="conforming user
     agent">conforming user agent</a> <em class=ct>must</em> be a conforming
     XML processor that reports violations of namespace well-formedness.
     [<cite><a href="#ref-xml">XML</a></cite>]
  </dl>

  <h3 id=terminology><span class=secno>2.2. </span>Terminology</h3>

  <p><dfn id=dfn-obtain-unicode>convert a DOMString to a sequence of Unicode
   characters</dfn> is defined by the Web IDL specification. [<cite><a
   href="#ref-webidl">WebIDL</a></cite>]

  <p>The terms and algorithms <dfn
   id=url-fragment><code>&lt;fragment></code></dfn>, <dfn
   id=url-scheme><code>&lt;scheme></code></dfn>, <dfn
   id=document-base-url>document base URL</dfn>, <dfn
   id=document-character-encoding>document's character encoding</dfn>, <dfn
   id=event-handler-attributes-0>event handler attributes</dfn>, <dfn
   id=event-handler-event-type>event handler event type</dfn>, <dfn
   id=fetch>fetch</dfn>, <dfn id=fully-active>fully active</dfn>, <dfn
   id=function><code>Function</code></dfn>, <dfn id=dom-innerhtml
   title=dom-innerHTML><code>innerHTML</code></dfn>, <dfn
   id="multipart/form-data-encoding-algorithm"><code>multipart/form-data</code>
   encoding algorithm</dfn>, <dfn id=origin>origin</dfn>, <dfn
   id=preferred-mime-name>preferred MIME name</dfn>, <dfn
   id=resolve-a-url>resolve a URL</dfn>, <dfn id=same-origin>same
   origin</dfn>, <dfn id=storage-mutex>storage mutex</dfn>, <dfn
   id=task>task</dfn>, <dfn id=task-source>task source</dfn>, <dfn
   id=task-queues>task queues</dfn>, <dfn id=url>URL</dfn>, <dfn
   id=url-character-encoding>URL character encoding</dfn>, <dfn
   id=queue-a-task>queue a task</dfn>, and <dfn id=valid-mime-type>valid MIME
   type</dfn> are defined by the HTML5 specification. [<cite><a
   href="#ref-html5">HTML5</a></cite>]

  <p>The term <dfn id=entity-body>entity body</dfn> is used as described in
   RFC 2616. <dfn id=method-token>Method token</dfn> is used as described in
   section 5.1.1 of RFC 2616. <dfn
   id=field-name><code>field-name</code></dfn> and <dfn
   id=field-value><code>field-value</code></dfn> are used as described in
   section 4.2 of RFC 2616. [<cite><a href="#rfc-rfc2616">RFC2616</a></cite>]

  <p>To <dfn id=deflate-a-domstring-into-a-byte-sequence>deflate a DOMString
   into a byte sequence</dfn> means to create a sequence of bytes such that
   the <var title="">n</var>th byte of the sequence is equal to the low-order
   byte of the <var title="">n</var>th code point in the original DOMString.

  <p>To <dfn id=inflate-a-byte-sequence-into-a-domstring>inflate a byte
   sequence into a DOMString</dfn> means to create a DOMString such that the
   <var title="">n</var>th code point has 0x00 as the high-order byte and the
   <var title="">n</var>th byte of the byte sequence as the low-order byte.

  <p><dfn id=userinfo><code>userinfo</code></dfn> is used as described in
   section 3.2.1 of RFC 3986. [<cite><a
   href="#ref-rfc3986">RFC3986</a></cite>]

  <p>To <dfn id=dispatch-readystatechange-event>dispatch a
   <code>readystatechange</code> event</dfn> means that an event with the
   name <code><a
   href="#event-xhr-readystatechange">readystatechange</a></code>, which does
   not bubble and is not cancelable, and which uses the <code>Event</code>
   interface, is to be dispatched at the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object.

  <p class=XXX>To <dfn id=dispatch-progress-event title="dispatch a progress
   event">dispatch a progress event called <var>e</var></dfn> means&hellip;
   [<cite><a href="#ref-pe">PE</a></cite>]

  <p>The terms <dfn id=cross-origin-request>cross-origin request</dfn> and
   <dfn id=cross-origin-request-status>cross-origin request status </dfn> are
   defined by the Cross-Origin Resource Sharing specification. [<cite><a
   href="#ref-cors">CORS</a></cite>]

  <p>The <dfn id=blob><code>Blob</code></dfn> and <dfn
   id=file><code>File</code></dfn> interfaces are defined by the File API
   specification. [<cite><a href="#ref-fileapi">FileAPI</a></cite>]

  <h3 id=extensibility><span class=secno>2.3. </span>Extensibility</h3>

  <p>User agents, Working Groups, and other interested parties are
   <em>strongly encouraged</em> to discuss extensions on a relevant public
   forum, preferably <a
   href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>. If this is
   for some reason not possible prefix the extension in some way and start
   the prefix with an uppercase letter. E.g. if company Foo wants to add a
   private method <code>bar()</code> it could be named <code>FooBar()</code>
   to prevent clashes with a potential future standardized
   <code>bar()</code>.

  <h2 id=the-xmlhttprequest-interface><span class=secno>3. </span>The <code
   title="">XMLHttpRequest</code> Interface</h2>

  <p>The <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object can
   be used by scripts to programmatically connect to servers via HTTP.

  <pre class=idl>[NoInterfaceObject]
interface <dfn id=xmlhttprequesteventtarget>XMLHttpRequestEventTarget</dfn> : EventTarget {
  // <a href="#event-handler-attributes">event handler attributes</a>
           attribute <a href="#function">Function</a> <a href="#onloadstart">onloadstart</a>;
           attribute <a href="#function">Function</a> <a href="#onprogress">onprogress</a>;
           attribute <a href="#function">Function</a> <a href="#onabort">onabort</a>;
           attribute <a href="#function">Function</a> <a href="#onerror">onerror</a>;
           attribute <a href="#function">Function</a> <a href="#onload">onload</a>;
           attribute <a href="#function">Function</a> <a href="#ontimeout">ontimeout</a>;
           attribute <a href="#function">Function</a> <a href="#onloadend">onloadend</a>;
};

interface <dfn id=xmlhttprequestupload>XMLHttpRequestUpload</dfn> : <a href="#xmlhttprequesteventtarget">XMLHttpRequestEventTarget</a> {
  // for future use
};

[<a href="#dom-xmlhttprequest" title=dom-XMLHttpRequest>Constructor</a>]
interface <dfn id=xmlhttprequest>XMLHttpRequest</dfn> : <a href="#xmlhttprequesteventtarget">XMLHttpRequestEventTarget</a> {
  // <a href="#event-handler-attributes">event handler attributes</a>
           attribute <a href="#function">Function</a> <a href="#onreadystatechange">onreadystatechange</a>;

  // <a href="#states">states</a>
  const unsigned short <a href="#unsent-state" title="UNSENT state">UNSENT</a> = 0;
  const unsigned short <a href="#opened-state" title="OPENED state">OPENED</a> = 1;
  const unsigned short <a href="#headers-received-state" title="HEADERS_RECEIVED state">HEADERS_RECEIVED</a> = 2;
  const unsigned short <a href="#loading-state" title="LOADING state">LOADING</a> = 3;
  const unsigned short <a href="#done-state" title="DONE state">DONE</a> = 4;
  readonly attribute unsigned short <a href="#readystate">readyState</a>;

  // <a href="#request">request</a>
  void <a href="#open">open</a>(DOMString <var>method</var>, DOMString <var title="">url</var>);
  void <a href="#open">open</a>(DOMString <var>method</var>, DOMString <var title="">url</var>, boolean <var>async</var>);
  void <a href="#open">open</a>(DOMString <var>method</var>, DOMString <var title="">url</var>, boolean <var>async</var>, DOMString? <var>user</var>);
  void <a href="#open">open</a>(DOMString <var>method</var>, DOMString <var title="">url</var>, boolean <var>async</var>, DOMString? <var>user</var>, DOMString? <var>password</var>);
  void <a href="#setrequestheader">setRequestHeader</a>(DOMString <var>header</var>, DOMString <var>value</var>);
           attribute unsigned long <a href="#timeout">timeout</a>;
           attribute boolean <a href="#withcredentials">withCredentials</a>;
  readonly attribute <a href="#xmlhttprequestupload">XMLHttpRequestUpload</a> <a href="#upload">upload</a>;
  void <a href="#send">send</a>();
  void <a href="#send">send</a>(<a href="#blob">Blob</a> <var>data</var>);
  void <a href="#send">send</a>(Document <var>data</var>);
  void <a href="#send">send</a>([AllowAny] DOMString? <var>data</var>);
  void <a href="#send">send</a>(<a href="#formdata">FormData</a> <var>data</var>);
  void <a href="#abort">abort</a>();

  // <a href="#response">response</a>
  readonly attribute unsigned short <a href="#status">status</a>;
  readonly attribute DOMString <a href="#statustext">statusText</a>;
  DOMString <a href="#getresponseheader">getResponseHeader</a>(DOMString <var>header</var>);
  DOMString <a href="#getallresponseheaders">getAllResponseHeaders</a>();
  void <a href="#overridemimetype">overrideMimeType</a>(DOMString <var>mime</var>);
  readonly attribute ByteArray <a href="#responsebody">responseBody</a>;
  readonly attribute DOMString <a href="#responsetext">responseText</a>;
  readonly attribute Document <a href="#responsexml">responseXML</a>;
};</pre>
  <!-- XXX domintro boxes; HTML5-style -->

  <h3 id=origin-and-base-url><span class=secno>3.1. </span>Origin and Base
   URL</h3>

  <p>Each <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object
   has an associated <dfn
   id=xmlhttprequest-origin><code>XMLHttpRequest</code> origin</dfn> and an
   <dfn id=xmlhttprequest-base-url><code>XMLHttpRequest</code> base
   URL</dfn>.

  <p>This specification defines their values when the global object is
   represented by the <code>Window</code> object. When the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object is used in other
   contexts their values will have to be defined as appropriate for that
   context. That is considered to be out of scope for this specification.

  <hr>

  <p>In environments where the global object is represented by the
   <code>Window</code> object the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object has an associated
   <dfn id=xmlhttprequest-document><code>XMLHttpRequest</code>
   <code>Document</code></dfn> which is the <code>Document</code> object
   associated with the <code>Window</code> object for which the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> interface object was
   created.

  <p class=note>The <a
   href="#xmlhttprequest-document"><code>XMLHttpRequest</code>
   <code>Document</code></a> is used to determine the <a
   href="#xmlhttprequest-origin"><code>XMLHttpRequest</code> origin</a> and
   <a href="#xmlhttprequest-base-url"><code>XMLHttpRequest</code> base
   URL</a> at a later stage.

  <h3 id=task-sources><span class=secno>3.2. </span>Task Sources</h3>

  <p>The <a href="#task-source">task source</a> used by this specification is
   the <dfn id=xmlhttprequest-task-source><code>XMLHttpRequest</code> task
   source</dfn>.

  <h3 id=constructors><span class=secno>3.3. </span>Constructors</h3>

  <p>When the <dfn id=dom-xmlhttprequest title=dom-XMLHttpRequest><code
   title="">XMLHttpRequest()</code></dfn> constructor is invoked, the user
   agent <em class=ct>must</em> return a new <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object.

  <h3 id=event-handler-attributes><span class=secno>3.4. </span>Event Handler
   Attributes</h3>

  <p>The following are the <a href="#event-handler-attributes-0">event
   handler attributes</a> (and their corresponding <a
   href="#event-handler-event-type" title="event handler event type">event
   handler event types</a>) that <em class=ct>must</em> be supported on
   objects implementing an interface that inherits from <code><a
   href="#xmlhttprequesteventtarget">XMLHttpRequestEventTarget</a></code> as
   DOM attributes:

  <table>
   <thead>
    <tr>
     <th><a href="#event-handler-attributes-0" title="event handler
      attributes">event handler attribute</a>

     <th><a href="#event-handler-event-type">event handler event type</a>

   <tbody>
    <tr>
     <td><dfn id=onloadstart><code>onloadstart</code></dfn>

     <td><code><a href="#event-xhr-loadstart">loadstart</a></code>

    <tr>
     <td><dfn id=onprogress><code>onprogress</code></dfn>

     <td><code><a href="#event-xhr-progress">progress</a></code>

    <tr>
     <td><dfn id=onabort><code>onabort</code></dfn>

     <td><code title=abort-event><a href="#event-xhr-abort">abort</a></code>

    <tr>
     <td><dfn id=onerror><code>onerror</code></dfn>

     <td><code><a href="#event-xhr-error">error</a></code>

    <tr>
     <td><dfn id=onload><code>onload</code></dfn>

     <td><code><a href="#event-xhr-load">load</a></code>

    <tr>
     <td><dfn id=ontimeout><code>ontimeout</code></dfn>

     <td><code title=timeout-event><a
      href="#event-xhr-timeout">timeout</a></code>

    <tr>
     <td><dfn id=onloadend><code>onloadend</code></dfn>

     <td><code><a href="#event-xhr-loadend">loadend</a></code>
  </table>

  <p>The following is the <a href="#event-handler-attributes-0" title="event
   handler attributes">event handler attribute</a> (and its corresponding <a
   href="#event-handler-event-type">event handler event type</a>) that <em
   class=ct>must</em> be supported as DOM attribute solely by the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object:

  <table>
   <thead>
    <tr>
     <th><a href="#event-handler-attributes-0" title="event handler
      attributes">event handler attribute</a>

     <th><a href="#event-handler-event-type">event handler event type</a>

   <tbody>
    <tr>
     <td><dfn id=onreadystatechange><code>onreadystatechange</code></dfn>

     <td><code><a
      href="#event-xhr-readystatechange">readystatechange</a></code>
  </table>

  <h3 id=states><span class=secno>3.5. </span>States</h3>

  <p>The <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object can
   be in several states. The <dfn id=readystate><code>readyState</code></dfn>
   attribute, on getting, <em class=ct>must</em> return the current state,
   which <em class=ct>must</em> be one of the following values:

  <dl>
   <dt><dfn id=unsent-state title="UNSENT state"><code>UNSENT</code></dfn>
    (numeric value 0)

   <dd>
    <p>The object has been constructed.

   <dt><dfn id=opened-state title="OPENED state"><code>OPENED</code></dfn>
    (numeric value 1)

   <dd>
    <p>The <code><a href="#open">open()</a></code> method has been
     successfully invoked. During this state request headers can be set using
     <code><a href="#setrequestheader">setRequestHeader()</a></code> and the
     request can be made using the <code><a href="#send">send()</a></code>
     method.

   <dt><dfn id=headers-received-state title="HEADERS_RECEIVED
    state"><code>HEADERS_RECEIVED</code></dfn> (numeric value 2)

   <dd>
    <p>All redirects (if any) have been followed and all HTTP headers of the
     final response have been received. Several response members of the
     object are now available.

   <dt><dfn id=loading-state title="LOADING state"><code>LOADING</code></dfn>
    (numeric value 3)

   <dd>
    <p>The <a href="#response-entity-body">response entity body</a> is being
     received.

   <dt><dfn id=done-state title="DONE state"><code>DONE</code></dfn> (numeric
    value 4)

   <dd>
    <p>The data transfer has been completed or something went wrong during
     the transfer (e.g. infinite redirects).
  </dl>

  <p>The <a href="#opened-state" title="OPENED state">OPENED</a> state has an
   associated <dfn id=send-flag><code>send()</code> flag</dfn> that indicates
   whether the <code><a href="#send">send()</a></code> method has been
   invoked. It can be either true or false and has an initial value of false.

  <p>The <a href="#done-state" title="DONE state">DONE</a> state has an
   associated <dfn id=error-flag>error flag</dfn> that indicates some type of
   network error or abortion. It can be either true or false and has an
   initial value of false.

  <h3 id=request><span class=secno>3.6. </span>Request</h3>

  <p>The <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object
   holds the following request metadata variables:

  <dl>
   <dt>The <dfn id=asynchronous-flag>asynchronous flag</dfn>

   <dd>A flag that is either true or false that indicates whether the request
    is done asynchronously.

   <dt>The <dfn id=request-method>request method</dfn>

   <dd>The method used in the request.

   <dt>The <dfn id=request-url>request URL</dfn>

   <dd>The <a href="#url">URL</a> used in the request.

   <dt>The <dfn id=request-username>request username</dfn>

   <dd>The username used in the request or null if there is no username.

   <dt>The <dfn id=request-password>request password</dfn>

   <dd>The password used in the request or null if there is no password.

   <dt>The <dfn id=author-request-headers>author request headers</dfn>

   <dd>A list consisting of HTTP header name/value pairs to be used in the
    request.

   <dt>The <dfn id=request-entity-body>request entity body</dfn>

   <dd>The <a href="#entity-body">entity body</a> used in the request.

   <dt>The <dfn id=request-timeout>request timeout</dfn>

   <dd>The amount of milliseconds a request can take before being terminated.
    By default this is 0 and has no observable effect.

   <dt>The <dfn id=credentials-flag>credentials flag</dfn>

   <dd>Indicates whether a cross-origin request will include cookie and HTTP
    authentication data and whether cookies can be set. The flag is either
    true or false. The default value is false.

   <dt>The <dfn id=upload-complete-flag>upload complete flag</dfn>

   <dd>Used to determine whether to send upload progress events. The flag is
    either true or false.

   <dt>The <dfn id=upload-events-flag>upload events flag</dfn>

   <dd>Used to determine whether to send upload progress events for
    cross-origin requests. The flag is either true or false.
  </dl>

  <p>The <code><a href="#xmlhttprequest">XMLHttpRequest</a></code> object
   also has an associated <code><a
   href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

  <h4 id=the-open-method><span class=secno>3.6.1. </span>The <code
   title="">open()</code> method</h4>

  <p>When the <dfn id=open title=open><code>open(<var>method</var>, <var
   title="">url</var>, <var>async</var>, <var>user</var>,
   <var>password</var>)</code></dfn> method is invoked, the user agent <em
   class=ct>must</em> run these steps (unless otherwise indicated):

  <ol>
   <li>
    <p>If the <code><a href="#xmlhttprequest">XMLHttpRequest</a></code>
     object has an associated <a
     href="#xmlhttprequest-document"><code>XMLHttpRequest</code>
     <code>Document</code></a> run these substeps:</p>

    <ol>
     <li>
      <p>If the <a
       href="#xmlhttprequest-document"><code>XMLHttpRequest</code>
       <code>Document</code></a> is not <a href="#fully-active">fully
       active</a> raise an <code>INVALID_STATE_ERR</code> exception and
       terminate the overall set of steps.

     <li>
      <p>Let <a href="#xmlhttprequest-base-url"><code>XMLHttpRequest</code>
       base URL</a> be the <a href="#document-base-url">document base URL</a>
       of the <a href="#xmlhttprequest-document"><code>XMLHttpRequest</code>
       <code>Document</code></a>.

     <li>
      <p>Let <a href="#xmlhttprequest-origin"><code>XMLHttpRequest</code>
       origin</a> be the <a href="#origin">origin</a> of the <a
       href="#xmlhttprequest-document"><code>XMLHttpRequest</code>
       <code>Document</code></a>.
    </ol>

   <li>
    <p>If any code point in <var>method</var> is higher than U+00FF LATIN
     SMALL LETTER Y WITH DIAERESIS or after <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>method</var> it does not
     match the <a href="#method-token">Method token</a> production raise a
     <code>SYNTAX_ERR</code> exception and terminate these steps. Otherwise
     let <var>method</var> be the result of <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>method</var>.
   </li>
   <!-- This sounds lame, but it works. -->

   <li>
    <p>If <var>method</var> is a case-insensitive match for
     <code>CONNECT</code>, <code>DELETE</code>, <code>GET</code>,
     <code>HEAD</code>, <code>OPTIONS</code>, <code>POST</code>,
     <code>PUT</code>, <code>TRACE</code>, or <code>TRACK</code> subtract
     0x20 from each byte in the range 0x61 (ASCII a) to 0x7A (ASCII z).</p>

    <p class=note>If it does not match any of the above, it is passed through
     <em>literally</em>, including in the final request.</p>
   </li>
   <!-- WebKit (and supposedly Gecko) also uppercase: COPY, INDEX, LOCK,
   M-POST, MKCOL, MOVE, PROPFIND, PROPPATCH, and UNLOCK. -->

   <li>
    <p>If <var>method</var> is a case-sensitive match for
     <code>CONNECT</code>, <code>TRACE</code>, or <code>TRACK</code> raise a
     <code><a href="#security-err">SECURITY_ERR</a></code> exception and
     terminate these steps.</p>

    <p class=note>Allowing these methods poses a security risk. [<cite><a
     href="#ref-httpverbsec">HTTPVERBSEC</a></cite>]</p>

   <li>
    <p>Let <var title="">url</var> be a <a href="#url">URL</a>.

   <li>
    <p>Let <a href="#url-character-encoding">URL character encoding</a> of
     <var title="">url</var> be UTF-8.

   <li>
    <p><a href="#resolve-a-url" title="Resolve a URL">Resolve</a> <var
     title="">url</var> relative to the <a
     href="#xmlhttprequest-base-url"><code>XMLHttpRequest</code> base
     URL</a>. If the algorithm returns an error raise a
     <code>SYNTAX_ERR</code> exception and terminate these steps.
   </li>
   <!-- Presto and Gecko override the encoding. WebKit does not. Trident
   does not support non-ASCII URLs. This matters for the <query> component,
   see HTML5. -->

   <li>
    <p>Drop <code><a href="#url-fragment">&lt;fragment></a></code> from <var
     title="">url</var>.

   <li>
    <p>If <var title="">url</var> contains an unsupported <code><a
     href="#url-scheme">&lt;scheme></a></code> raise a
     <code>NOT_SUPPORTED_ERR</code> and terminate these steps.

   <li>
    <p>If the <code>"user:password"</code> format in the <code><a
     href="#userinfo">userinfo</a></code> production is not supported for the
     relevant scheme and <var title="">url</var> contains this format raise a
     <code>SYNTAX_ERR</code> and terminate these steps.

   <li>
    <p>If <var title="">url</var> contains the <code>"user:password"</code>
     format let <var>temp user</var> be the user part and <var>temp
     password</var> be the password part.

   <li>
    <p>If <var title="">url</var> just contains the <code>"user"</code>
     format let <var>temp user</var> be the user part.

   <li class=note>
    <p>The previous level of this specification raised a <code><a
     href="#security-err">SECURITY_ERR</a></code> at this place in case of a
     non <a href="#same-origin">same origin</a> <var>stored url</var>. This
     specification supports non <a href="#same-origin">same origin</a>
     requests and therefore this exception is no longer raised.

   <li>
    <p>Let <var>async</var> be the value of the <var>async</var> argument or
     <code>true</code> if it was omitted.

   <li>
    <p>If the <var>user</var> argument was not omitted follow these sub
     steps:</p>

    <ol>
     <li>
      <p>If the syntax of <var>user</var> does not match the syntax specified
       by the relevant authentication scheme, raise a <code>SYNTAX_ERR</code>
       exception and terminate the overall set of steps.

     <li>
      <p>If <var>user</var> is null let <var>temp user</var> be null.

     <li>
      <p>Otherwise let <var>temp user</var> be <var>user</var>.
    </ol>

    <p class=note>These steps override anything that may have been set by the
     <var title="">url</var> argument.</p>

   <li>
    <p>If the <var>password</var> argument was not omitted follow these sub
     steps:</p>

    <ol>
     <li>
      <p>If the syntax of <var>password</var> does not match the syntax
       specified by the relevant authentication scheme, raise a
       <code>SYNTAX_ERR</code> exception and terminate the overall set of
       steps.

     <li>
      <p>If <var>password</var> is null let <var>temp password</var> be null.

     <li>
      <p>Otherwise let <var>temp password</var> be <var>password</var>.
    </ol>

    <p class=note>These steps override anything that may have been set by the
     <var title="">url</var> argument.</p>

   <li>
    <p><a href="#abort-send-algorithm" title="abort send()">Abort the
     <code>send()</code> algorithm</a>.

   <li>
    <p>The user agent <em class=ct>should</em> cancel any network activity
     for which the object is responsible.
   </li>
   <!-- we can hardly require it... -->

   <li>
    <p>If there are any <a href="#task" title=task>tasks</a> from the
     object's <a
     href="#xmlhttprequest-task-source"><code>XMLHttpRequest</code> task
     source</a> in one of the <a href="#task-queues">task queues</a>, then
     remove those tasks.

   <li>
    <p>Set variables associated with the object as follows:</p>

    <ul>
     <li>
      <p>Set the <a href="#send-flag"><code>send()</code> flag</a> to false.

     <li>
      <p>Set <a href="#response-entity-body">response entity body</a> to
       null.

     <li>
      <p>Empty the list of <a href="#author-request-headers">author request
       headers</a>.</p>

     <li>
      <p>Set the <a href="#request-method">request method</a> to
       <var>method</var>.

     <li>
      <p>Set the <a href="#request-url">request URL</a> to <var
       title="">url</var>.

     <li>
      <p>Set the <a href="#request-username">request username</a> to
       <var>temp user</var>.

     <li>
      <p>Set the <a href="#request-password">request password</a> to
       <var>temp password</var>.

     <li>
      <p>Set the <a href="#asynchronous-flag">asynchronous flag</a> to true
       if <var>async</var> is <code>true</code>. Otherwise set it to false.
    </ul>

   <li>
    <p>Switch the the state to <a href="#opened-state" title="OPENED
     state">OPENED</a>.

   <li>
    <p><a href="#dispatch-readystatechange-event">Dispatch a
     <code>readystatechange</code> event</a>.
  </ol>

  <h4 id=the-setrequestheader-method><span class=secno>3.6.2. </span>The
   <code title="">setRequestHeader()</code> method</h4>
  <!-- XXX domintro authors
  The <code>setRequestHeader()</code> method can be used to set new request
    headers and append to request headers already in the list.</p>
  -->

  <p>As indicated in the algorithm below certain headers cannot be set and
   are left up to the user agent. In addition there are certain other headers
   the user agent will take control of if they are not set by the author as
   indicated at the end of the <code><a href="#send">send()</a></code> method
   section.

  <p class=note>The <code><a
   href="#setrequestheader">setRequestHeader()</a></code> method appends a
   value if the HTTP header given as argument is already part of the <a
   href="#author-request-headers">author request headers</a> list.

  <p class=note>For non <a href="#same-origin">same origin</a> requests using
   the HTTP <code>GET</code> method a preflight request is made when headers
   other than <code>Accept</code> and <code>Accept-Language</code> are set.

  <p>When the <dfn id=setrequestheader
   title=setrequestheader><code>setRequestHeader(<var>header</var>,
   <var>value</var>)</code></dfn> method is invoked, the user agent <em
   class=ct>must</em> run these steps:

  <ol>
   <li>
    <p>If the state is not <a href="#opened-state" title="OPENED
     state">OPENED</a> raise an <code>INVALID_STATE_ERR</code> exception and
     terminate these steps.

   <li>
    <p>If the <a href="#send-flag"><code>send()</code> flag</a> is true raise
     an <code>INVALID_STATE_ERR</code> exception and terminate these steps.

   <li>
    <p>If any code point in <var>header</var> is higher than U+00FF LATIN
     SMALL LETTER Y WITH DIAERESIS or after <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>header</var> it does not
     match the <a href="#field-name">field-name</a> production raise a
     <code>SYNTAX_ERR</code> exception and terminate these steps. Otherwise
     let <var>header</var> be the result of <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>header</var>.
   </li>
   <!-- This sounds lame, but it works. -->

   <li>
    <p>If any code point in <var>value</var> is higher than U+00FF LATIN
     SMALL LETTER Y WITH DIAERESIS or after <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>value</var> it does not
     match the <a href="#field-value">field-value</a> production raise a
     <code>SYNTAX_ERR</code> exception and terminate these steps. Otherwise
     let <var>value</var> be the result of <span title="deflate a DOMString
     into an byte sequence">deflating</span> <var>value</var>.</p>
    <!-- This sounds lame, but it works. -->
    <p class=note>The empty string is legal and represents the empty header
     value.</p>

   <li>
    <p>Terminate these steps if <var>header</var> is a case-insensitive match
     for one of the following headers:</p>

    <ul>
     <li><code>Accept-Charset</code>

     <li><code>Accept-Encoding</code>

     <li><code>Access-Control-Request-Headers</code>

     <li><code>Access-Control-Request-Method</code>

     <li><code>Connection</code>

     <li><code>Content-Length</code>

     <li><code>Cookie</code>

     <li><code>Cookie2</code>

     <li><code>Content-Transfer-Encoding</code>

     <li><code>Date</code>

     <li><code>Expect</code>

     <li><code>Host</code>

     <li><code>Keep-Alive</code>

     <li><code title="">Origin</code>

     <li><code>Referer</code>

     <li><code>TE</code>

     <li><code>Trailer</code>

     <li><code>Transfer-Encoding</code>

     <li><code>Upgrade</code>

     <li><code>User-Agent</code>

     <li><code>Via</code>
    </ul>

    <p>&hellip; or if the start of <var>header</var> is a case-insensitive
     match for <code>Proxy-</code> or <code>Sec-</code> (including when
     <var>header</var> is just <code>Proxy-</code> or <code>Sec-</code>).</p>

    <p class=note>The above headers are not allowed to be set as they are
     better controlled by the user agent as it knows best what value they
     ought to have. Header names starting with <code>Sec-</code> are not
     allowed to be set to allow new headers to be minted in the future that
     are guaranteed not to come from <code><a
     href="#xmlhttprequest">XMLHttpRequest</a></code>. (Older clients would
     however still be vulnerable as they allow such headers to be set.)</p>

   <li>
    <p>If <var>header</var> is not in the <a
     href="#author-request-headers">author request headers</a> list append
     <var>header</var> with its associated <var>value</var> to the list and
     terminate these steps.

   <li>
    <p>If <var>header</var> is in the <a
     href="#author-request-headers">author request headers</a> list either
     use multiple headers, combine the values or use a combination of those
     (section 4.2, RFC 2616). [<cite><a
     href="#rfc-rfc2616">RFC2616</a></cite>]
   </li>
   <!-- XXX it seems UAs always combine the values -->
  </ol>

  <p class=note>See also the <code><a href="#send">send()</a></code> method
   regarding user agent header handling for caching, authentication, proxies,
   and cookies.

  <div class=example>
   <pre><code>// The following script:
var client = new XMLHttpRequest();
client.open('GET', 'demo.cgi');
client.setRequestHeader('X-Test', 'one');
client.setRequestHeader('X-Test', 'two');
client.send();

// ...would result in the following header being sent:
...
X-Test: one, two
...</code></pre>
  </div>

  <h4 id=the-timeout-attribute><span class=secno>3.6.3. </span>The <code
   title="">timeout</code> attribute</h4>

  <p>The <dfn id=timeout><code>timeout</code></dfn> attribute controls the <a
   href="#request-timeout">request timeout</a>.

  <p>On setting the <code><a href="#timeout">timeout</a></code> attribute
   these steps <em class=ct>must</em> be run:

  <ol>
   <li>
    <p>If the state is not <a href="#opened-state" title="OPENED
     state">OPENED</a> raise an <code>INVALID_STATE_ERR</code> exception and
     terminate these steps.

   <li>
    <p>If the <a href="#send-flag"><code>send()</code> flag</a> is true raise
     an <code>INVALID_STATE_ERR</code> exception and terminate these steps.

   <li>
    <p>Set <a href="#request-timeout">request timeout</a> to the given value.
  </ol>

  <p>On getting, the <code><a href="#timeout">timeout</a></code> attribute
   <em class=ct>must</em> return the value of the <a
   href="#request-timeout">request timeout</a>.

  <h4 id=the-withcredentials-attribute><span class=secno>3.6.4. </span>The
   <code title="">withCredentials</code> attribute</h4>

  <p>The <dfn id=withcredentials><code>withCredentials</code></dfn> attribute
   controls the <a href="#credentials-flag">credentials flag</a>.

  <p>On setting the <code><a
   href="#withcredentials">withCredentials</a></code> attribute these steps
   <em class=ct>must</em> be run:

  <ol>
   <li>
    <p>If the state is not <a href="#opened-state" title="OPENED
     state">OPENED</a> raise an <code>INVALID_STATE_ERR</code> exception and
     terminate these steps.

   <li>
    <p>If the <a href="#send-flag"><code>send()</code> flag</a> is true raise
     an <code>INVALID_STATE_ERR</code> exception and terminate these steps.

   <li>
    <p>If the given value is <code>true</code>, set the <a
     href="#credentials-flag">credentials flag</a> to true. Otherwise, set
     the <a href="#credentials-flag">credentials flag</a> to false.
  </ol>

  <p>On getting, the <code><a
   href="#withcredentials">withCredentials</a></code> attribute <em
   class=ct>must</em> return <code>true</code> if the <a
   href="#credentials-flag">credentials flag</a> is true, and
   <code>false</code> if the <a href="#credentials-flag">credentials flag</a>
   is false.

  <h4 id=the-upload-attribute><span class=secno>3.6.5. </span>The <code
   title="">upload</code> attribute</h4>

  <p>The <dfn id=upload><code>upload</code></dfn> attribute, on getting, <em
   class=ct>must</em> return the associated <code><a
   href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

  <h4 id=the-send-method><span class=secno>3.6.6. </span>The <code
   title="">send()</code> method</h4>
  <!-- XXX domintro
  <p>The <code>send()</code> method initiates the request and its optional
  argument provides the <span>request entity body</span>.</p>
  -->

  <p>When the <dfn id=send
   title=send><code>send(<var>data</var>)</code></dfn> method is invoked, the
   user agent <em class=ct>must</em> run the following steps (unless
   otherwise noted). This algorithm gets aborted when the <code><a
   href="#open">open()</a></code> or <code><a
   href="#abort">abort()</a></code> method is invoked. When the <dfn
   id=abort-send-algorithm title="abort send()"><code>send()</code> algorithm
   is aborted</dfn> the user agent <em class=ct>must</em> terminate the
   algorithm after finishing the step it is on.

  <p class=note>The <code title="">send()</code> algorithm can only be
   aborted when the <a href="#asynchronous-flag">asynchronous flag</a> is
   true and only after the method call has returned.

  <ol>
   <li>
    <p>If the state is not <a href="#opened-state" title="OPENED
     state">OPENED</a> raise an <code>INVALID_STATE_ERR</code> exception and
     terminate these steps.

   <li>
    <p>If the <a href="#send-flag"><code>send()</code> flag</a> is true raise
     an <code>INVALID_STATE_ERR</code> exception and terminate these steps.

   <li>
    <p>If the <span>request method is <code>GET</code> or <code>HEAD</code>
     act as if <var>data</var> is null.</span></p>

    <p>If the <var>data</var> argument has been omitted or is null, do not
     include a <a href="#request-entity-body">request entity body</a> and go
     to the next step.</p>

    <p>Otherwise, let <var>encoding</var> be null, <var>mime type</var> be
     null, and then follow these rules:</p>

    <dl class=switch>
     <dt>If <var>data</var> is a <code><a href="#blob">Blob</a></code>

     <dd>
      <p>If the object is of type <code><a href="#file">File</a></code> and
       its <code title=dom-File-mediaType>mediaType</code> attribute is not
       the empty string let <var>mime type</var> be its value.</p>

      <p>Let the <a href="#request-entity-body">request entity body</a> be
       the raw data represented by <var>data</var>.</p>

     <dt>If <var>data</var> is a <code>Document</code>

     <dd>
      <p>Let <var>encoding</var> be the <a
       href="#preferred-mime-name">preferred MIME name</a> of the <a
       href="#document-character-encoding" title="document's character
       encoding">character encoding</a> of <var>data</var>. If
       <var>encoding</var> is UTF-16 change it to UTF-8.</p>

      <p>Let <var>mime type</var> be "<code>application/xml;charset=</code>"
       followed by <var>encoding</var>.</p>

      <p>Let the <a href="#request-entity-body">request entity body</a> be
       the result of getting the <code title=dom-innerHTML><a
       href="#dom-innerhtml">innerHTML</a></code> attribute on
       <var>data</var> <a href="#dfn-obtain-unicode" title="convert a
       DOMString to a sequence of Unicode characters">converted to
       Unicode</a> and encoded as <var>encoding</var>. Re-raise any exception
       this raises.</p>

      <p class=note>In particular, if the document cannot be serialized an
       <code>INVALID_STATE_ERR</code> exception is raised.</p>

      <p class=note>Subsequent changes to the <code>Document</code> have no
       effect on what is submitted.</p>

     <dt>If <var>data</var> is a <code>DOMString</code>

     <dd>
      <p>Let <var>encoding</var> be UTF-8.</p>

      <p>Let <var>mime type</var> be "<code>text/plain;charset=UTF-8</code>".</p>

      <p>Let the <a href="#request-entity-body">request entity body</a> be
       <var>data</var> <a href="#dfn-obtain-unicode" title="convert a
       DOMString to a sequence of Unicode characters">converted to
       Unicode</a> and encoded as UTF-8.</p>

     <dt>If <var>data</var> is a <code><a
      href="#formdata">FormData</a></code>

     <dd>
      <p>Let <var>mime type</var> be "<code>multipart/form-data</code>".</p>

      <p>Let the <a href="#request-entity-body">request entity body</a> be
       the result of running the <a
       href="#multipart/form-data-encoding-algorithm"><code>multipart/form-data</code>
       encoding algorithm</a> with <var>data</var> as <var>form data
       set</var>.</p>
      <!-- XXX sufficient? prolly not -->
    </dl>

    <p>If a <code>Content-Type</code> header is set using <code><a
     href="#setrequestheader">setRequestHeader()</a></code> whose value is a
     <a href="#valid-mime-type">valid MIME type</a> and has a
     <code>charset</code> parameter whose value is not a case-insensitive
     match for <var>encoding</var>, and <var>encoding</var> is not null, set
     all the <code>charset</code> parameters of the <code>Content-Type</code>
     header to <var>encoding</var>.</p>

    <p>If no <code>Content-Type</code> header has been set using <code><a
     href="#setrequestheader">setRequestHeader()</a></code> and <var>mime
     type</var> is not null set a <code>Content-Type</code> request header
     with as value <var>mime type</var>.</p>
    <!-- reminder: if we ever change this to always include charset it has
    to be included as the first parameter for compatibility reasons -->
    

   <li>
    <p>If the <a href="#asynchronous-flag">asynchronous flag</a> is false
     release the <a href="#storage-mutex">storage mutex</a>.

   <li>
    <p>If the <a href="#asynchronous-flag">asynchronous flag</a> is true and
     one or more event listeners are registered on the <code><a
     href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object set
     the <a href="#upload-events-flag">upload events flag</a> to true.
     Otherwise, set the <a href="#upload-events-flag">upload events flag</a>
     to false.

   <li>
    <p>Set the <a href="#error-flag">error flag</a> to false.

   <li>
    <p>Set the <a href="#upload-complete-flag">upload complete flag</a> to
     true if there is no <a href="#request-entity-body">request entity
     body</a> or if the <a href="#request-entity-body">request entity
     body</a> is empty. Otherwise, set the <a
     href="#upload-complete-flag">upload complete flag</a> to false.

   <li>
    <p>If the <a href="#asynchronous-flag">asynchronous flag</a> is true run
     these substeps:</p>

    <ol>
     <li>
      <p>Set the <a href="#send-flag"><code>send()</code> flag</a> to true.

     <li>
      <p><a href="#dispatch-readystatechange-event">Dispatch a
       <code>readystatechange</code> event</a>.</p>

      <p class=note>The state does not change. The event is dispatched for
       historical reasons.</p>

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code><a href="#event-xhr-loadstart">loadstart</a></code>.

     <li>
      <p>If the <a href="#upload-complete-flag">upload complete flag</a> is
       false <a href="#dispatch-progress-event">dispatch a progress event</a>
       called <code><a href="#event-xhr-loadstart">loadstart</a></code> on
       the <code><a
       href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

     <li>
      <p>Return the <code><a href="#send">send()</a></code> method call, but
       continue running the steps in this algorithm.
    </ol>

   <li>
    <dl class=switch>
     <dt>If the <a href="#xmlhttprequest-origin"><code>XMLHttpRequest</code>
      origin</a> and the <a href="#request-url">request URL</a> are <a
      href="#same-origin">same origin</a>

     <dd>
      <p>These are the <dfn id=same-origin-request-steps>same-origin request
       steps</dfn>.</p>

      <p><a href="#fetch">Fetch</a> the <a href="#request-url">request
       URL</a> from <i title="">origin</i> <a
       href="#xmlhttprequest-origin"><code>XMLHttpRequest</code> origin</a>,
       with the <i title="">synchronous flag</i> set if the <a
       href="#asynchronous-flag">asynchronous flag</a> is false, using HTTP
       method <a href="#request-method">request method</a>, user <a
       href="#request-username">request username</a> (if non-null) and
       password <a href="#request-password">request password</a> (if
       non-null), taking into account the <a
       href="#request-entity-body">request entity body</a>, list of <a
       href="#author-request-headers">author request headers</a> and the
       rules listed at the end of this section.</p>

      <dl class=switch>
       <dt>If the <a href="#asynchronous-flag">asynchronous flag</a> is false

       <dd>
        <p>While making the request also follow the <a
         href="#same-origin-request-event-rules">same-origin request event
         rules</a>.</p>
        <!--
         This cannot involve any task queue whatsoever because that would
         mean other tasks on the task queue might get processed as well
         which is counter to the whole idea of doing things synchronous.
        -->
        
        <p class=note>The <code><a href="#send">send()</a></code> method call
         will now be returned by virtue of this algorithm ending.</p>

       <dt>If the <a href="#asynchronous-flag">asynchronous flag</a> is true

       <dd>
        <p><a href="#make-progress-notifications">Make progress
         notifications</a>.</p>

        <p><a href="#make-upload-progress-notifications">Make upload progress
         notifications</a>.</p>

        <p>While processing the request, as data becomes available and when
         the user interferes with the request, <a href="#queue-a-task"
         title="queue a task">queue tasks</a> to update the <a
         href="#response-entity-body">response entity body</a> and follow the
         <a href="#same-origin-request-event-rules">same-origin request event
         rules</a>.</p>
      </dl>

     <dt>Otherwise

     <dd>
      <p>These are the <dfn id=cross-origin-request-steps>cross-origin
       request steps</dfn>.</p>

      <p>Make a <a href="#cross-origin-request">cross-origin request</a>,
       passing these as parameters:</p>

      <dl>
       <dt>request URL

       <dd>The <a href="#request-url">request URL</a>.

       <dt>request method

       <dd>The <a href="#request-method">request method</a>.

       <dt>custom request headers

       <dd>The list of <a href="#author-request-headers">author request
        headers</a>.

       <dt>request entity body

       <dd>The <a href="#request-entity-body">request entity body</a>.

       <dt>source origin

       <dd>The <a href="#xmlhttprequest-origin"><code>XMLHttpRequest</code>
        origin</a>.

       <dt>credentials flag

       <dd>The <a href="#credentials-flag">credentials flag</a>.

       <dt>force preflight flag

       <dd>The <a href="#upload-events-flag">upload events flag</a>.
      </dl>

      <p class=note><a href="#request-username">Request username</a> and <a
       href="#request-password">request password</a> are always ignored as
       part of a <a href="#cross-origin-request">cross-origin request</a>;
       including them would allow a site to perform a distributed password
       search. However, user agents will include credentials in the request
       (if the user has any) as required elsewhere.</p>

      <dl class=switch>
       <dt>If the <a href="#asynchronous-flag">asynchronous flag</a> is false

       <dd>
        <p>While making the request also follow the <a
         href="#cross-origin-request-event-rules">cross-origin request event
         rules</a>.</p>
        <!--
         This cannot involve any task queue whatsoever because that would
         mean other tasks on the task queue might get processed as well
         which is counter to the whole idea of doing things synchronous.
        -->
        
        <p class=note>The <code><a href="#send">send()</a></code> method call
         will now be returned by virtue of this algorithm ending.</p>

       <dt>If the <a href="#asynchronous-flag">asynchronous flag</a> is true

       <dd>
        <p>While processing the request, as data becomes available and when
         the end user interferes with the request, <a href="#queue-a-task"
         title="queue a task">queue tasks</a> to update the <a
         href="#response-entity-body">response entity body</a> and follow the
         <a href="#cross-origin-request-event-rules">cross-origin request
         event rules</a>.</p>
      </dl>
    </dl>
  </ol>

  <hr>

  <p>If the user agent allows the end user to configure a proxy it <em
   class=ct>should</em> modify the request appropriately; i.e., connect to
   the proxy host instead of the origin server, modify the
   <code>Request-Line</code> and send <code>Proxy-Authorization</code>
   headers as specified.

  <hr>

  <p>If the user agent supports HTTP Authentication and <code
   title=http-authorization>Authorization</code> is not in the list of <a
   href="#author-request-headers">author request headers</a>, it <em
   class=ct>should</em> consider requests originating from the <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> object to be part of the
   protection space that includes the accessed URIs and send <code
   title=http-authorization>Authorization</code> headers and handle <code>401
   Unauthorized</code> requests appropriately.

  <p>If authentication fails, <code
   title=http-authorization>Authorization</code> is not in the list of <a
   href="#author-request-headers">author request headers</a>, <a
   href="#request-username">request username</a> is null, and <a
   href="#request-password">request password</a> is null, user agents <em
   class=ct>should</em> prompt the end user for their username and password.

  <p>If authentication fails, <code
   title=http-authorization>Authorization</code> is not in the list of <a
   href="#author-request-headers">author request headers</a>, <a
   href="#request-username">request username</a> is non-null, and <a
   href="#request-password">request password</a> is non-null, user agents <em
   class=ct>must not</em> prompt the end user for their username and
   password. [<cite><a href="#ref-rfc2617">RFC2617</a></cite>]

  <p class=note>End users are not prompted if credentials are provided
   through the <code><a href="#open">open()</a></code> API so that authors
   can implement their own user interface. They are also not prompted for non
   same-origin requests.

  <hr>

  <p>If the user agent supports HTTP State Management it <em
   class=ct>should</em> persist, discard and send cookies (as received in the
   <code>Set-Cookie</code> and <code>Set-Cookie2</code> response headers, and
   sent in the <code>Cookie</code> header) as applicable. [<cite><a
   href="#ref-cookies">COOKIES</a></cite>]

  <hr>

  <p>If the user agent implements a HTTP cache it <em class=ct>should</em>
   respect <code>Cache-Control</code> request headers set by the <code><a
   href="#setrequestheader">setRequestHeader()</a></code> (e.g.,
   <code>Cache-Control: no-cache</code> bypasses the cache). It <em
   class=ct>must not</em> send <code>Cache-Control</code> or
   <code>Pragma</code> request headers automatically unless the end user
   explicitly requests such behavior (e.g. by (force-)reloading the page).

  <p>For <code>304 Not Modified</code> responses that are a result of a user
   agent generated conditional request the user agent <em class=ct>must</em>
   act as if the server gave a <code>200 OK</code> response with the
   appropriate content. The user agent <em class=ct>must</em> allow <code><a
   href="#setrequestheader">setRequestHeader()</a></code> to override
   automatic cache validation by setting request headers (e.g.
   <code>If-None-Match</code> or <code>If-Modified-Since</code>), in which
   case <code>304 Not Modified</code> responses <em class=ct>must</em> be
   passed through. [<cite><a href="#rfc-rfc2616">RFC2616</a></cite>]

  <hr>

  <p>If the user agent implements server-driven content-negotiation it <em
   class=ct>should</em> set <code>Accept-Encoding</code> and
   <code>Accept-Charset</code> headers as appropriate. For
   <code>Accept</code> and <code>Accept-Language</code> the user agent <em
   class=ct>must</em> follow these constraints:

  <ul>
   <li>
    <p>Both headers <em class=ct>must not</em> be modified if they are
     already set through <code><a
     href="#setrequestheader">setRequestHeader()</a></code>.

   <li>
    <p>If not set through <code><a
     href="#setrequestheader">setRequestHeader()</a></code>
     <code>Accept-Language</code> <em class=ct>should</em> be set as
     appropriate.

   <li>
    <p>If not set through <code><a
     href="#setrequestheader">setRequestHeader()</a></code>
     <code>Accept</code> <em class=ct>must</em> be set with as value
     <code>*/*</code>.
  </ul>

  <p>Responses <em class=ct>must</em> have the content-encodings
   automatically decoded. [<cite><a href="#rfc-rfc2616">RFC2616</a></cite>]

  <hr>

  <p>Besides the <a href="#author-request-headers">author request headers</a>
   user agents <em class=ct>should not</em> include additional request
   headers other than those mentioned above or other than those authors are
   not allowed to set using <code><a
   href="#setrequestheader">setRequestHeader()</a></code>. This ensures that
   authors have a reasonably predictable API.

  <h4 id=infrastructure-for-the-send-method><span class=secno>3.6.7.
   </span>Infrastructure for the <code title="">send()</code> method</h4>

  <p>The <dfn id=same-origin-request-event-rules>same-origin request event
   rules</dfn> are as follows:

  <dl class=switch>
   <dt>If the response is an HTTP redirect

   <dd>
    <p>If the redirect violates infinite loop precautions this is a <a
     href="#network-error">network error</a>.</p>

    <p>Otherwise, run these steps:</p>

    <ol>
     <li>
      <p>Set the <a href="#request-url">request URL</a> to the <a
       href="#url">URL</a> conveyed by the <code>Location</code> header.

     <li>
      <p>If the <code><a href="#url-scheme">&lt;scheme></a></code> of <a
       href="#request-url">request URL</a> is not supported this is a <a
       href="#network-error">network error</a>. Terminate the steps for this
       algorithm if that is the case.

     <li>
      <p>If the <a href="#xmlhttprequest-origin"><code>XMLHttpRequest</code>
       origin</a> and the <a href="#origin">origin</a> of <a
       href="#request-url">request URL</a> are <a href="#same-origin">same
       origin</a> transparently follow the redirect while observing the <a
       href="#same-origin-request-event-rules">same-origin request event
       rules</a>.

     <li>
      <p>Otherwise, follow the <a
       href="#cross-origin-request-steps">cross-origin request steps</a> and
       terminate the steps for this algorithm.
    </ol>

    <p class=note>HTTP places requirements on the user agent regarding the
     preservation of the <a href="#request-method">request method</a> and <a
     href="#request-entity-body">request entity body</a> during redirects,
     and also requires end users to be notified of certain kinds of automatic
     redirections.</p>
    <!-- XXX HTTP needs fixing here -->

   <dt>If the end user cancels the download

   <dd>
    <p>This is an <a href="#abort-error">abort error</a>.

   <dt>In case of network errors

   <dd>
    <p>In case of DNS errors, TLS negotiation failure, or other type of
     network errors, this is a <a href="#network-error">network error</a>. Do
     not request any kind of end user interaction.</p>

    <p class=note>This does not include HTTP responses that indicate some
     type of error, such as HTTP status code 410.</p>

   <dt>If <a href="#request-timeout">request timeout</a> is not 0 and since
    the request started the amount of milliseconds specified by <a
    href="#request-timeout">request timeout</a> has passed

   <dd>
    <p>This is a <a href="#timeout-error">timeout error</a>.

   <dt>Once all HTTP headers have been received and the <a
    href="#asynchronous-flag">asynchronous flag</a> is true (and this is not
    an HTTP redirect)

   <dd>
    <p><a href="#switch-headers-received">Switch to the HEADERS_RECEIVED
     state</a>.

   <dt>Once the first byte (or more) of the <a
    href="#response-entity-body">response entity body</a> has been received
    and the <a href="#asynchronous-flag">asynchronous flag</a> is true

   <dt>If there is no <a href="#response-entity-body">response entity
    body</a> and the <a href="#asynchronous-flag">asynchronous flag</a> is
    true

   <dd>
    <p><a href="#switch-loading">Switch to the LOADING state</a>.

   <dt>Once the whole <a href="#response-entity-body">response entity
    body</a> has been received

   <dt>If there is no <a href="#response-entity-body">response entity
    body</a> and the <a href="#asynchronous-flag">asynchronous flag</a> is
    false or the state is <a href="#loading-state" title="LOADING
    state">LOADING</a>

   <dd>
    <p><a href="#switch-done">Switch to the DONE state</a>.
  </dl>

  <hr>

  <p>The <dfn id=cross-origin-request-event-rules>cross-origin request event
   rules</dfn> are as follows:

  <dl class=switch>
   <dt>If the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i>preflight complete</i>

   <dd>
    <p><a href="#make-upload-progress-notifications">Make upload progress
     notifications</a>.

   <dt>If the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i title="">network error</i>

   <dd>
    <p>This is a <a href="#network-error">network error</a>.

   <dt>If the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i title="">abort error</i>

   <dd>
    <p>This is an <a href="#abort-error">abort error</a>.

   <dt>If <a href="#request-timeout">request timeout</a> is not 0 and since
    the request started the amount of milliseconds specified by <a
    href="#request-timeout">request timeout</a> has passed

   <dd>
    <p>This is a <a href="#timeout-error">timeout error</a>.

   <dt>Once all HTTP headers have been received, the <a
    href="#cross-origin-request-status">cross-origin request status</a> is
    <i>success</i>, and the <a href="#asynchronous-flag">asynchronous
    flag</a> is true

   <dd>
    <p><a href="#switch-headers-received">Switch to the HEADERS_RECEIVED
     state</a>.</p>

    <p><a href="#make-progress-notifications">Make progress
     notifications</a>.</p>

   <dt>Once the first byte (or more) of the <a
    href="#response-entity-body">response entity body</a> has been received,
    the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i>success</i>, and the <a
    href="#asynchronous-flag">asynchronous flag</a> is true

   <dt>If there is no <a href="#response-entity-body">response entity
    body</a>, the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i>success</i>, and the <a
    href="#asynchronous-flag">asynchronous flag</a> is true

   <dd>
    <p><a href="#switch-loading">Switch to the LOADING state</a>.

   <dt>Once the whole <a href="#response-entity-body">response entity
    body</a> has been received and the <a
    href="#cross-origin-request-status">cross-origin request status</a> is
    <i>success</i>

   <dt>If there is no <a href="#response-entity-body">response entity
    body</a>, the <a href="#cross-origin-request-status">cross-origin request
    status</a> is <i>success</i>, and the <a
    href="#asynchronous-flag">asynchronous flag</a> is false or the state is
    <a href="#loading-state" title="LOADING state">LOADING</a>

   <dd>
    <p><a href="#switch-done">Switch to the DONE state</a>.
  </dl>

  <hr>

  <p>When something is said to be a <dfn id=network-error>network error</dfn>
   run the <a href="#request-error">request error</a> steps for exception
   <code><a href="#network-err">NETWORK_ERR</a></code> and event <code><a
   href="#event-xhr-error">error</a></code>.

  <p>When something is said to be an <dfn id=abort-error>abort error</dfn>
   run the <a href="#request-error">request error</a> steps for exception
   <code><a href="#abort-err">ABORT_ERR</a></code> and event <code
   title=abort-event><a href="#event-xhr-abort">abort</a></code>.

  <p>When something is said to be an <dfn id=timeout-error>timeout
   error</dfn> run the <a href="#request-error">request error</a> steps for
   exception <code><a href="#timeout-err">TIMEOUT_ERR</a></code> and event
   <code title=timeout-event><a href="#event-xhr-timeout">timeout</a></code>.

  <p>When something is said to be a <dfn id=request-error>request error</dfn>
   for exception <var>exception</var> and event <var>event</var> run these
   steps:

  <ol>
   <li>
    <p>The user agent <em class=ct>should</em> cancel any network activity
     for which the object is responsible.

   <li>
    <p>If there are any <a href="#task" title=task>tasks</a> from the
     object's <a
     href="#xmlhttprequest-task-source"><code>XMLHttpRequest</code> task
     source</a> in one of the <a href="#task-queues">task queues</a>, then
     remove those tasks.

   <li>
    <p>Set the <a href="#response-entity-body">response entity body</a> to
     null.

   <li>
    <p>Empty the list of <a href="#author-request-headers">author request
     headers</a>.

   <li>
    <p>Set the the <a href="#error-flag">error flag</a> to true.

   <li>
    <p>Switch the state to <a href="#done-state" title="DONE state">DONE</a>.

   <li>
    <p>If the <a href="#asynchronous-flag">asynchronous flag</a> is false
     raise an <var>exception</var> exception and terminate the overall set of
     steps.

   <li>
    <p><a href="#dispatch-readystatechange-event">Dispatch a
     <code>readystatechange</code> event</a>.</p>

    <p class=note>At this point it is clear that the <a
     href="#asynchronous-flag">asynchronous flag</a> is true.</p>

   <li>
    <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
     called <var>event</var>.

   <li>
    <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
     called <code><a href="#event-xhr-loadend">loadend</a></code>.

   <li>
    <p>If the <a href="#upload-complete-flag">upload complete flag</a> is
     false, follow these substeps:</p>

    <ol>
     <li>
      <p>Set the <a href="#upload-complete-flag">upload complete flag</a> to
       true.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <var>event</var> on the <code><a
       href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code><a href="#event-xhr-loadend">loadend</a></code> on the
       <code><a href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code>
       object.
    </ol>

   <li>
    <p>Terminate the overall algorithm.
  </ol>

  <hr>

  <p>When it is said to <dfn id=switch-headers-received>switch to the
   HEADERS_RECEIVED state</dfn> run these steps:

  <ol>
   <li>
    <p>Switch the state to <a href="#headers-received-state"
     title="HEADERS_RECEIVED state">HEADERS_RECEIVED</a>.

   <li>
    <p><a href="#dispatch-readystatechange-event">Dispatch a
     <code>readystatechange</code> event</a>.
  </ol>

  <p>When it is said to <dfn id=switch-loading>switch to the LOADING
   state</dfn> run these steps:

  <ol>
   <li>
    <p>Switch the state to <a href="#loading-state" title="LOADING
     state">LOADING</a>.

   <li>
    <p><a href="#dispatch-readystatechange-event">Dispatch a
     <code>readystatechange</code> event</a>.
  </ol>

  <p>When it is said to <dfn id=switch-done>switch to the DONE state</dfn>
   run these steps:

  <ol>
   <li>
    <p>If the <a href="#asynchronous-flag">asynchronous flag</a> is false
     update the <a href="#response-entity-body">response entity body</a>.

   <li>
    <p>Switch the state to <a href="#done-state" title="DONE state">DONE</a>.

   <li>
    <p><a href="#dispatch-readystatechange-event">Dispatch a
     <code>readystatechange</code> event</a>.

   <li>
    <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
     called <code><a href="#event-xhr-load">load</a></code>.

   <li>
    <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
     called <code><a href="#event-xhr-loadend">loadend</a></code>.
  </ol>

  <hr>

  <p>When it is said to <dfn id=make-progress-notifications>make progress
   notifications</dfn>, while the download is progressing, <a
   href="#queue-a-task">queue a task</a> to <a
   href="#dispatch-progress-event">dispatch a progress event</a> called
   <code><a href="#event-xhr-progress">progress</a></code> about every 50ms
   or for every byte received, whichever is <em>least</em> frequent.

  <hr>

  <p>When it is said to <dfn id=make-upload-progress-notifications>make
   upload progress notifications</dfn> run these steps:

  <ul>
   <li>
    <p>While the request entity body is being uploaded and the <a
     href="#upload-complete-flag">upload complete flag</a> is false, <a
     href="#queue-a-task">queue a task</a> to <a
     href="#dispatch-progress-event">dispatch a progress event</a> called
     <code><a href="#event-xhr-progress">progress</a></code> at the <code><a
     href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object
     about every 50ms or for every byte transmitted, whichever is
     <em>least</em> frequent.

   <li>
    <p>If the <a href="#request-entity-body">request entity body</a> has been
     successfully uploaded and the <a href="#upload-complete-flag">upload
     complete flag</a> is still false, <a href="#queue-a-task">queue a
     task</a> to run these substeps:</p>

    <ol>
     <li>
      <p>Set the <a href="#upload-complete-flag">upload complete flag</a> to
       true.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code><a href="#event-xhr-load">load</a></code> at the <code><a
       href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code><a href="#event-xhr-loadend">loadend</a></code> at the
       <code><a href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code>
       object.
    </ol>
  </ul>
  <!-- XXX successfully uploaded? -->

  <h4 id=the-abort-method><span class=secno>3.6.8. </span>The <code
   title="">abort()</code> method</h4>

  <p>When the <dfn id=abort><code>abort()</code></dfn> method is invoked, the
   user agent <em class=ct>must</em> run these steps (unless otherwise
   noted):

  <ol>
   <li>
    <p><a href="#abort-send-algorithm" title="abort send()">Abort the
     <code>send()</code> algorithm</a>.

   <li>
    <p>The user agent <em class=ct>should</em> cancel any network activity
     for which the object is responsible.

   <li>
    <p>If there are any <a href="#task" title=task>tasks</a> from the
     object's <a
     href="#xmlhttprequest-task-source"><code>XMLHttpRequest</code> task
     source</a> in one of the <a href="#task-queues">task queues</a>, then
     remove those tasks.

   <li>
    <p>Set the <a href="#response-entity-body">response entity body</a> to
     null.

   <li>
    <p>Empty the list of <a href="#author-request-headers">author request
     headers</a>.

   <li>
    <p>Set the <a href="#error-flag">error flag</a> to true.

   <li>
    <p>If the state is <a href="#unsent-state" title="UNSENT
     state">UNSENT</a>, <a href="#opened-state" title="OPENED
     state">OPENED</a> with the <a href="#send-flag"><code>send()</code>
     flag</a> being false, or <a href="#done-state" title="DONE
     state">DONE</a> go to the next step.</p>

    <p>Otherwise run these substeps:</p>

    <ol>
     <li>
      <p>Switch the state to <a href="#done-state" title="DONE
       state">DONE</a>.

     <li>
      <p>Set the <a href="#send-flag"><code>send()</code> flag</a> to false.

     <li>
      <p><a href="#dispatch-readystatechange-event">Dispatch a
       <code>readystatechange</code> event</a>.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code title=abort-event><a
       href="#event-xhr-abort">abort</a></code>.

     <li>
      <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
       called <code><a href="#event-xhr-loadend">loadend</a></code>.

     <li>
      <p>If the <a href="#upload-complete-flag">upload complete flag</a> is
       false run these substeps:</p>

      <ol>
       <li>
        <p>Set the <a href="#upload-complete-flag">upload complete flag</a>
         to true.

       <li>
        <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
         called <code title=abort-event><a
         href="#event-xhr-abort">abort</a></code> on the <code><a
         href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.

       <li>
        <p><a href="#dispatch-progress-event">Dispatch a progress event</a>
         called <code><a href="#event-xhr-loadend">loadend</a></code> on the
         <code><a
         href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object.
      </ol>
    </ol>

   <li>
    <p>Switch the state to <a href="#unsent-state" title="UNSENT
     state">UNSENT</a>.</p>

    <p class=note>No <code><a
     href="#event-xhr-readystatechange">readystatechange</a></code> event is
     dispatched.</p>
  </ol>

  <h3 id=response><span class=secno>3.7. </span>Response</h3>

  <h4 id=the-status-attribute><span class=secno>3.7.1. </span>The <code
   title="">status</code> attribute</h4>

  <p>The <dfn id=status><code>status</code></dfn> attribute <em
   class=ct>must</em> return the result of running these steps:

  <ol>
   <li>
    <p>If the state is <a href="#unsent-state" title="UNSENT
     state">UNSENT</a> or <a href="#opened-state" title="OPENED
     state">OPENED</a> return 0 and terminate these steps.

   <li>
    <p>If the <a href="#error-flag">error flag</a> is true return 0 and
     terminate these steps.

   <li>
    <p>Return the HTTP status code.
  </ol>

  <h4 id=the-statustext-attribute><span class=secno>3.7.2. </span>The <code
   title="">statusText</code> attribute</h4>

  <p>The <dfn id=statustext><code>statusText</code></dfn> attribute <em
   class=ct>must</em> return the result of running these steps:

  <ol>
   <li>
    <p>If the state is <a href="#unsent-state" title="UNSENT
     state">UNSENT</a> or <a href="#opened-state" title="OPENED
     state">OPENED</a> return the empty string and terminate these steps.

   <li>
    <p>If the <a href="#error-flag">error flag</a> is true return the empty
     string and terminate these steps.

   <li>
    <p>Return the HTTP status text.
  </ol>

  <h4 id=the-getresponseheader-method><span class=secno>3.7.3. </span>The
   <code title="">getResponseHeader()</code> method</h4>

  <p>When the <dfn id=getresponseheader
   title=getresponseheader><code>getResponseHeader(<var>header</var>)</code></dfn>
   is invoked, the user agent <em class=ct>must</em> run these steps:

  <ol>
   <li>
    <p>If the state is <a href="#unsent-state" title="UNSENT
     state">UNSENT</a> or <a href="#opened-state" title="OPENED
     state">OPENED</a> return null and terminate these steps.

   <li>
    <p>If the <a href="#error-flag">error flag</a> is true return null and
     terminate these steps.

   <li>
    <p>If any code point in <var>header</var> is higher than U+00FF LATIN
     SMALL LETTER Y WITH DIAERESIS return null and terminate these steps.

   <li>
    <p>Let <var>header</var> be the result of <span title="deflate a
     DOMString into an byte sequence">deflating</span> <var>header</var>.
   </li>
   <!-- This sounds lame, but it works. -->

   <li>
    <p>If <var>header</var> is a case-insensitive match for
     <code>Set-Cookie</code> or <code>Set-Cookie2</code> return null and
     terminate these steps.

   <li>
    <p>If <var>header</var> is a case-insensitive match for multiple HTTP
     response headers, return the <span title="inflate an byte sequence into
     a DOMString">inflated</span> values of these headers as a single
     concatenated string separated from each other by a U+002C COMMA U+0020
     SPACE character pair and terminate these steps.

   <li>
    <p>If <var>header</var> is a case-insensitive match for a single HTTP
     response header, return the <span title="inflate an byte sequence into a
     DOMString">inflated</span> value of that header and terminate these
     steps.

   <li>
    <p>Return null.
  </ol>

  <p class=note>The Cross-Origin Resource Sharing specification filters the
   headers that are exposed by <code><a
   href="#getresponseheader">getResponseHeader()</a></code> for non
   <span>same-origin</span> requests. [<cite><a
   href="#ref-cors">CORS</a></cite>]

  <div class=example>
   <p>For the following script:</p>

   <pre><code>var client = new XMLHttpRequest();
client.open("GET", "unicorns-are-teh-awesome.txt", true);
client.send();
client.onreadystatechange = function() {
  if(this.readyState == 2) {
    print(client.getResponseHeader("Content-Type"));
  }
}</code></pre>

   <p>The <code>print()</code> function will get to process something like:</p>

   <pre><code>text/plain; charset=UTF-8</code></pre>
  </div>

  <h4 id=the-getallresponseheaders-method><span class=secno>3.7.4. </span>The
   <code title="">getAllResponseHeaders()</code> method</h4>

  <p>When the <dfn
   id=getallresponseheaders><code>getAllResponseHeaders()</code></dfn> method
   is invoked, the user agent <em class=ct>must</em> run the following steps:

  <ol>
   <li>
    <p>If the state is <a href="#unsent-state" title="UNSENT
     state">UNSENT</a> or <a href="#opened-state" title="OPENED
     state">OPENED</a> return the empty string and terminate these steps.

   <li>
    <p>If the <a href="#error-flag">error flag</a> is true return the empty
     string and terminate these steps.

   <li>
    <p>Return all the HTTP headers, excluding headers that are a
     case-insensitive match for <code>Set-Cookie</code> or
     <code>Set-Cookie2</code>, <span title="inflate an byte sequence into a
     DOMString">inflated</span>, as a single string, with each header line
     separated by a U+000D CR U+000A LF pair, excluding the status line, and
     with each header name and header value separated by a U+003A COLON
     U+0020 SPACE pair.
  </ol>

  <p class=note>The Cross-Origin Resource Sharing specification filters the
   headers that are exposed by <code><a
   href="#getallresponseheaders">getAllResponseHeaders()</a></code> for non
   <span>same-origin</span> requests. [<cite><a
   href="#ref-cors">CORS</a></cite>]

  <div class=example>
   <p>For the following script:</p>

   <pre><code>var client = new XMLHttpRequest();
client.open("GET", "narwhals-too.txt", true);
client.send();
client.onreadystatechange = function() {
 if(this.readyState == 2) {
  print(this.getAllResponseHeaders());
 }
}</code></pre>

   <p>The <code>print()</code> function will get to process something like:</p>

   <pre><code>Date: Sun, 24 Oct 2004 04:58:38 GMT
Server: Apache/1.3.31 (Unix)
Keep-Alive: timeout=15, max=99
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: text/plain; charset=utf-8</code></pre>
  </div>

  <h4 id=response-entity-body0><span class=secno>3.7.5. </span>Response
   Entity Body</h4>

  <p>The <dfn id=response-mime-type>response MIME type</dfn> is the MIME type
   the <code>Content-Type</code> header contains without any parameters or
   null if the header could not be parsed properly or was omitted. The <dfn
   id=override-mime-type>override MIME type</dfn> is initially null and can
   get a value if <code><a
   href="#overridemimetype">overrideMimeType()</a></code> is invoked. <dfn
   id=final-mime-type>Final MIME type</dfn> is the override MIME type unless
   that is null in which case it is the response MIME type.

  <p>The <dfn id=response-charset>response charset</dfn> is the value of the
   <code>charset</code> parameter of the <code>Content-Type</code> header or
   null if there was no <code>charset</code> parameter or if the header could
   not be parsed properly or was omitted. The <dfn
   id=override-charset>override charset</dfn> is initially null and can get a
   value if <code title="">overrideMimeType()</code> is invoked. <dfn
   id=final-charset>Final charset</dfn> is the override charset unless that
   is null in which case it is the response charset.

  <hr>

  <p>The <dfn id=response-entity-body>response entity body</dfn> is the
   fragment of the <a href="#entity-body">entity body</a> of the response
   received so far (<a href="#loading-state" title="LOADING
   state">LOADING</a>) or the complete entity body of the response (<a
   href="#done-state" title="DONE state">DONE</a>). If the response does not
   have an entity body the response entity body is null.

  <p class=note>The <a href="#response-entity-body">response entity body</a>
   is updated as part of the <code><a href="#send">send()</a></code>
   algorithm.

  <hr>

  <p>The <dfn id=text-response-entity-body>text response entity body</dfn> is
   a <code>DOMString</code> representing the <a
   href="#response-entity-body">response entity body</a>. The text response
   entity body is the return value of the following algorithm:

  <ol>
   <li>
    <p>If the response entity body is null return the empty string and
     terminate these steps.</p>

   <li>
    <p>Let <var>charset</var> be the <a href="#final-charset">final
     charset</a>.

   <li>
    <p>Let <var>mime</var> be the <a href="#final-mime-type">final MIME
     type</a>.

   <li>
    <p>If <var>charset</var> is null and <var>mime</var> is null,
     <code>text/xml</code>, <code>application/xml</code> or ends in <code
     title="">+xml</code> use the rules set forth in the XML specifications
     to determine the character encoding. Let <var>charset</var> be the
     determined character encoding.

   <li>
    <p>If <var>charset</var> is null and <var>mime</var> is
     <code>text/html</code> follow the rules set forth in the HTML
     specification to determine the character encoding. Let
     <var>charset</var> be the determined character encoding. [<cite><a
     href="#ref-html5">HTML5</a></cite>]

   <li>
    <p>If <var>charset</var> is null then, for each of the rows in the
     following table, starting with the first one and going down, if the
     first bytes of <var>bytes</var> match the bytes given in the first
     column, then let <var>charset</var> be the encoding given in the cell in
     the second column of that row. If there is no match <var>charset</var>
     remains null.</p>

    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal

       <th>Description

     <tbody>
      <tr>
       <td>FE FF

       <td>UTF-16BE BOM

      <tr>
       <td>FF FE

       <td>UTF-16LE BOM

      <tr>
       <td>EF BB BF

       <td>UTF-8 BOM
    </table>

   <li>
    <p>If <var>charset</var> is null let <var>charset</var> be UTF-8.

   <li>
    <p>Return the result of decoding the response entity body using
     <var>charset</var>. Replace bytes or sequences of bytes that are not
     valid accordng to the <var>charset</var> with a single U+FFFD
     REPLACEMENT CHARACTER character.
  </ol>

  <p class=note>Authors are strongly encouraged to encode their resources
   using UTF-8.

  <hr>

  <p>The <dfn id=document-response-entity-body>document response entity
   body</dfn> is either a <code>Document</code> representing the <a
   href="#response-entity-body">response entity body</a> or null. The
   document response entity body is the return value of the following
   algorithm:

  <ol>
   <li>
    <p>If the <a href="#response-entity-body">response entity body</a> is
     null terminate these steps and return null.

   <li>
    <p>If <a href="#final-mime-type">final MIME type</a> is not null,
     <code>text/html</code>, <code>text/xml</code>,
     <code>application/xml</code>, and does not end in <code
     title="">+xml</code> terminate these steps and return null.

   <li>
    <p>If <a href="#final-mime-type">final MIME type</a> is
     <code>text/html</code> let <var>document</var> be an object implementing
     the <code>Document</code> interface that represents the <a
     href="#response-entity-body">response entity body</a> parsed following
     the rules set forth in the HTML specification for an HTML parser with
     scripting disabled and then terminate this algorithm. [<cite><a
     href="#ref-html5">HTML5</a></cite>]</p>

   <li>
    <p>Otherwise, let <var>document</var> be an object implementing the
     <code>Document</code> interface that represents the result of parsing
     the response entity body into a document tree following the rules from
     the XML specifications. If this fails (unsupported character encoding,
     namespace well-formedness error et cetera) terminate these steps return
     null. [<cite><a href="#ref-xml">XML</a></cite>]</p>

    <p class=note>Scripts in the resulting document tree will not be
     executed, resources referenced will not be loaded and no associated XSLT
     will be applied.</p>

   <li>
    <p>Ensure that the <code>cookie</code> attribute on <var>document</var>
     returns the empty string if the <span>same origin flag</span> is false.

   <li>
    <p>Return <var>document</var>.
  </ol>

  <h4 id=the-overridemimetype-method><span class=secno>3.7.6. </span>The
   <code title="">overrideMimeType()</code> method</h4>

  <p>When the <dfn id=overridemimetype
   title=overridemimetype><code>overrideMimeType(<var>mime</var>)</code></dfn>
   method is invoked, the user agent <em class=ct>must</em> run the following
   steps:

  <ol>
   <li>
    <p>If parsing <var>mime</var> analogously to the value of the
     <code>Content-Type</code> headers fails raise a <code>SYNTAX_ERR</code>
     exception and abort this algorithm.

   <li>
    <p>If a MIME type (without any parameters) is successfully parsed set <a
     href="#override-mime-type">override MIME type</a> to that MIME type.

   <li>
    <p>If a <code>charset</code> parameter is successfully parsed set <a
     href="#override-charset">override charset</a> to its value.
  </ol>

  <h4 id=the-responsebody-attribute><span class=secno>3.7.7. </span>The <code
   title="">responseBody</code> attribute</h4>

  <p class=XXX>Waiting for ECMAScript.

  <p>The <dfn id=responsebody><code>responseBody</code></dfn> attribute <em
   class=ct>must</em> return the result of running these steps:

  <ol>
   <li>
    <p>If the state is not <a href="#loading-state" title="LOADING
     state">LOADING</a> or <a href="#done-state" title="DONE state">DONE</a>
     return null and terminate these steps.

   <li>
    <p>Return a <code>ByteArray</code> object representing the <a
     href="#response-entity-body">response entity body</a> or return null if
     the response entity body is null.
  </ol>

  <h4 id=the-responsetext-attribute><span class=secno>3.7.8. </span>The <code
   title="">responseText</code> attribute</h4>

  <p>The <dfn id=responsetext><code>responseText</code></dfn> attribute <em
   class=ct>must</em> return the result of running these steps:

  <ol>
   <li>
    <p>If the state is not <a href="#loading-state" title="LOADING
     state">LOADING</a> or <a href="#done-state" title="DONE state">DONE</a>
     return the empty string and terminate these steps.

   <li>
    <p>Return the <a href="#text-response-entity-body">text response entity
     body</a>.
  </ol>

  <h4 id=the-responsexml-attribute><span class=secno>3.7.9. </span>The <code
   title="">responseXML</code> attribute</h4>

  <p>The <dfn id=responsexml><code>responseXML</code></dfn> attribute <em
   class=ct>must</em> return the result of running these steps:

  <ol>
   <li>
    <p>If the state is not <a href="#done-state" title="DONE state">DONE</a>
     return null and terminate these steps.

   <li>
    <p>Return the <a href="#document-response-entity-body">document response
     entity body</a>.
  </ol>

  <p class=note>The <code><a href="#responsexml">responseXML</a></code>
   attribute has XML in its name for historical reasons. It also returns
   documents created using an HTML parser.

  <h3 id=events><span class=secno>3.8. </span>Events summary</h3>

  <p>The following events are dispatched on <code><a
   href="#xmlhttprequest">XMLHttpRequest</a></code> and/or <code><a
   href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> objects:

  <table>
   <thead>
    <tr>
     <th>Event name

     <th>Interface

     <th>Dispatched when&hellip;

   <tbody>
    <tr>
     <td><dfn
      id=event-xhr-readystatechange><code>readystatechange</code></dfn>

     <td><code>Event</code>

     <td>The <code><a href="#readystate">readyState</a></code> attribute
      changes at some seemingly arbitrary times for historical reasons.

    <tr>
     <td><dfn id=event-xhr-loadstart><code>loadstart</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the request starts.

    <tr>
     <td><dfn id=event-xhr-progress><code>progress</code></dfn>

     <td><code>ProgressEvent</code>

     <td>While loading and sending data.

    <tr>
     <td><dfn id=event-xhr-abort title=abort-event><code>abort</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the request has been aborted. For instance, by invoking the
      <code><a href="#abort">abort()</a></code> method.

    <tr>
     <td><dfn id=event-xhr-error><code>error</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the request has failed.

    <tr>
     <td><dfn id=event-xhr-load><code>load</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the request has successfully completed.

    <tr>
     <td><dfn id=event-xhr-timeout
      title=timeout-event><code>timeout</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the author specified timeout has passed before the request
      could complete.

    <tr>
     <td><dfn id=event-xhr-loadend><code>loadend</code></dfn>

     <td><code>ProgressEvent</code>

     <td>When the request has completed (either in success or failure).
  </table>

  <h2 id=the-formdata-interface><span class=secno>4. </span>The <code
   title="">FormData</code> Interface</h2>

  <p>The <code><a href="#formdata">FormData</a></code> object represents an
   ordered collection of entries. Each entry has a name and value.

  <pre class=idl>[<a href="#dom-formdata" title=dom-FormData>Constructor</a>]
interface <dfn id=formdata>FormData</dfn> {
  void <a href="#dom-formdata-append" title=dom-formdata-append>append</a>(DOMString <var>name</var>, <a href="#blob">Blob</a> <var>value</var>);
  void <a href="#dom-formdata-append" title=dom-formdata-append>append</a>(DOMString <var>name</var>, DOMString <var>value</var>);
};</pre>
  <!--XXX should we deal with File explicitly here? -->

  <h3 id=formdata-constructors><span class=secno>4.1. </span>Constructors</h3>

  <p>When the <dfn id=dom-formdata
   title=dom-FormData><code>FormData()</code></dfn> constructor is invoked a
   new <code><a href="#formdata">FormData</a></code> object <em
   class=ct>must</em> be returned.

  <h3 id=the-append-method><span class=secno>4.2. </span>The <code
   title="">append()</code> method</h3>

  <p>When the <dfn id=dom-formdata-append
   title=dom-formdata-append><code>append(<var>name</var>,
   <var>value</var>)</code></dfn> method is invoked, the user agent <em
   class=ct>must</em> create a new entry with its name set to <var>name</var>
   and its value set to <var>value</var> and add it to the end of the
   collection the <code><a href="#formdata">FormData</a></code> object
   represents.

  <h2 id=exceptions><span class=secno>5. </span>Exceptions</h2>

  <p>Several algorithms in this specification may result in an exception
   being thrown. These exceptions are all part of the group
   <code>ExceptionCode</code> and use the <code>DOMException</code> object,
   which is defined in DOM Level 3 Core. In addition this specification
   extends the <code>ExceptionCode</code> group with several new constants as
   indicated below. [<cite><a href="#ref-dom3core">DOM3Core</a></cite>]

  <p class=note>Thus, exceptions used by this specification and not defined
   in this section are defined by DOM Level 3 Core.

  <pre
   class=idl>const unsigned short <a href="#security-err">SECURITY_ERR</a> = 18;
const unsigned short <a href="#network-err">NETWORK_ERR</a> = 19;
const unsigned short <a href="#abort-err">ABORT_ERR</a> = 20;
const unsigned short <a href="#timeout-err">TIMEOUT_ERR</a> = 23;</pre>

  <p>The <dfn id=security-err><code>SECURITY_ERR</code></dfn> exception is
   raised if an attempt is made to perform an operation or access some data
   in a way that would be a security risk or a violation of the user agent's
   security policy.</p>
  <!-- http://lists.w3.org/Archives/Public/public-webapi/2006May/0027.html -->

  <p>The <dfn id=network-err><code>NETWORK_ERR</code></dfn> exception is
   raised when a network error occurs in synchronous requests.

  <p>The <dfn id=abort-err><code>ABORT_ERR</code></dfn> exception is raised
   when the user aborts a request in synchronous requests.

  <p>The <dfn id=timeout-err><code>TIMEOUT_ERR</code></dfn> exception is
   raised when the author specified timeout has passed before the request
   could complete in synchronous requests.

  <p class=note>These exceptions will be folded into an update of DOM Level 3
   Core in due course, as they are appropriate for other API specifications
   as well.

  <h2 class=no-num id=differences>Differences from XMLHttpRequest</h2>

  <p>XMLHttpRequest Level 2 adds the following new features:

  <ul>
   <li>
    <p>The ability to make cross-origin requests.

   <li>
    <p>The ability to register for progress events. Both for downloads (put
     listeners on the <code><a
     href="#xmlhttprequest">XMLHttpRequest</a></code> object itself) and
     uploads (put listeners on the <code><a
     href="#xmlhttprequestupload">XMLHttpRequestUpload</a></code> object,
     returned by the <code><a href="#upload">upload</a></code> attribute).

   <li>
    <p>The ability to override the media type and character encoding of the
     response through the <code><a
     href="#overridemimetype">overrideMimeType()</a></code> method.

   <li>
    <p>The ability to transfer <code><a href="#blob">Blob</a></code>,
     <code><a href="#file">File</a></code>, and <code><a
     href="#formdata">FormData</a></code> objects.

   <li>
    <p class=XXX>byte streams
  </ul>

  <h2 class=no-num id=references>References</h2>

  <p>Unless marked "Non-normative" these references are normative.

  <dl>
   <dt>[<dfn id=ref-cookies>COOKIES</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc2109">HTTP State Management
    Mechanism</a></cite>, D. Kristol, L. Montulli, editors. IETF, February
    1997.

   <dd><cite><a href="http://ietf.org/rfc/rfc2965">HTTP State Management
    Mechanism</a></cite>, D. Kristol, L. Montulli, editors. IETF, October
    2000.</dd>
   <!-- XXX These specs do not match reality. Also, the latter obsoletes the
   former -->

   <dt>[<dfn id=ref-cors>CORS</dfn>]

   <dd><cite><a
    href="http://dev.w3.org/2006/waf/access-control/">Cross-Origin Resource
    Sharing</a></cite> (work in progress), A. van Kesteren, editor. W3C,
    2009.

   <dt>[<dfn id=ref-dom2events>DOM2Events</dfn>]

   <dd><cite><a href="http://www.w3.org/TR/DOM-Level-2-Events/">Document
    Object Model (DOM) Level 2 Events Specification</a></cite>, T. Pixley,
    editor. W3C, November 2000.

   <dt>[<dfn id=ref-dom3core>DOM3Core</dfn>]

   <dd><cite><a href="http://www.w3.org/TR/DOM-Level-3-Core">Document Object
    Model (DOM) Level 3 Core Specification</a></cite>, A. Le Hors, P. Le
    H&eacute;garet, L. Wood, G. Nicol, J. Robie, M. Champion, S. Byrne,
    editors. W3C, April 2004.

   <dt>[<dfn id=ref-ecmascript>ECMAScript</dfn>]

   <dd><cite><a
    href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ECMAScript
    Language Specification</a></cite>, Third Edition. ECMA, December 1999.

   <dt>[<dfn id=ref-fileapi>FileAPI</dfn>]

   <dd><cite><a href="http://dev.w3.org/2006/webapi/FileAPI/">File
    API</a></cite> (work in progress), A. Ranganathan, editor. W3C, 2010.

   <dt>[<dfn id=ref-html5>HTML5</dfn>]

   <dd><cite><a href="http://www.w3.org/html/wg/html5/">HTML5</a></cite>
    (work in progress), I. Hickson, D. Hyatt, editors. W3C, 2010.

   <dd><cite><a
    href="http://www.whatwg.org/specs/html5/current-work/">HTML5</a></cite>
    (work in progress), I. Hickson, editor. WHATWG, 2010.

   <dt>[<dfn id=ref-httpverbsec>HTTPVERBSEC</dfn>]

   <dd>(Non-normative) <cite><a
    href="http://www.kb.cert.org/vuls/id/867593">Multiple vendors' web
    servers enable HTTP TRACE method by default</a></cite>, US-CERT.

   <dd>(Non-normative) <cite><a
    href="http://www.kb.cert.org/vuls/id/288308">Microsoft Internet
    Information Server (IIS) vulnerable to cross-site scripting via HTTP
    TRACK method</a></cite>, US-CERT.

   <dd>(Non-normative) <cite><a
    href="http://www.kb.cert.org/vuls/id/150227">HTTP proxy default
    configurations allow arbitrary TCP connections</a></cite>, US-CERT.

   <dt>[<dfn id=ref-pe>PE</dfn>]

   <dd><cite><a href="http://www.w3.org/TR/progress-events/">Progress Events
    1.0</a></cite> (work in progress), C. McCathieNeville, editor. W3C, 2010.

   <dt>[<dfn id=ref-rfc2046>RFC2046</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc2046">Multipurpose Internet Mail
    Extensions (MIME) Part Two: Media Types</a></cite>, N. Freed, N.
    Borenstein, editors. IETF, November 1996.

   <dt>[<dfn id=ref-rfc2119>RFC2119</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc2119">Key words for use in RFCs
    to Indicate Requirement Levels</a></cite>, S. Bradner. IETF, March 1997.

   <dt>[<dfn id=rfc-rfc2616>RFC2616</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc2616">Hypertext Transfer
    Protocol -- HTTP/1.1</a></cite>, R. Fielding, J. Gettys, J. Mogul, H.
    Frystyk, L. Masinter, P. Leach, T. Berners-Lee, editors. IETF, June 1999.

   <dt>[<dfn id=ref-rfc2617>RFC2617</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc2617">HTTP Authentication: Basic
    and Digest Access Authentication</a></cite>, P. Hallam-Baker, J.
    Hostetler, S. Lawrence, P. Leach, A. Luotonen, L. Stewart, editors. IETF,
    June 1999.

   <dt>[<dfn id=ref-rfc3986>RFC3986</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc3986">Uniform Resource
    Identifier (URI): Generic Syntax</a></cite>, T. Berners-Lee, R. Fielding,
    L. Masinter, editors. IETF, January 2005.

   <dt>[<dfn id=ref-rfc3987>RFC3987</dfn>]

   <dd><cite><a href="http://ietf.org/rfc/rfc3987">Internationalized Resource
    Identifiers (IRIs)</a></cite>, M. Duerst, M. Suignard, editors. IETF,
    January 2005. L. Masinter, editors. IETF, January 2005.

   <dt>[<dfn id=ref-webidl>WebIDL</dfn>]

   <dd><cite><a href="http://dev.w3.org/2006/webapi/WebIDL/">Web
    IDL</a></cite> (work in progress), C. McCormack, editor. W3C, 2010.</dd>
   <!-- XXX add Sam -->

   <dt>[<dfn id=ref-xml>XML</dfn>]

   <dd><cite><a href="http://www.w3.org/TR/xml/">Extensible Markup Language
    (XML) 1.0 (Fifth Edition)</a></cite>, T. Bray, J. Paoli, C.
    Sperberg-McQueen, E. Maler, F. Yergeau, editors. W3C, November 2008.

   <dd><cite><a href="http://www.w3.org/TR/xml-names/">Namespaces in XML
    (Third Edition)</a></cite>, T. Bray, D. Hollander, A. Layman, R. Tobin,
    H. S. Thompson, editors. W3C, December 2009.
  </dl>

  <h2 class=no-num id=acknowledgments>Acknowledgments</h2>

  <p>The editor would like to thank Addison Phillips, Ahmed Kamel, Alex
   Hopmann, Alex Vincent, Alexey Proskuryakov, Asbj&oslash;rn Ulsberg, Boris
   Zbarsky, Bj&ouml;rn H&ouml;hrmann, Cameron McCormack, Christophe Jolif,
   Charles McCathieNevile, Dan Winship, David Andersson, David
   H&aring;s&auml;ther, David Levin, Dean Jackson, Denis Sureau, Doug
   Schepers, Douglas Livingstone, Elliotte Harold, Eric Lawrence, Erik
   Dahlstr&ouml;m, Geoffrey Sneddon, Gideon Cohn, Gorm Haug Eriksen,
   H&aring;kon Wium Lie, Hallvord R. M. Steen, Huub Schaeks, Ian Davis, Ian
   Hickson, Ivan Herman, Jeff Walden, Jens Lindstr&ouml;m, Jim Deegan, Jim
   Ley, Joe Farro, Jonas Sicking, Julian Reschke, Karl Dubost, Lachlan Hunt,
   Maciej Stachowiak, Magnus Kristiansen, Marc Hadley, Marcos Caceres, Mark
   Baker, Mark Birbeck, Mark Nottingham, Martin Hassman, Mohamed Zergaoui,
   Olli Pettay, Pawel Glowacki, Peter Michaux, Robin Berjon, Rune Halvorsen,
   Ruud Steltenpool, Simon Pieters, Stewart Brodie, Sunava Dutta, Thomas
   Roessler, Tom Magliery, and Zhenbin Xu for their contributions to this
   specification.

  <p>Special thanks to the Microsoft employees who first implemented the
   <code title="">XMLHttpRequest</code> interface, which was first widely
   deployed by the Windows Internet Explorer browser.

  <p>Special thanks also to the WHATWG for drafting an initial version of
   this specification in their Web Applications 1.0 document (now renamed to
   HTML5). [<cite><a href="#ref-html5">HTML5</a></cite>]

  <p>Thanks also to all those who have helped to improve this specification
   by sending suggestions and corrections. (Please, keep bugging us with your
   issues!)
